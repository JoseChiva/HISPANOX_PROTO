#<AdxTL>@(#)1.0.0.0 $Revision$
#@ Check diff -CPO-16/12/13
#########################################################################
# FUNDEB                                                                #
#    MODELISATION E-COMMERCE                                            #
#                                                                       #
# ACTION TRTDEB : Traitement pièces pour génération table DEB           #
#                                                                       #
#########################################################################

Local Char PARAM(10)(1..3) , VALEUR(250)
Call TRAITE_CHAR(VALEUR,PARAM,"","FUNDEB","DDEB",3,"") From GTRAITE
End

#########################################################################
# Etiquettes ACTION                                                     #
#########################################################################
$ACTION
#--- Actions liées au traitement standard
Case ACTION
 When "OUVRE_BATCH"  : Gosub INIT
 When "INIT"         : Gosub INIT
 When "INIT_DIA"     : Gosub INIT_DIA
 When "CONTROLE"     : Gosub CONTROLE
 When "EXEC"         : Gosub EXEC
 When "TERMINE"      : Gosub TERMINE
 # Action de sélection GACTION
 When "SEL_TABLE"    : Gosub SEL_TABLE
 When "VERF_TABLE"   : Gosub VERF_TABLE
 When Default
Endcase

Return
#######################################################################
#    Détail des actions liées au traitement standard                  #
#######################################################################
$INIT
#--- En batch , il vaut mieux mettre onerrgo
If GSERVEUR
  Onerrgo ERRBATCH
Endif

#--CPO 71937 Lors du nouveau dév multi-lég : nombre d'instructions trop important
Gosub INIT From FUNDEBA

Return
#######################################################################
$INIT_DIA
#--CPO 97978 Lors de la correction de cette fiche : nombre d'instructions trop important
Gosub INIT_DIA From FUNDEBA

Return
#######################################################################
$CONTROLE
#--CPO 97978 Lors de la correction de cette fiche : nombre d'instructions trop important
Gosub CONTROLE From FUNDEBA

Return
#######################################################################
$EXEC
#--CPO 97978 Lors de la correction de cette fiche : nombre d'instructions trop important
#--déplacement des déclarations dans FUNDEBA

Gosub EXEC_DECLA From FUNDEBA

#--CPO 105661 Lors de la correction de cette fiche : nombre d'instructions trop important
#--déplacement des déclarations dans FUNDEBA
Gosub EXEC_ALL From FUNDEBA
##------------

Return
#######################################################################
$TERMINE
If !GSERVEUR
  Call FERME_TRACE From LECFIC
  TRA=1
Endif

Return
#######################################################################
# Achats : Réceptions fournisseurs
#----------------------------------------------------------------------
$EEC_PTH

WUPDFIL="PTH" : WFLO=1
WUPDTYP=11    :# Introduction Achats - utilisé dans les points d'entrée (conformité versions antérieures)

Call ECR_TRACE(string$(70,"-"),0) From GESECRAN
Call ECR_TRACE(mess(626,197,1),0) From GESECRAN
Call ECR_TRACE(string$(70,"-"),0) From GESECRAN

CRITERE  = '[F:PTH]RCPDAT<=[M]DEBDAT'            : # Date reception < ou = a selection
CRITERE += ' & [F:PTH]CPY=[M]CPY'

If [M]REG=2
  CRITERE += '& ([F:PTH]EECNUMDEB=[M]EECNUMDEB | [F:PTH]EECNUMDEB=0)'
Else
  CRITERE += '& [F:PTH]EECNUMDEB=0'
Endif

Gosub ALIFILSUP

# Pour avoir le bon ordre dans les pièces lues, la clé utilisée est le PTH3
For [PTH]PTH3 Where (evalue(CRITERE) & evalue(FILSUP))
  # Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
  Raz WVCRNUMVALO
  Raz WVCRLINVALO
  #--- Contrôle si la pièce doit être prise en compte pour la DEB
  Gosub CTL_EEC
  If WOK=0 : Goto NEXT_PTH : Endif
  [L]W_ISEMPTY_EEC_SCH_NAT = 0 #--CPO DM 105661 Ajout de la sous-traitance
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacement du test valeurs vides EECSCH et EECNAT après le parcours des lignes
  #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
#  If [F:PTH]EECSCH="" and [F:PTH]EECNAT=""
#    If [M]PRNULREGNA=2
#      Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-mess(746,197,1),0) From GESECRAN
#    Endif
#    Goto NEXT_PTH
#  Endif
  If [F:PTH]EECSCH="" and [F:PTH]EECNAT=""
    #--Si, après parcours des lignes, le flag est toujours à 1, on passe à la pièce suivante
    [L]W_ISEMPTY_EEC_SCH_NAT = 1
  Endif
  #--/

  #--- Prise en compte du paramètre permettant de retarder la déclaration des
  #--- réceptions facturables mais non facturées complétement
  #--- Si non soldée (le flag est=3 "Facturé totalement" si la réception est soldée, quelque soit la facturation)
  If [F:PTH]INVFLG <> 3
   # FQ 52820 - sauf inter-sites
   If ([F:PTH]BETFCY<>2 or [F:PTH]BETCPY=2)
    If [F:PTH]RCPDAT>[M]DEBDAT-GEECEXTDELA
      #--CPO 74679 Amélioration de la trace
      WMESS_CODE=2 : WMESS_TRACE=mess(735,197,1)-[F:PTH]PTHNUM : Gosub MESS_TRACE
      #--CPO
      Goto NEXT_PTH
    Endif
   Endif
  Endif
  # Afin de retrouver les bons numéros en cas de rollback
  WOLDLININT = WNOLININT
  WOLDLINEXP = WNOLINEXP
  Call DEBTRANS From GLOCK
  Trbegin [DEB]
  #--- Elements de facturation
  #Les éléments de facturation sont présents sur les pieds des pièces autres que les factures
  #Prise en compte des éléments non répartis sur les lignes : INVLINFLG = 1 ou 6,
  #a condition qu'ils entrent dans le calcul de la valeur fiscale et/ou valeur statistique : CLCDEB = 2 ou 3
  #puis répartition sur les lignes, au prorata des montants de chaque ligne
  WNUMEROPIECE = [F:PTH]PTHNUM
  W_VCRTYP=6 # Issue 110289 - 2015-08-12 by CPO : Invoicing elements when using same counter on different documents
  Gosub ACH_TOTDTA
  WINVDTAAMT   = WTOTDTA
  WINVDTAAMTVS = WTOTDTAVS
  Raz WNUMEROPIECE
  Raz W_VCRTYP # Issue 110289 - 2015-08-12 by CPO
  #---Type de mouvement
  WMVT = 8                                           :# Réception classique
  #--- Réception de sous-traitance                   :# Réception de sous-traitance
  #--- une même réception peut avoir des lignes de sous-traitance et des lignes normales
  #--- ayant des Régimes et/ou Natures différents
  #--- Solution implémentée : Régime de réception classique et changement
  #---                        au régime récept. ss-trait. lors du ttt d'extraction de la DEB
  If [F:PTH]BETFCY = 2 : WMVT=10 : Endif             :# Réception inter-sites
  If [F:PTH]BETCPY = 2 : WMVT=11 : Endif             :# Réception inter-sociétés
  #--- Prise en compte des éléments de l'entête de pièce, puis de chaque ligne de détail
  Gosub EEC_UN_PTH
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacement du test valeurs vides EECSCH et EECNAT après le parcours des lignes
  #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
  If [L]W_ISEMPTY_EEC_SCH_NAT = 1
    #--Si, après parcours des lignes, le flag est toujours à 1, on passe à la pièce suivante
    #--Il passe à 0 si au moins une ligne permets d'alimenter les régimes/natures spéciaux
      If [M]PRNULREGNA=2
        Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-mess(746,197,1),0) From GESECRAN
      Endif
      WOK=0
  Endif
  #--/
  If WOK=0 : Gosub AB_DEB : Goto NEXT_PTH : Endif
  #--- Ecriture des éléments du masque DEBGEN dans le fichier DEB
  Gosub EEC_DEBGEN
  If WOK=0 : Gosub AB_DEB : Goto NEXT_PTH : Endif
  #--- MAJ champ EECNUMDEB si l'écriture dans le fichier DEB a réussi
  #--- Uniquement si au moins une ligne a été renseignée dans le masque de génération
  If [M:DEBG]NBDEB > 0
    W_NUMPIECE = [F:PTH]PTHNUM
    If W_NUMPIECE <> ""
      #--- Maj no traitement dans la pièce de réception
      Update [PTH] Where PTHNUM = W_NUMPIECE With EECNUMDEB = [M]EECNUMDEB
      If fstat
        Call FSTA("PTH") From GLOCK
        Gosub AB_DEB
        Goto NEXT_PTH
      Endif
      Raz W_NUMPIECE
    Endif
  Else
    #--- si aucune ligne extraite
    Gosub AB_DEB
    Goto  NEXT_PTH
  Endif

  Call ECR_TRACE(mess(626,197,1)-[F:PTH]PTHNUM-mess(741,197,1),0) From GESECRAN

  Commit
$NEXT_PTH
Next

Return
#----------------------------------------------------------------------
$EEC_UN_PTH
WOK    = 1    :# mettre à 0 pour ne pas prendre en compte la pièce
WOKLIG = 1    :# mettre à 0 pour ne pas prendre en compte une ligne de détail
#--- Chargement du masque DEBGEN
nolign=0

For [PTD]Where PTHNUM=[F:PTH]PTHNUM
    WOKLIG=1
    W_CHANGED_MVT=0 :#--CPO DM 105661 Ajout de la sous-traitance
    #--CPO 106690 Cas de deux lignes de type "divers", n'ayant pas d'article et qui se suivent
    If [F:PTD]ITMREF="" :  Goto NEXT_EEC_UN_PTH : Endif
    #--/
    #--- Si l'article n'est pas "Soumis à la DEB", on saute la ligne de détail
    If [F:ITM]ITMREF <> [F:PTD]ITMREF
      Read [F:ITM]ITM0=[F:PTD]ITMREF
      If fstat : Raz [F:ITM] : Goto NEXT_EEC_UN_PTH : Endif
    Endif
    #--- Si l'article n'est pas "Soumis à la DEB", on saute la ligne de détail
    If [F:ITM]EECGES <> 2
      #--CPO 74679 Amélioration de la trace
      WMESS_CODE=3 : WMESS_TRACE=mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN)-[F:ITM]ITMREF : Gosub MESS_TRACE
      #--CPO
      Goto NEXT_EEC_UN_PTH
    Endif
    #---FQ 52926
    #---on extrait uniquement les lignes de type "Nomenclature composé"
    #---et celles "Standard"
    If find([F:PTD]LINTYP,3,4)>0
      #--CPO 74679 Amélioration de la trace
      WMESS_CODE=4 : WMESS_TRACE=mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN) : Gosub MESS_TRACE
      #--CPO
      Goto NEXT_EEC_UN_PTH
    Endif

    #FQ 56398 (suite de 51074) - Point d'entrée pour gérer des contrôles à la ligne
    Local Integer SAUVGPE     : SAUVGPE=GPE : GPE=0
    #La variable GPE permet d'accepter ou de refuser la ligne
    # 0 -> la ligne est acceptée
    # 1 -> la ligne est refusée, on passe à la suivante
    GPOINT="DEBCTLLIG" : Gosub ENTREE From EXEFNC
    If GPE : GPE=SAUVGPE : Goto NEXT_EEC_UN_PTH : Endif
    #FQ 56398

    #--CPO DM 105661 Ajout de la sous-traitance
    #--C'est mieux de faire l'init de WMVT en dehors du test sur W_MTTHTLIN
    #---Type de mouvement
    WMVT = 8                                           :# Réception classique
    #--- Réception de sous-traitance                   :# Réception de sous-traitance
    #--- une même réception peut avoir des lignes de sous-traitance et des lignes normales
    #--- ayant des Régimes et/ou Natures différents
    #--- Solution implémentée : Régime de réception classique et changement
    #---                        au régime récept. ss-trait. lors du ttt d'extraction de la DEB
    If [F:PTH]BETFCY = 2 : WMVT=10 : Endif             :# Réception inter-sites
    If [F:PTH]BETCPY = 2 : WMVT=11 : Endif             :# Réception inter-sociétés
    If [F:PTD]LINTYP = 2 : WMVT=9  : Endif             :# Réception produit fini de sous-traitance
    If [F:PTD]LINCAT = 2 : WMVT=20 : Endif             :# Réception matières pour sous-traitance
    #--/
    #--- Cas de la Réception de Sous-Traitance => Régime positionné à la valeur du flux de la table des regimes et nat. par mvt.
    #--Un seul appel à FLUX_REGNAT
#    If [F:PTD]LINTYP=2
#      WMVT= 9 :# "Réception produit fini de Sous-Traitance"
#      Raz WTROUVE
#      Raz WVALSTO
#      Call FLUX_REGNAT(9,[F:PTH]PRHFCY,W_CRYTO,[M:DEBG]EECSCH(nolign-1),[M:DEBG]EECNAT(nolign-1),WVALSTO,WTROUVE) From FUNDEBA
#      If WTROUVE
#        Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-num$([F:PTD]PTDLIN),0) From GESECRAN
#        # "Réception de sous-traitance : le Régime CEE et/ou la Nature ont été modifiés"
#        Call ECR_TRACE(mess(738,197,1),0) From GESECRAN
#      Endif
#    Endif
    #--- Cas des lignes de gratuits ou de sous-traitance
    #--- Il faut rechercher le régime et la nature de ce mouvement, en tenant compte de la législation de la société

    Raz WEECNAT,WEECSCH
    Raz WVALSTO,WTROUVE
    If find(WMVT,9,20)>0
      Call FLUX_REGNAT(WMVT,[F:PTH]PRHFCY,W_CRYTO,WEECSCH,WEECNAT,WVALSTO,WTROUVE) From FUNDEBA
      If WTROUVE=1 and (WEECSCH<>"" or WEECNAT<>"")
        Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-num$([F:PTD]PTDLIN),0) From GESECRAN
        Case WMVT
          When 9 :  # "Réception de sous-traitance : le Régime CEE et/ou la Nature ont été modifiés"
                    Call ECR_TRACE(mess(738,197,1),0) From GESECRAN
          When 20 : # "Réception pour sous-traitance : le Régime CEE et/ou la Nature ont été modifiés"
                    Call ECR_TRACE(mess(20,2236,1)-":"-mess(752,197,1),0) From GESECRAN
        Endcase
        W_CHANGED_MVT=1
      Else
        # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG and error if setup non found/inactive
        Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-num$([F:PTD]PTDLIN),0) From GESECRAN
        Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(909,197,1)-"/"+mess(910,197,1)-mess(911,197,1),1) From GESECRAN
        Goto NEXT_EEC_UN_PTH
        # End issue X3-131291
      Endif


    Endif
    #--/

    nolign +=1
    #--- Chargement du masque avec les éléments de la ligne
    Gosub DEBG_PTH
    If WOK = 0    : Break : Endif                              :# la pièce n'est pas prise en compte
    If WOKLIG = 0 : nolign -= 1 : Goto NEXT_EEC_UN_PTH : Endif :# le détail n'est pas pris en compte, on passe au prochain

    #---FQ 52759 - Prise en compte des factures complémentaires
    #---fait avant la prise en compte des factures si réception facturée
    #---car on peut avoir une/pls factures cpl sur la réception
    #---sont pour autant que cette dernière soit flaguée comme étant facturée
    #---dans ce cas le mtt de cette/ces facture(s) viennent s'ajouter à la valeur statistique de la ligne de réception
    If [F:PTD]INVQTYSTU = 0
      If GEECVALOCPL=2
        #--CPO DM 105661 Ajout de la sous-traitance
        #Gosub DEBG_DTA_PTHCPL From FUNDEBA
        If WMVT<>9
          Gosub DEBG_DTA_PTHCPL From FUNDEBA
        Else
          Gosub DEBG_DTA_PTHCPL_SST From FUNDEBB
        Endif
        #--/
        If WTRNOK : WOK = 0 : Break : Endif
      Endif
    Endif

    #--- Si le détail est facturé, alors nous prenons en compte les éléments de la facture pour le calcul de la valeur fiscale et/ou stat
    #--- seulement dans le cas où il y a différence avec ce qui a été calculé depuis la ligne de réception
    #--- Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
    Raz WNOLINVALO
    If [F:PTD]LININVFLG = 2 and [F:PTD]INVQTYSTU <> 0                         : # si ligne réception facturée
      #--CPO DM 105661 Ajout de la sous-traitance
      If WMVT=9
        Gosub DEBG_DTA_PTH_SST From FUNDEBB
        If WTRNOK=1 or WOK=0 : Break : Endif
      Else
      #--/
        #--- Valorisation avec les lignes facturées
        #--- Factures origine Réception
        Raz WFACDTAAMT, WFACDTAAMTVS, WFISAMTDTA, WSTAAMTDTA, W_NUM, WPASVALO, WMAJ, WTRNOK, WTROUVE
        Raz WRCPINVQTY, WORDINVQTY
        Raz WSAVFISAMTDTA, WSAVSTAAMTDTA
        For [PID]PID1 Where (TYPORI=2 & NUMORI=[F:PTD]PTHNUM & LINORI=[F:PTD]PTDLIN) & INVTYP = 1
          If ([M]REG=1 & [F:PID]LINEECFLG <> 2) | [M]REG=2
            If [F:PIH]NUM <> [F:PID]NUM
              Read [PIH]PIH0 = [F:PID]NUM
              If fstat : WPASVALO = 1 : Raz [F:PIH] : Break : Endif
              # Uniquement les factures validées
              # si une des factures n'est pas validée, il ne faut pas valoriser, car les montants peuvent changer
              If [F:PIH]STA <> 3 : WPASVALO = 1 : Break : Endif
            Else
              If [F:PIH]STA <> 3 : WPASVALO = 1 : Break : Endif
            Endif
            #---Prise en compte des éléments de facturation
            Gosub DEBG_DTA_PTH
            If WPASVALO : Break : Endif
            WRCPINVQTY += [F:PID]QTYPUU
          Else
            # Si pas de regénération et qu'une des lignes a déjà été prise en compte, il ne faut pas valoriser
            WPASVALO = 1 : Break
          Endif
        Next
        #--- Il faut calculer la quantité restant à facturer suite à la valo des factures sur réception
        #--- qté restant à facturer = qté facturée totale de la réception - qté des factures de réception
        WINVQTY = [F:PTD]INVQTYPUU - WRCPINVQTY
        #--- s'il reste des quantités à facturer par rapport au total facturé de la ligne de réception
        #--- nous devons les chercher sur les factures de la commande d'origine de la ligne de réception
        WSAVFISAMTDTA = WFISAMTDTA : Raz WFISAMTDTA
        WSAVSTAAMTDTA = WSTAAMTDTA : Raz WSTAAMTDTA
        If WINVQTY > 0
            #--- Factures origine Commande (pour les Réceptions de commandes)
            If (WPASVALO=0) and ([F:PTD]POHNUM <> '' and [F:PTD]POPLIN <> 0)
                If [F:POQ]POHNUM<>[F:PTD]POHNUM or [F:POQ]POPLIN<>[F:PTD]POPLIN
                    Read [POQ]POQ0=[F:PTD]POHNUM;[F:PTD]POPLIN;[F:PTD]POQSEQ
                    If fstat : Raz [F:POQ] : WPASVALO = 1 : Endif
                Endif
                If WPASVALO=0
                  If [F:POQ]LINCLEFLG=2 and [F:POQ]LININVFLG=2
                    #--- ATTENTION : la commande est considérée facturée aussi si est complétement soldée par la réception
                    #--- ET si cette(ces) réception(s) ont été totalement facturée(s) !!!!
                    #--- => il faut éviter de proratiser plus loins le mtt valorisé par rapport à la quantité de la cde !!!!
                    #--- Uniquement si la ligne de commande est soldée par la réception et est facturée
                    For [PID]PID1 Where (TYPORI=1 & NUMORI=[F:PTD]POHNUM & LINORI=[F:PTD]POPLIN) & INVTYP = 1
                      If ([M]REG=1 & [F:PID]LINEECFLG <> 2) | [M]REG=2
                        If [F:PIH]NUM <> [F:PID]NUM
                          Read [PIH]PIH0 = [F:PID]NUM
                          If fstat : WPASVALO = 1 : Raz [F:PIH] : Break : Endif
                          #--- Uniquement les factures validées
                          # si une des factures n'est pas validée, il ne faut pas valoriser, car les montants peuvent changer
                          If [F:PIH]STA <> 3 : WPASVALO = 1 : Break : Endif
                        Else
                          If [F:PIH]STA <> 3 : WPASVALO = 1 : Break : Endif
                        Endif
                        #--- Prise en compte des éléments de facturation
                        Gosub DEBG_DTA_PTH
                        If WPASVALO : Break : Endif
                        WTROUVE = 1
                        WORDINVQTY += [F:PID]QTYPUU
                      Else
                        #--- Si pas de regénération et qu'une des lignes a déjà été prise en compte, il ne faut pas valoriser
                        WPASVALO = 1 : Break
                      Endif
                    Next
                    #--- Il faut proratiser le montant valorisé des cdes factureés par rapport aux quantités réceptionnées/facturées totales
                    If WPASVALO = 0 & WTROUVE = 1
                      If WORDINVQTY <> 0 and (WORDINVQTY > WINVQTY)
                        WFISAMTDTA = (WFISAMTDTA*WINVQTY)/WORDINVQTY
                        WSTAAMTDTA = (WSTAAMTDTA*WINVQTY)/WORDINVQTY
                      Endif
                    Endif
                  Else
                    #--- cde non soldée et/ou non facturée et différence de quantité facturée sur la réception et la somme
                    #--- des quantités provenant des factures
                    #--- => pas de valorisation
                    WPASVALO=1
                  Endif
                Endif
            Endif
        Endif
        WFISAMTDTA += WSAVFISAMTDTA
        WSTAAMTDTA += WSAVSTAAMTDTA
        If WPASVALO = 0
            #--- Valeur fiscale valorisée avec les éléments de la facture
            If WFISAMTDTA <> 0 and WFISAMTDTA <> [M:DEBG]FISAMT(nolign-1)
                WMAJ = 1
            Endif
            #--- Valeur statistique valorisée avec les éléments de la facture
            If WSTAAMTDTA <> 0 and WSTAAMTDTA <> [M:DEBG]STAAMT(nolign-1)
                WMAJ = 1
            Endif
            # If WMAJ
                #--- Mise à jour LINEECFLG des détails factures pris en compte
                Raz WKCRITERE
                WKCRITERE = '(TYPORI=2 & NUMORI=[F:PTD]PTHNUM & LINORI=[F:PTD]PTDLIN)'
                If WORDINVQTY > 0
                    WKCRITERE -= 'or (TYPORI=1 & NUMORI=[F:PTD]POHNUM & LINORI=[F:PTD]POPLIN)'
                Endif
                #--- Mise à jour EECNUMDEB des entêtes des factures de réception prises en compte
                If WTRNOK = 0
                  For [PID]PID1 Where evalue(WKCRITERE) & INVTYP=1 :# Factures origine réception ou commande à l'origine de la réception
                      #--- Renseignement des pièces prises en compte lors de la valorisation
                      #--- Facture de la réception
                      #--CPO 75397 Indice incorrect
                      If nolign > NBLIGNESDET
                        Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                        Call ECR_TRACE(mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN),1) From GESECRAN
                        WTRNOK = 1 : Break
                      Endif
                      #--CPO
                      WINDICE=find([F:PID]NUM,WVCRNUMVALO(0..14,nolign-1))
                      If WINDICE<=0 or (WINDICE>0 and !find([F:PID]PIDLIN,WVCRLINVALO(WINDICE-1,nolign-1)))
                        WNOLINVALO += 1
                        If WNOLINVALO > 15 or nolign > NBLIGNESDET :#CPO 75397 100
                          Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                          Call ECR_TRACE(mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN),1) From GESECRAN
                          WTRNOK = 1 : Break
                        Endif
                          WVCRNUMVALO(WNOLINVALO-1,nolign-1)=[F:PID]NUM
                          WVCRLINVALO(WNOLINVALO-1,nolign-1)=[F:PID]PIDLIN
                      Endif
                      #--- Mise à jour des entêtes et détails des avoirs/factures avec origine la(les) facture(s) de réception
                      #--- uniquement si le paramètre général "EECVALOCPL" est à "Oui"
                      If GEECVALOCPL=2
                        For [PIDC]PID1 Where TYPORI=4 & NUMORI=[F:PID]NUM & LINORI=[F:PID]PIDLIN & INVTYP<3
                          #--- Renseignement des avoirs/factures sur la facture de réception
                          #--CPO 75397 Indice incorrect
                          If nolign > NBLIGNESDET
                            Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                            Call ECR_TRACE(mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN),1) From GESECRAN
                            WTRNOK = 1 : Break
                          Endif
                          #--CPO
                          WINDICE=find([F:PIDC]NUM,WVCRNUMVALO(0..14,nolign-1))
                          If WINDICE<=0 or (WINDICE>0 and !find([F:PIDC]PIDLIN,WVCRLINVALO(WINDICE-1,nolign-1)))
                            WNOLINVALO += 1
                            If WNOLINVALO > 15 or nolign > NBLIGNESDET :#CPO 75397 100
                              Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                              Call ECR_TRACE(mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN),1) From GESECRAN
                              WTRNOK = 1 : Break
                            Endif
                            WVCRNUMVALO(WNOLINVALO-1,nolign-1)=[F:PIDC]NUM
                            WVCRLINVALO(WNOLINVALO-1,nolign-1)=[F:PIDC]PIDLIN
                          Endif
                          #--- Mise à jour des entêtes et détails des avoirs avec origine factures complémentaires
                          For [PIDW]PID1 Where TYPORI=4 & NUMORI=[F:PIDC]NUM & LINORI=[F:PIDC]PIDLIN & INVTYP<3 :# Ligne d'avoir sur facture
                            #--- Renseignement des avoirs/factures sur la facture de réception
                            #--CPO 75397 Indice incorrect
                            If nolign > NBLIGNESDET
                              Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                              Call ECR_TRACE(mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN),1) From GESECRAN
                              WTRNOK = 1 : Break
                            Endif
                            #--CPO
                            WINDICE=find([F:PIDW]NUM,WVCRNUMVALO(0..14,nolign-1))
                            If WINDICE<=0 or (WINDICE>0 and !find([F:PIDW]PIDLIN,WVCRLINVALO(WINDICE-1,nolign-1)))
                              WNOLINVALO += 1
                              If WNOLINVALO > 15 or nolign > NBLIGNESDET :#CPO 75397 100
                                Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                                Call ECR_TRACE(mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN),1) From GESECRAN
                                WTRNOK = 1 : Break
                              Endif
                              WVCRNUMVALO(WNOLINVALO-1,nolign-1)=[F:PIDW]NUM
                              WVCRLINVALO(WNOLINVALO-1,nolign-1)=[F:PIDW]PIDLIN
                            Endif
                            If WMAJ
                              W_NUMPIECE   = [F:PIDW]NUM
                              W_NUMLINPIEC = [F:PIDW]PIDLIN
                              Update [PIDW] Where NUM=W_NUMPIECE and PIDLIN=W_NUMLINPIEC With LINEECFLG = 2
                              If fstat : Call FSTA("PID") From GLOCK : WTRNOK = 1 : Break : Endif

                              Update [PIHC] Where NUM=[F:PIDW]NUM With EECNUMDEB=[M]EECNUMDEB
                              If fstat : Call FSTA("PIH") From GLOCK : WTRNOK = 1 : Break : Endif
                            Endif
                          Next
                          If WTRNOK : Break : Endif
                          If WMAJ
                            W_NUMPIECE   = [F:PIDC]NUM
                            W_NUMLINPIEC = [F:PIDC]PIDLIN
                            Update [PIDC] Where NUM=W_NUMPIECE and PIDLIN=W_NUMLINPIEC With LINEECFLG = 2
                            If fstat : Call FSTA("PID") From GLOCK : WTRNOK = 1 : Break : Endif

                            Update [PIHC] Where NUM=[F:PIDC]NUM With EECNUMDEB=[M]EECNUMDEB
                            If fstat : Call FSTA("PIH") From GLOCK : WTRNOK = 1 : Break : Endif
                          Endif
                        Next
                      Endif
                      If WTRNOK : Break : Endif
                      If WMAJ
                        W_NUMPIECE   = [F:PID]NUM
                        W_NUMLINPIEC = [F:PID]PIDLIN
                        Update [PID] Where NUM=W_NUMPIECE and PIDLIN=W_NUMLINPIEC With LINEECFLG = 2
                        If fstat : Call FSTA("PID") From GLOCK : WTRNOK = 1 : Break : Endif

                        Update [PIH] Where NUM=[F:PID]NUM With EECNUMDEB = [M]EECNUMDEB
                        If fstat : Call FSTA("PIH") From GLOCK : WTRNOK = 1 : Break : Endif
                      Endif
                  Next
                Endif
                If WTRNOK : WOK = 0 : Break :# de la boucle de parcours des détails réception
                Else
                  #--- Valeur fiscale valorisée avec les éléments de la facture
                  If WFISAMTDTA <> 0 and WFISAMTDTA <> [M:DEBG]FISAMT(nolign-1)
                    [M:DEBG]FISAMT(nolign-1) = WFISAMTDTA
                    [M:DEBG]LINVALOFLG(nolign-1)=2
                  Endif
                  #--- Valeur statistique valorisée avec les éléments de la facture
                  If WSTAAMTDTA <> 0 and WSTAAMTDTA <> [M:DEBG]STAAMT(nolign-1)
                    [M:DEBG]STAAMT(nolign-1) = WSTAAMTDTA
                    [M:DEBG]LINVALOFLG(nolign-1)=2
                  Endif
                Endif
            # Endif :# fin MAJ
        Endif
      Endif #--CPO DM 105661 Ajout de la sous-traitance
    Endif

    If WTRNOK=1 or WOK=0 : Break : Endif #--CPO DM 105661 Ajout de la sous-traitance
    #--CPO DM 105661 Ajout de la sous-traitance
    #--- Cas de la Réception de Sous-Traitance => Régime positionné à la valeur du flux de la table des regimes et nat. par mvt.
    #If [F:PTD]LINTYP=2
    #  # MVT= 9 : "Réception de Sous-Traitance"
    #  Raz WTROUVE
    #  Raz WVALSTO
    #  Call FLUX_REGNAT(9,[F:PTH]PRHFCY,W_CRYTO,[M:DEBG]EECSCH(nolign-1),[M:DEBG]EECNAT(nolign-1),WVALSTO,WTROUVE) From FUNDEBA
    #  If WTROUVE
    #    Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-num$([F:PTD]PTDLIN),0) From GESECRAN
    #    # "Réception de sous-traitance : le Régime CEE et/ou la Nature ont été modifiés"
    #    Call ECR_TRACE(mess(738,197,1),0) From GESECRAN
    #  Endif
    #Endif
    #--/
    #--- Maj flag LINEECFLG dans les détails de la pièce de réception
    If [F:PTH]PTHNUM <> ""
      W_NUMPIECE = [F:PTH]PTHNUM
      W_NUMLINPIEC = [F:PTD]PTDLIN
      Update [PTD] Where PTHNUM = W_NUMPIECE and PTDLIN = W_NUMLINPIEC With LINEECFLG = 2
      If fstat : Call FSTA("PTD") From GLOCK : WOK = 0 : Break : Endif
      Raz W_NUMPIECE : Raz W_NUMLINPIEC
    Endif

$NEXT_EEC_UN_PTH
Next

If WOK = 0 : Return : Endif
If nolign = 0 : WOK = 0 : Return : Endif

Return
#######################################################################
#Remplissage du masque de génération avec les éléments liés aux pièces de réception
#######################################################################
$DEBG_PTH
If nolign=1
  Raz [M:DEBG]
  [M:DEBG]CPY       = [M:DIA]CPY
  [M:DEBG]CUR       = [F:CPY]ACCCUR
  [M:DEBG]EECNUMDEB = [M:DIA]EECNUMDEB
  [M:DEBG]DEBDAT    = [M:DIA]DEBDAT
  [M:DEBG]VCRTYP    = 6
  [M:DEBG]VCRNUM    = [F:PTH]PTHNUM
  [M:DEBG]DAT       = [F:PTH]RCPDAT
  [M:DEBG]CURDOC    = [F:PTH]CUR
  [M:DEBG]BPRNUM    = [F:PTH]BPSINV
  If [F:PTH]EECNUM<>""
    [M:DEBG]EECNUM = [F:PTH]EECNUM
  Else
    #--- N° d'identif CEE du fournisseur facturant
    If [F:BPR]BPRNUM <> [F:PTH]BPSINV
      Read [BPR]BPR0 = [F:PTH]BPSINV
      If fstat : Raz [F:BPR] : Endif
      [M:DEBG]EECNUM  = [F:BPR]EECNUM
    Else
      [M:DEBG]EECNUM  = [F:BPR]EECNUM
    Endif
  Endif
  #FQ 52621
  #--- Cas du n° de TVA issu du pays de réception
  If [M:DEBG]EECNUM <> ""
    If left$([M:DEBG]EECNUM,2)=W_EECCRYTO
      Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM,0) From GESECRAN
      # "Radical du numéro de TVA identique à celui du site de réception"
      Call ECR_TRACE(mess(751,197,1),0) From GESECRAN
    Endif
  Endif
Endif
# Faut-il renseigner le n° de département uniquement pour la France ?
If [F:PTD]PRHFCY<>""
  If [F:FCY]FCY<>[F:PTD]PRHFCY
    Read [FCY]FCY0=[F:PTD]PRHFCY
    If fstat : Raz [F:FCY] : Endif
  Endif
  If [F:FCY]BPAADD <> ""
    Read [BPA]BPA0=3;[F:PTD]PRHFCY;[F:FCY]BPAADD
    If fstat : Raz [F:BPA] : Endif
    If [F:BPA]POSCOD<>""
      [M:DEBG]REG (nolign-1) = left$([F:BPA]POSCOD,2)
    Endif
  Endif
Endif
#--- Etat fédéral
If dim([M:DEBG]STAFED)>0
  Raz WSTAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
  Read [ITF]ITF0=[F:PTD]ITMREF;[F:PTH]PRHFCY
  If fstat : Raz [F:ITF] : Endif
  If dim([F:ITF]STAFED)<>0 and [F:ITF]STAFED<>""
    WSTAFED=[F:ITF]STAFED #[M:DEBG]STAFED(nolign-1)=[F:ITF]STAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
  Else
    If dim([F:ITM]STAFED)>0 and [F:ITM]STAFED<>""
      WSTAFED=[F:ITM]STAFED #[M:DEBG]STAFED(nolign-1)=[F:ITM]STAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
    Endif
  Endif
  Gosub SET_M_DEBG_STAFED From FUNDEBA # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
Endif
#--- Site de stockage
[M:DEBG]STOFCY  (nolign-1) = [F:PTH]PRHFCY
[M:DEBG]CRYFCY  (nolign-1) = W_EECCRYTO
#---
[M:DEBG]VCRLIN  (nolign-1) = [F:PTD]PTDLIN
[M:DEBG]FLO     (nolign-1) = 1
[M:DEBG]ITMREF  (nolign-1) = [F:PTD]ITMREF
[M:DEBG]ITMDES1 (nolign-1) = [F:PTD]ITMDES1
[M:DEBG]CUSREF  (nolign-1) = [F:ITM]CUSREF
#--CPO DM 105661 Ajout de la sous-traitance
#[M:DEBG]EECNAT  (nolign-1) = [F:PTH]EECNAT
#[M:DEBG]EECSCH  (nolign-1) = [F:PTH]EECSCH
If [L]W_CHANGED_MVT=1
  [M:DEBG]EECNAT  (nolign-1) = WEECNAT
  [M:DEBG]EECSCH  (nolign-1) = WEECSCH
Else
  [M:DEBG]EECNAT  (nolign-1) = [F:PTH]EECNAT
  [M:DEBG]EECSCH  (nolign-1) = [F:PTH]EECSCH
Endif
#--/
If W_EECCRYFFW<>""
  [M:DEBG]DESCRY  (nolign-1) = W_EECCRYFFW
Else
  [M:DEBG]DESCRY  (nolign-1) = W_EECCRYFROM
Endif
If [F:PTD]ORICRY <> ""
  LCRY=[F:PTD]ORICRY
Else
  LCRY=[F:PTH]BPOCRY          :#si l’origine n’est pas renseignée, on met le pays d'expédition
Endif

#--- TS Issue 101474 --CPO OK
If LCRY=""
  If [F:BPA]BPATYP<>1 or [F:BPA]BPANUM<>[F:PTH]BPSNUM or [F:BPA]BPAADD<>[F:PTH]BPOADD
    Read [BPA]BPA0=1;[F:PTH]BPSNUM;[F:PTH]BPOADD
    If fstat : Raz [F:BPA] : Endif
  Endif
  LCRY = [F:BPA]CRY
  #  Read [BPA]BPA0=1;[F:PTH]BPSNUM;[F:PTH]BPOADD
  #  If !fstat : LCRY=[F:BPA]CRY : Endif
Endif
#---

Gosub LEC_TCY
If [F:TCY]EECFLG=2 & [F:TCY]EECCOD<>""
  [M:DEBG]ORICRY(nolign-1)=[F:TCY]EECCOD
Else
  [M:DEBG]ORICRY(nolign-1)=[F:TCY]ISO
Endif

If [F:ITM]ITMWEI<>0
  If toupper(left$([F:ITM]WEU,2))="KG"
    [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:PTD]QTYSTU
  Else
    I=find("KG",GUNITE(1..GDIMUNT))
    If I=0 I=find("Kg",GUNITE(1..GDIMUNT)) Endif
    If I=0 I=find("kg",GUNITE(1..GDIMUNT)) Endif
    If I<>0
      Read [TCO]TCO0=[F:ITM]WEU;GUNITE(I)
      If !fstat [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:PTD]QTYSTU*[F:TCO]COEUOM Endif
    Endif
  Endif
Endif
If [F:ITM]EEU<>"" & [F:ITM]EEUSTUCOE<>0
  [M:DEBG]EECUNT (nolign-1) =[F:PTD]QTYSTU/[F:ITM]EEUSTUCOE
Endif
[M:DEBG]EECTRN  (nolign-1) = [F:PTH]EECTRN
[M:DEBG]EECICT  (nolign-1) = [F:PTH]EECICT
[M:DEBG]EECLOC  (nolign-1) = [F:PTH]EECLOC

#--CPO DM 105661 Ajout de la sous-traitance
#--Déplacement du test valeurs vides de EECSCH et EECNAT
#--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
#--- Si Régime et Nature sont vides, la ligne n'est pas extraite
If [M:DEBG]EECSCH(nolign-1)<>"" or [M:DEBG]EECNAT(nolign-1)<>""
  [L]W_ISEMPTY_EEC_SCH_NAT=0
Else
  If [M]PRNULREGNA=2 and W_ISEMPTY_EEC_SCH_NAT=0
    Call ECR_TRACE(mess(735,197,1)-[F:PTD]PTHNUM-num$([F:PTD]PTDLIN)-[F:PTD]ITMREF-mess(746,197,1)
&    -mess(744,197,1)-mess(745,197,1),0) From GESECRAN
  Endif
  #--On passe à la ligne suivante
  WOKLIG=0 : Return
Endif
#--/

#--CPO DM 105661 Ajout de la sous-traitance
If WMVT=9
  Gosub DEBG_PTH_SST From FUNDEBB
Else
#--/
  #--- Calcul de la valeur fiscale
  #--- Calcul de la valeur statistique
  # Prise en compte des éléments de facturation
  # Répartition sur chaque ligne au prorata des montants
  If [F:PTD]LINAMT > 0
    [M:DEBG]FISAMT(nolign-1) = [F:PTD]LINAMT
  Else
    #--- Si le montant net de la ligne est 0, on prend le prix du mouvement
    #--- Ce dernier est libéllé dans la devise figurant dans "CPRCUR", est porte sur la quantité en UStock
    #--- On tient compte du paramétrage de la valeur stock du flux
    #--CPO DM 105661 Ajout de la sous-traitance
    #--WMVT est initialisé plus haut
  #  Raz WMVT
  #  WMVT=8                                             : # Réception classique
  #  If [F:PTH]BETFCY = 2 : WMVT=10 : Endif             : # Réception inter-sites
  #  If [F:PTH]BETCPY = 2 : WMVT=11 : Endif             : # Réception inter-sociétés
  #  #--CPO DM 105661 Ajout de la sous-traitance
  #  #If [F:PTD]LINCAT = 2 : WMVT=9  : Endif            : # Réception de sous-traitance
  #  If [F:PTD]LINTYP = 2 : WMVT=9  : Endif             : # Réception produit fini de sous-traitance
  #  If [F:PTD]LINCAT = 2 : WMVT=20 : Endif             : # Réception matières pour sous-traitance
  #  Raz WTROUVE
  #  Raz WVALSTO
  #  Call FLUX_REGNAT(WMVT,[F:PTH]PRHFCY,W_CRYTO,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
  #  #--/
    If WMVT<>20
      Raz WTROUVE
      Raz WVALSTO
      Call FLUX_REGNAT(WMVT,[F:PTH]PRHFCY,W_CRYTO,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
    Endif
    #--/
    If WTROUVE and WVALSTO=2
      [M:DEBG]FISAMT(nolign-1) = [F:PTD]QTYSTU*[F:PTD]CPR
    Else
      #--- Il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes
      Raz JL0,JL1
      #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
      #JL0=find([F:PTH]EECSCH,REG_CODE)
      #JL1=find([F:PTH]EECNAT,NAT_CODE)
      #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
      #--CPO DM 105661 Ajout de la sous-traitance
      #Call LEC_TSC_LEG(GCURLEG,[F:PTH]EECSCH,JL0) From TRTLECLEG
      Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
      #--/
      If JL0>0 : Raz [F:TSC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      #--CPO DM 105661 Ajout de la sous-traitance
      #Call LEC_TEC_LEG(GCURLEG,[F:PTH]EECNAT,JL1) From TRTLECLEG
      Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
      If JL1>0 : Raz [F:TEC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
      #--/
        [M:DEBG]FISAMT(nolign-1) = [F:PTD]QTYSTU*[F:PTD]CPR
      Endif
    Endif
    If [M:DEBG]FISAMT(nolign-1)>0
      If [F:PTD]CPRCUR <> [F:PTH]CUR
        #--- Il faut convertir le montant dans la devise du document
        WFISAMT=[M:DEBG]FISAMT(nolign-1)
        Raz STAT
        Call CONVERT([F:PTD]CPRCUR,[F:PTH]CUR,WCUR,GEECTYPCUR,[F:PTH]NDEDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
        If STAT
          Raz STAT
          Call CONVERT([F:PTD]CPRCUR,[F:PTH]CUR,WCUR,[F:PTH]CHGTYP,[F:PTH]NDEDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
          If STAT
            WOK=0
            Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-mess(71,199,1),1) From GESECRAN
            Return
          Endif
        Endif
      Endif
    Endif
  Endif
  #--- Prise en compte du taux de majoration CEE
  If [F:PTD]EECINCRAT <> 0
    [M:DEBG]STAAMT(nolign-1) = [M:DEBG]FISAMT(nolign-1)*[F:PTD]EECINCRAT
  Else
    [M:DEBG]STAAMT(nolign-1) = [M:DEBG]FISAMT(nolign-1)
  Endif
  # Attention :
  # Chaque DISCRGAMTx sera pris en compte si l'élément de facturation duquel il provient a CLCDEB > 1
  # De plus les éléments peuvent rentrer différement dans le calcul de la valeur fiscale et/ou de la valeur statistique
  WPIECE       = "PTH"
  WDETAILPIECE = "PTD"
  Gosub ACH_TOTDISCRG
  WFACDISCRG   = WTOTDISCRG
  WFACDISCRGVS = WTOTDISCRGVS
  Raz WPIECE : Raz WDETAILPIECE
  # Si le total des lignes ne permet pas de proratiser,
  # il faut prendre en compte les éléments déjà éclatés sur les lignes
  If [F:PTH]TOTLINAMT <> 0
    [M:DEBG]FISAMT(nolign-1) += ((WINVDTAAMT*[F:PTD]LINAMT)/[F:PTH]TOTLINAMT) + WFACDISCRG     :# WDISCRGAMT
    [M:DEBG]STAAMT(nolign-1) += ((WINVDTAAMTVS*[F:PTD]LINAMT)/[F:PTH]TOTLINAMT) + WFACDISCRGVS :# WDISCRGAMTVS
  Else
    [M:DEBG]FISAMT(nolign-1) += WFACDISCRG     :# WDISCRGAMT
    [M:DEBG]STAAMT(nolign-1) += WFACDISCRGVS   :# WDISCRGAMTVS
  Endif
Endif :#--CPO DM 105661 Ajout de la sous-traitance

#--- Conversion de la valeur fiscale, le cas échéant
If [F:PTH]CUR <> WCUR
  WFISAMT=[M:DEBG]FISAMT(nolign-1)
  Raz STAT
  Call CONVERT([F:PTH]CUR,WCUR,WCUR,GEECTYPCUR,[F:PTH]NDEDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
  If STAT
    Raz STAT
    Call CONVERT([F:PTH]CUR,WCUR,WCUR,[F:PTH]CHGTYP,[F:PTH]NDEDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
    If STAT
      WOK=0
      Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-mess(71,199,1),1) From GESECRAN
      Return
    Endif
  Endif
Endif
#--- Conversion de la valeur statistique, le cas échéant
If [F:PTH]CUR <> WCUR
  WSTAAMT=[M:DEBG]STAAMT(nolign-1)
  Raz STAT
  Call CONVERT([F:PTH]CUR,WCUR,WCUR,GEECTYPCUR,[F:PTH]NDEDAT,WSTAAMT,[M:DEBG]STAAMT(nolign-1),STAT) From TRTDEV
  If STAT
    Raz STAT
    Call CONVERT([F:PTH]CUR,WCUR,WCUR,[F:PTH]CHGTYP,[F:PTH]NDEDAT,WSTAAMT,[M:DEBG]STAAMT(nolign-1),STAT) From TRTDEV
    If STAT
      WOK=0
      Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-mess(71,199,1),1) From GESECRAN
      Return
    Endif
  Endif
Endif
[M:DEBG]NIV        (nolign-1)= GNIVINT
[M:DEBG]AMTNOTINVL (nolign-1)= [F:PTD]LINAMT
[M:DEBG]NBDEB = nolign

Return
#######################################################################
#Prise en compte des éléments de facturation présents sur les factures lièes aux Réceptions
#dans le calcul de la valeur fiscale et/ou statistique,
#le cas échéant
#######################################################################
$DEBG_DTA_PTH
#--- Vérification si la facture n'a pas fait l'objet d'une DEB
If ([F:PIH]EECNUMDEB <> 0 & [F:PIH]EECNUMDEB <> [M]EECNUMDEB) : WPASVALO = 1 : Return : Endif
#--- Enregistrement PIV doit exister
If [F:PIV]NUM <> [F:PIH]NUM
  Read [PIV]PIV0=[F:PIH]NUM
  If fstat : WPASVALO = 1 : Raz [F:PIV] : Return : Endif
Endif
WFISAMT = [F:PID]AMTNOTLIN
#--- Prise en compte de EECINCRAT
# içi, car après il peut y avoir des éléments de facturation pris en compte uniquement dans la valeur statistique
# Pas de EECINCRAT dans le PID
# Nous devons le chercher dans la pièce de réception
If [F:PTD]EECINCRAT <> 0
  WSTAAMT  = [F:PID]AMTNOTLIN*[F:PTD]EECINCRAT
Else
  WSTAAMT  = [F:PID]AMTNOTLIN
Endif
If [F:PID]AMTNOTLIN=0
  #--- Si le montant net de la ligne est 0, on prend le prix du mouvement de la réception
  #--- Ce dernier est libéllé dans la devise figurant dans "CPRCUR", est porte sur la quantité en UStock
  #--- On tient compte du paramétrage de la valeur stock du flux
  #--CPO DM 105661 Ajout de la sous-traitance
  #--WMVT est initialisé plus haut
#  Raz WMVT
#  WMVT=8                                             : # Réception classique
#  If [F:PTH]BETFCY = 2 : WMVT=10 : Endif             : # Réception inter-sites
#  If [F:PTH]BETCPY = 2 : WMVT=11 : Endif             : # Réception inter-sociétés
#  #--CPO 105661 Réception POUR sous-traitance
#  #If [F:PTD]LINCAT = 2 : WMVT=9  : Endif             : # Réception de sous-traitance
#  If [F:PTD]LINTYP = 2 : WMVT=9  : Endif             : # Réception de sous-traitance
#  If [F:PTD]LINCAT = 2 : WMVT=20 : Endif             : # Réception pour sous-traitance
#  #--/
  #--/
  Raz WTROUVE
  Raz WVALSTO
  Call FLUX_REGNAT(WMVT,[F:PTH]PRHFCY,W_CRYTO,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
  If WTROUVE and WVALSTO=2
    WFISAMT = [F:PID]QTYSTU*[F:PTD]CPR :# "Prix de revient" de la réception
  Else
    #--- Il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes
    Raz JL0,JL1
    #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
    #JL0=find([F:PTH]EECSCH,REG_CODE)
    #JL1=find([F:PTH]EECNAT,NAT_CODE)
    #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
    #--CPO DM 105661 Ajout de la sous-traitance
    #--On doit utiliser les infos de M:DEBG car possible modifiées suite infos lignes (exp sous-traitance)
    #Call LEC_TSC_LEG(GCURLEG,[F:PTH]EECSCH,JL0) From TRTLECLEG
    #If JL0>0 : Raz [F:TSC] : Endif
    #Call LEC_TEC_LEG(GCURLEG,[F:PTH]EECNAT,JL1) From TRTLECLEG
    #If JL1>0 : Raz [F:TEC] : Endif
    Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
    If JL0>0 : Raz [F:TSC] : Endif
    # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
    If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
      Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
    Endif
    # End issue X3-131291
    Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
    If JL1>0 : Raz [F:TEC] : Endif
    # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
    If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
      Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
    Endif
    # End issue X3-131291
    If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
    #--/
      WFISAMT = [F:PID]QTYSTU*[F:PTD]CPR :# "Prix de revient" de la réception
    Endif
  Endif
  If WFISAMT>0
    If [F:PTD]CPRCUR <> [F:PIH]CUR
      #--- Il faut convertir le montant dans la devise du document
      WKMONTANT=WFISAMT
      Raz STAT
      Call CONVERT([F:PTD]CPRCUR,[F:PIH]CUR,WCUR,GEECTYPCUR,[F:PIH]ACCDAT,WKMONTANT,WFISAMT,STAT) From TRTDEV
      If STAT
        Raz STAT
        Call CONVERT([F:PTD]CPRCUR,[F:PIH]CUR,WCUR,[F:PIH]CURTYP,[F:PIH]ACCDAT,WKMONTANT,WFISAMT,STAT) From TRTDEV
        If STAT
          Call ECR_TRACE(mess(735,197,1)-[F:PIH]NUM-mess(71,199,1),1) From GESECRAN
          WPASVALO = 1 : Return
        Endif
      Endif
    Endif
    If [F:PTD]EECINCRAT <> 0
      WSTAAMT  = WFISAMT*[F:PTD]EECINCRAT
    Else
      WSTAAMT  = WFISAMT
    Endif
  Endif
Endif
#--- En-tête, nous calculons la somme des éléments de facturation de l'en-tête
#--- Eléments de facturation
# Les éléments de facturation sont présents sur les pieds des pièces autres que les factures
# Prise en compte des éléments non répartis sur les lignes : INVLINFLG = 1 ou 6,
# a condition qu'ils entrent dans le calcul de la valeur fiscale et/ou valeur statistique : CLCDEB = 2 ou 3
# puis répartition sur les lignes, au prorata des montants de chaque ligne
WNUMEROPIECE = [F:PID]NUM
W_VCRTYP=8 # Issue 110289 - 2015-08-12 by CPO : Invoicing elements when using same counter on different documents
Gosub ACH_TOTDTA
WFACDTAAMT   = WTOTDTA
WFACDTAAMTVS = WTOTDTAVS
Raz WNUMEROPIECE
Raz W_VCRTYP # Issue 110289 - 2015-08-12 by CPO
W_NUM = [F:PID]NUM

#--- Nous traitons la ligne de détail facture liée au détail de réception
#--- Calcul de la somme des éléments de facturation répartis sur les lignes
# Attention :
# Chaque DISCRGAMTx sera pris en compte si l'élément de facturation duquel il provient a CLCDEB > 1
# De plus les éléments peuvent rentrer différement dans le calcul de la valeur fiscale et/ou de la valeur statistique
WPIECE       = "PIV"
WDETAILPIECE = "PID"
Gosub ACH_TOTDISCRG
WFACDISCRG   = WTOTDISCRG
WFACDISCRGVS = WTOTDISCRGVS
Raz WPIECE : Raz WDETAILPIECE
# Si le total des lignes ne permet pas de proratiser,
# il faut prendre en compte les éléments déjà éclatés sur les lignes
If [F:PIV]TOTLINAMT <> 0
  WFISAMT += ((WFACDTAAMT*[F:PID]AMTNOTLIN)/[F:PIV]TOTLINAMT) + WFACDISCRG
  WSTAAMT += ((WFACDTAAMTVS*[F:PID]AMTNOTLIN)/[F:PIV]TOTLINAMT) + WFACDISCRGVS
Else
   # il faut prendre en compte les éléments déjà éclatés sur les lignes
   WFISAMT += WFACDISCRG
   WSTAAMT += WFACDISCRGVS
Endif

#--- Conversion de la valeur fiscale, le cas échéant
If [F:PIH]CUR <> WCUR
   WMONTANT = WFISAMT
   Raz STAT
   Call CONVERT([F:PIH]CUR,WCUR,WCUR,GEECTYPCUR,[F:PIH]ACCDAT,WMONTANT,WFISAMT,STAT) From TRTDEV
   If STAT
     Raz STAT
     Call CONVERT([F:PIH]CUR,WCUR,WCUR,[F:PIH]CURTYP,[F:PIH]ACCDAT,WMONTANT,WFISAMT,STAT) From TRTDEV
     If STAT
       Call ECR_TRACE(mess(742,197,1)-[F:PIH]NUM-mess(71,199,1),1) From GESECRAN
       WPASVALO = 1 : Return
     Endif
   Endif
Endif
#--- Conversion de la valeur statistique, le cas échéant
If [F:PIH]CUR <> WCUR
   WMONTANT = WSTAAMT
   Raz STAT
   Call CONVERT([F:PIH]CUR,WCUR,WCUR,GEECTYPCUR,[F:PIH]ACCDAT,WMONTANT,WSTAAMT,STAT) From TRTDEV
   If STAT
     Raz STAT
     Call CONVERT([F:PIH]CUR,WCUR,WCUR,[F:PIH]CURTYP,[F:PIH]ACCDAT,WMONTANT,WSTAAMT,STAT) From TRTDEV
     If STAT
       Call ECR_TRACE(mess(742,197,1)-[F:PIH]NUM-mess(71,199,1),1) From GESECRAN
       WPASVALO = 1 : Return
     Endif
   Endif
Endif
#FQ 52777 - la valeur fiscale est modifiée uniquement si la ligne porte sur le même article de la réception
If [F:PID]ITMREF = [F:PTD]ITMREF
  WFISAMTDTA += WFISAMT
Endif
Raz WFISAMT : Raz WMONTANT
WSTAAMTDTA += WSTAAMT : Raz WSTAAMT : Raz WMONTANTVS
#--- Recherche si existe des factures/avoirs complémentaires ayant comme origine une facture liée à ma réception
#--- Le cas échéant, il faut prendre en compte le montant de cette(ces) facture(s) dans la valorisation de ma réception pour la DEB
If WPASVALO : Return : Endif
#--- uniquement si le paramètre général "EECVALOCPL" est à "Oui"
If GEECVALOCPL=2
  For [PIDC]PID1 Where TYPORI=4 & NUMORI=[F:PIH]NUM & LINORI=[F:PID]PIDLIN & INVTYP < 3
    If [F:PIHC]NUM <> [F:PIDC]NUM
      Read [PIHC]PIH0 = [F:PIDC]NUM
      If fstat : WPASVALO = 1 : Raz [F:PIHC] : Break : Endif
    Endif
    #--- Vérification si la facture n'a pas fait l'objet d'une DEB
    If ([F:PIHC]EECNUMDEB <> 0 & [F:PIHC]EECNUMDEB <> [M]EECNUMDEB) : WPASVALO = 1 : Break : Endif
    #--- La pièce doit être validée
    If [F:PIHC]STA = 3
      If [F:PIVC]NUM <> [F:PIHC]NUM
        Read [PIVC]PIV0 = [F:PIHC]NUM
        If fstat : WPASVALO = 1 : Raz [F:PIVC] : Break : Endif
      Endif
      WMONTANT   = [F:PIDC]AMTNOTLIN
      WMONTANTVS = [F:PIDC]AMTNOTLIN
      #FQ 52776
      If [F:PTD]EECINCRAT <> 0
        WMONTANTVS = WMONTANTVS*[F:PTD]EECINCRAT
      Endif
      #--- Prise en compte des éléments de facturation non répartis
      WNUMEROPIECE = [F:PIDC]NUM
      W_VCRTYP=8 # Issue 110289 - 2015-08-12 by CPO : Invoicing elements when using same counter on different documents
      Gosub ACH_TOTDTA
      # calcul de WTOTDTA
      # calcul de WTOTDTAVS
      Raz WNUMEROPIECE
      Raz W_VCRTYP # Issue 110289 - 2015-08-12 by CPO
      #--- Prise en compte des éléments de facturation répartis sur les lignes
      WPIECE       = "PIVC"
      WDETAILPIECE = "PIDC"
      Gosub ACH_TOTDISCRG
      # calcul de WTOTDISCRG
      # calcul de WTOTDISCRGVS
      Raz WPIECE : Raz WDETAILPIECE
      # Si le total des lignes ne permet pas de proratiser,
      # il faut prendre en compte les éléments déjà éclatés sur les lignes
      If [F:PIVC]TOTLINAMT <> 0
        WMONTANT   += ((WTOTDTA*[F:PIDC]AMTNOTLIN)/[F:PIVC]TOTLINAMT) + WTOTDISCRG
        WMONTANTVS += ((WTOTDTAVS*[F:PIDC]AMTNOTLIN)/[F:PIVC]TOTLINAMT) + WTOTDISCRGVS
      Else
         # il faut prendre en compte les éléments déjà éclatés sur les lignes
         WMONTANT   += WTOTDISCRG
         WMONTANTVS += WTOTDISCRGVS
      Endif
      #--- Conversion valeur fiscale
      If [F:PIHC]CUR <> WCUR
        WKMONTANT = WMONTANT
        Raz STAT
        Call CONVERT([F:PIHC]CUR,WCUR,WCUR,GEECTYPCUR,[F:PIHC]ACCDAT,WKMONTANT,WMONTANT,STAT) From TRTDEV
        If STAT
          Raz STAT
          Call CONVERT([F:PIHC]CUR,WCUR,WCUR,[F:PIHC]CURTYP,[F:PIHC]ACCDAT,WKMONTANT,WMONTANT,STAT) From TRTDEV
          If STAT
            Call ECR_TRACE(mess(742,197,1)-[F:PIHC]NUM-mess(71,199,1),1) From GESECRAN
            WPASVALO = 1 : Break
          Endif
        Endif
      Endif
      #--- Conversion valeur statistique
      If [F:PIHC]CUR <> WCUR
        WKMONTANT = WMONTANTVS
        Raz STAT
        Call CONVERT([F:PIHC]CUR,WCUR,WCUR,GEECTYPCUR,[F:PIHC]ACCDAT,WKMONTANT,WMONTANTVS,STAT) From TRTDEV
        If STAT
          Raz STAT
          Call CONVERT([F:PIHC]CUR,WCUR,WCUR,[F:PIHC]CURTYP,[F:PIHC]ACCDAT,WKMONTANT,WMONTANTVS,STAT) From TRTDEV
          If STAT
            Call ECR_TRACE(mess(742,197,1)-[F:PIHC]NUM-mess(71,199,1),1) From GESECRAN
            WPASVALO = 1 : Break
          Endif
        Endif
      Endif
    Else
      # Si pièce non validée, il n'y aura aucune valorisation
      WPASVALO=1 : Break
    Endif
    If [F:PIDC]INVTYP = 1
      #--- Si Facture, le montant vient s'ajouter
      #FQ 52777 - la valeur fiscale est modifiée uniquement
      #si la ligne porte sur le même article de la réception
      If [F:PIDC]ITMREF = [F:PTD]ITMREF
        WFISAMTDTA += WMONTANT
      Endif
      WSTAAMTDTA += WMONTANTVS
    Elsif [F:PIDC]INVTYP = 2
      #--- Si Avoir, le montant vient en déduction
      #FQ 52777 - la valeur fiscale est modifiée uniquement
      #si la ligne porte sur le même article de la réception
      If [F:PIDC]ITMREF = [F:PTD]ITMREF
        WFISAMTDTA -= WMONTANT
      Endif
      WSTAAMTDTA -= WMONTANTVS
    Endif
    #--- Prise en compte des factures/avoirs sur pièces complémentaires
    #--- Recherche si existe des factures/avoirs ayant comme origine une facture complémentaires de ma réception
    #--- Le cas échéant, il faut prendre en compte le montant de cette(ces) facture(s) dans la valorisation de ma réception pour la DEB
    For [PIDW]PID1 Where TYPORI=4 & NUMORI=[F:PIDC]NUM & LINORI=[F:PIDC]PIDLIN & INVTYP<3 :#=2 :# Ligne d'avoir sur facture complémentaire
      If [F:PIHC]NUM <> [F:PIDW]NUM
        Read [PIHC]PIH0 = [F:PIDW]NUM
        If fstat : WPASVALO = 1 : Raz [F:PIHC] : Break : Endif
      Endif
      #--- Vérification si la facture n'a pas fait l'objet d'une DEB
      If ([F:PIHC]EECNUMDEB <> 0 & [F:PIHC]EECNUMDEB <> [M]EECNUMDEB) : WPASVALO = 1 : Break : Endif
      #--- La pièce doit être validée
      If [F:PIHC]STA = 3
        If [F:PIVC]NUM <> [F:PIHC]NUM
          Read [PIVC]PIV0 = [F:PIHC]NUM
          If fstat : WPASVALO = 1 : Raz [F:PIVC] : Break : Endif
        Endif
        WMONTANT   = [F:PIDW]AMTNOTLIN
        WMONTANTVS = [F:PIDW]AMTNOTLIN
        #FQ 52776
        If [F:PTD]EECINCRAT <> 0
          WMONTANTVS = WMONTANTVS*[F:PTD]EECINCRAT
        Endif
        #--- Prise en compte des éléments de facturation non répartis
        WNUMEROPIECE = [F:PIDW]NUM
        W_VCRTYP=8 # Issue 110289 - 2015-08-12 by CPO : Invoicing elements when using same counter on different documents
        Gosub ACH_TOTDTA
        # calcul de WTOTDTA
        # calcul de WTOTDTAVS
        Raz WNUMEROPIECE
        Raz W_VCRTYP # Issue 110289 - 2015-08-12 by CPO
        #--- Prise en compte des éléments de facturation répartis sur les lignes
        WPIECE       = "PIVC"
        WDETAILPIECE = "PIDW"
        Gosub ACH_TOTDISCRG
        # calcul de WTOTDISCRG
        # calcul de WTOTDISCRGVS
        Raz WPIECE : Raz WDETAILPIECE
        # Si le total des lignes ne permet pas de proratiser,
        # il faut prendre en compte les éléments déjà éclatés sur les lignes
        If [F:PIVC]TOTLINAMT <> 0
          WMONTANT   += ((WTOTDTA*[F:PIDW]AMTNOTLIN)/[F:PIVC]TOTLINAMT) + WTOTDISCRG
          WMONTANTVS += ((WTOTDTAVS*[F:PIDW]AMTNOTLIN)/[F:PIVC]TOTLINAMT) + WTOTDISCRGVS
        Else
           # il faut prendre en compte les éléments déjà éclatés sur les lignes
           WMONTANT   += WTOTDISCRG
           WMONTANTVS += WTOTDISCRGVS
        Endif
          #--- Conversion valeur fiscale
          If [F:PIHC]CUR <> WCUR
            WKMONTANT = WMONTANT
            Raz STAT
            Call CONVERT([F:PIHC]CUR,WCUR,WCUR,GEECTYPCUR,[F:PIHC]ACCDAT,WKMONTANT,WMONTANT,STAT) From TRTDEV
            If STAT
              Raz STAT
              Call CONVERT([F:PIHC]CUR,WCUR,WCUR,[F:PIHC]CURTYP,[F:PIHC]ACCDAT,WKMONTANT,WMONTANT,STAT) From TRTDEV
              If STAT
                Call ECR_TRACE(mess(742,197,1)-[F:PIHC]NUM-mess(71,199,1),1) From GESECRAN
                WPASVALO = 1 : Break
              Endif
            Endif
          Endif
          #--- Conversion valeur statistique
          If [F:PIHC]CUR <> WCUR
            WKMONTANT = WMONTANTVS
            Raz STAT
            Call CONVERT([F:PIHC]CUR,WCUR,WCUR,GEECTYPCUR,[F:PIHC]ACCDAT,WKMONTANT,WMONTANTVS,STAT) From TRTDEV
            If STAT
              Raz STAT
              Call CONVERT([F:PIHC]CUR,WCUR,WCUR,[F:PIHC]CURTYP,[F:PIHC]ACCDAT,WKMONTANT,WMONTANTVS,STAT) From TRTDEV
              If STAT
                Call ECR_TRACE(mess(742,197,1)-[F:PIHC]NUM-mess(71,199,1),1) From GESECRAN
                WPASVALO = 1 : Break
              Endif
            Endif
          Endif
      Else
        # Si pièce non validée, il n'y aura aucune valorisation
        WPASVALO=1 : Break
      Endif
      If [F:PIDW]INVTYP = 1
        #--- Si Facture, le montant vient s'ajouter
        #FQ 52777 - la valeur fiscale est modifiée uniquement
        #si la ligne porte sur le même article de la réception
        If [F:PIDW]ITMREF = [F:PTD]ITMREF
          WFISAMTDTA += WMONTANT
        Endif
        WSTAAMTDTA += WMONTANTVS
      Elsif [F:PIDW]INVTYP = 2
        #--- Si Avoir, le montant vient en déduction
        #FQ 52777 - la valeur fiscale est modifiée uniquement
        #si la ligne porte sur le même article de la réception
        If [F:PIDW]ITMREF = [F:PTD]ITMREF
          WFISAMTDTA -= WMONTANT
        Endif
        WSTAAMTDTA -= WMONTANTVS
      Endif
    Next :# du For [PIDW]
    If WPASVALO : Break : Endif
  Next :# du For [PIDC]
  If WPASVALO : Return : Endif
Endif
#--- fin traitement avoirs/factures complémentaires


Return
#######################################################################
# Achats : Retours fournisseurs
#----------------------------------------------------------------------
$EEC_PNH

WUPDFIL="PNH" : WFLO=2 :#EXPEDITION
WUPDTYP=21    :# Expédition Achats - utilisé dans les points d'entrée (conformité versions antérieures)

Call ECR_TRACE(string$(70,"-"),0) From GESECRAN
Call ECR_TRACE(mess(627,197,1),0) From GESECRAN
Call ECR_TRACE(string$(70,"-"),0) From GESECRAN

CRITERE  = '[F:PNH]RTNDAT<=[M]DEBDAT'                : # Date retour < ou = a selection
CRITERE += ' & [F:PNH]CPY=[M]CPY'
CRITERE += ' & [F:PNH]CFMFLG = 2'                    : # Retour validés

If [M]REG=2
  CRITERE += '& ([F:PNH]EECNUMDEB=[M]EECNUMDEB | [F:PNH]EECNUMDEB=0)'
Else
  CRITERE += '& [F:PNH]EECNUMDEB=0'
Endif

Gosub ALIFILSUP

For [PNH]PNH2 Where (evalue(CRITERE) & evalue(FILSUP))
  Gosub CTL_EEC
  If WOK=0 : Goto NEXT_PNH : Endif

  [L]W_ISEMPTY_EEC_SCH_NAT = 0 #--CPO DM 105661 Ajout de la sous-traitance
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacement du test valeurs vides EECSCH et EECNAT après le parcours des lignes
  #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
#  If [F:PNH]EECSCH="" and [F:PNH]EECNAT=""
#    If [M]PRNULREGNA=2
#      Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-mess(746,197,1),0) From GESECRAN
#    Endif
#    Goto NEXT_PNH
#  Endif
  #--/

  #--- Prise en compte du paramètre permettant de retarder la déclaration des
  #--- retours en attente avoir
  If [F:PNH]INVFLG <> 3 :# Si non soldé (le flag est=3 "Facturé totalement" si le retour est soldé, quelque soit la facturation)
   # FQ 52820 - sauf inter-sites
   If ([F:PNH]BETFCY<>2 or [F:PNH]BETCPY=2)
    If [F:PNH]RTNDAT>[M]DEBDAT-GEECEXTDELA
      #--CPO 74679 Amélioration de la trace
      WMESS_CODE=2 : WMESS_TRACE=mess(735,197,1)-[F:PNH]PNHNUM : Gosub MESS_TRACE
      #--CPO
      Goto NEXT_PNH
    Endif
   Endif
  Endif
  #--- Type de mouvement
  WMVT=14 :# "Retour fournisseur"
  #--- On génère une DEB pour chaque ligne, la transaction sera gérée par le détail
  # Call DEBTRANS From GLOCK
  # Trbegin [DEB]
  #--- Prise en compte des éléments de chaque ligne de détail
  Gosub EEC_UN_PNH
  If WOKDETAIL=0 or WOK=0 : Goto NEXT_PNH : Endif
  # Commit
$NEXT_PNH
Next

Return
#----------------------------------------------------------------------
$EEC_UN_PNH
WOK       = 1
WOKDETAIL = 0 :# Si au moins un détail à donné lieu à une DEB =1  => utilisé pour MAJ EECNUMDEB de l'entête retour
W_COMPOSE_RETOUR_RECP = 0 #--CPO DM 105661 Ajout de la sous-traitance
#--- Chargement du masque DEBGEN
nolign=0
For [PND] Where PNHNUM=[F:PNH]PNHNUM
  nolign =1
  [L]W_ISEMPTY_EEC_SCH_NAT = 0 #--CPO DM 105661 Ajout de la sous-traitance
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacement du test valeurs vides EECSCH et EECNAT après le parcours des lignes
  #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
  If [F:PNH]EECSCH="" and [F:PNH]EECNAT=""
    #--Si, après parcours des lignes, le flag est toujours à 1, on passe à la pièce suivante
    [L]W_ISEMPTY_EEC_SCH_NAT = 1
  Endif
  #--/

  #--CPO 106690 Cas de deux lignes de type "divers", n'ayant pas d'article et qui se suivent
  If [F:PND]ITMREF="" :  Goto NEXT_EEC_UN_PNH : Endif
  #--/
  If [F:ITM]ITMREF <> [F:PND]ITMREF
    Read [F:ITM]ITM0=[F:PND]ITMREF
    If fstat : Raz [F:ITM] : Goto NEXT_EEC_UN_PNH : Endif
  Endif
  #--- Si l'article n'est pas "Soumis à la DEB", on saute la ligne de détail
  If [F:ITM]EECGES <> 2
    #--CPO 74679 Amélioration de la trace
    WMESS_CODE=3 : WMESS_TRACE=mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN)-[F:ITM]ITMREF : Gosub MESS_TRACE
    #--CPO
    Goto NEXT_EEC_UN_PNH
  Endif

  #--CPO DM 105661 Ajout de la sous-traitance
  If find([F:PND]LINTYP,3,4)>0
    #--seulement si le composé du doc origine est aussi présent sur le retour
    If W_COMPOSE_RETOUR_RCP=1
      #---on extrait uniquement les lignes de type "Nomenclature composé"
      #---et celles "Standard"
      #--CPO 74679 Amélioration de la trace
      WMESS_CODE=4 : WMESS_TRACE=mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN) : Gosub MESS_TRACE
      #--CPO
      Goto NEXT_EEC_UN_PNH
    Endif
  Elsif [PND]LINTYP=2
    If [PND]PTHNUM<>""
      #--Ligne de composé ayant comme origine une réception
      W_COMPOSE_RETOUR_RCP=1
    Else
      #--Nous avons rencontré une ligne de composé, mais non liée à une réception
      W_COMPOSE_RETOUR_RCP=0
    Endif
  Else
    #--Nous avons rencontré une ligne normale, on remet à 0 le flag composé
    W_COMPOS_RETOUR_RCP=0
  Endif
  #--/

  #--- Chargement du masque avec les éléments de la ligne

  #FQ 56398 (suite de 51074) - Point d'entrée pour gérer des contrôles à la ligne
  Local Integer SAUVGPE     : SAUVGPE=GPE : GPE=0
  #La variable GPE permet d'accepter ou de refuser la ligne
  # 0 -> la ligne est acceptée
  # 1 -> la ligne est refusée, on passe à la suivante
  GPOINT="DEBCTLLIG" : Gosub ENTREE From EXEFNC
  If GPE : GPE=SAUVGPE : Goto NEXT_EEC_UN_PNH : Endif
  #FQ 56398

  Gosub DEBG_PNH
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacement du test valeurs vides EECSCH et EECNAT après le parcours des lignes
  #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
  If [L]W_ISEMPTY_EEC_SCH_NAT = 1
    #--Si, après parcours des lignes, le flag est toujours à 1, on passe à la pièce suivante
    #--Il passe à 0 si au moins une ligne permet d'alimenter les régimes/natures spéciaux
      If [M]PRNULREGNA=2
        Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-num$([F:PND]PNDLIN)-[F:PND]ITMREF-mess(746,197,1)
&    -mess(744,197,1)-mess(745,197,1),0) From GESECRAN
      Endif
      WOK=0
  Endif
  #--/
  If WOK =0 : Goto NEXT_EEC_UN_PNH : Endif

  # Afin de retrouver les bons numéros en cas de rollback
  WOLDLININT = WNOLININT
  WOLDLINEXP = WNOLINEXP
  Trbegin [DEB] :# A partir d'ici, tout retour suite à erreur doit prévoir le rollback
  #--- Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
  Raz WNOLINVALO
  Raz WVCRNUMVALO
  Raz WVCRLINVALO
  #--CPO DM 105661 Ajout de la sous-traitance
  If WMVT=22
    Gosub DEBG_DTA_PNH_SST From FUNDEBB
  Else
  #--/
    #--- Valorisation selon Avoirs sur retours
    If [F:PND]LININVFLG = 2                          :#si ligne retour facturée (existe Avoir sur Retour)
      Raz WFACDTAAMT, WFACDTAAMTVS, WFISAMTDTA, WSTAAMTDTA, W_NUM, WPASVALO, WMAJ, WTRNOK
      #--- valorisation avec les lignes facturées
      For [PID]PID1 Where TYPORI=3 & NUMORI=[F:PND]PNHNUM & LINORI=[F:PND]PNDLIN & INVTYP = 2
        If [F:PIH]NUM <> [F:PID]NUM
          Read [PIH]PIH0 = [F:PID]NUM
          If fstat : WPASVALO = 1 : Raz [F:PIH] : Break : Endif
        Endif
        #--- Uniquement les factures validées
        # si une des factures n'est pas validée, il ne faut pas valoriser, car les montants peuvent changer
        If [F:PIH]STA <> 3 : WPASVALO = 1 : Break : Endif
        #--- Prise en compte des éléments de facturation
        Gosub DEBG_DTA_PNH
        If WPASVALO : Break : Endif
        # Au moins une pièce parcourue
        WNOLINVALO = 1
      Next
      If WPASVALO = 0 and WNOLINVALO = 1
        WNOLINVALO = 0
        #--- Valeur fiscale valorisée avec les éléments de l'avoir
        If WFISAMTDTA <> 0 and WFISAMTDTA <> [M:DEBG]FISAMT(nolign-1)
          WMAJ = 1
        Endif
        #--- Valeur statistique valorisée avec les éléments de l'avoir
        If WSTAAMTDTA <> 0 and WSTAAMTDTA <> [M:DEBG]STAAMT(nolign-1)
          WMAJ = 1
        Endif
        # If WMAJ
          If WMAJ
            #--- Mise à jour LINEECFLG des détails avoirs pris en compte
            Update [PID] Where TYPORI=3 & NUMORI=[F:PND]PNHNUM & LINORI=[F:PND]PNDLIN With LINEECFLG = 2
            If fstat : Call FSTA("PID") From GLOCK : WTRNOK = 1 : Endif
          Endif
          #--- Mise à jour EECNUMDEB des entêtes avoirs pris en compte
          If WTRNOK = 0
            For [PID]PID1 Where TYPORI=3 & NUMORI=[F:PND]PNHNUM & LINORI=[F:PND]PNDLIN
              If WMAJ
                Update [PIH] Where NUM=[F:PID]NUM With EECNUMDEB=[M]EECNUMDEB
                If fstat : Call FSTA("PIH") From GLOCK : WTRNOK = 1 : Break : Endif
              Endif
              #--- Renseignement des pièces prises en compte lors de la valorisation
              #--CPO 75397 Indice incorrect
              If nolign > NBLIGNESDET
                Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                Call ECR_TRACE(mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN),1) From GESECRAN
                WTRNOK = 1
                Break
              Endif
              #--CPO
              WINDICE=find([F:PID]NUM,WVCRNUMVALO(0..14,nolign-1))
              If WINDICE<=0 or (WINDICE>0 and !find([F:PID]PIDLIN,WVCRLINVALO(WINDICE-1,nolign-1)))
                WNOLINVALO += 1
                If WNOLINVALO > 15 or nolign > NBLIGNESDET :#CPO 75397 100
                  Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                  Call ECR_TRACE(mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN),1) From GESECRAN
                  WTRNOK = 1
                  Break
                Endif
                WVCRNUMVALO(WNOLINVALO-1,nolign-1)=[F:PID]NUM
                WVCRLINVALO(WNOLINVALO-1,nolign-1)=[F:PID]PIDLIN
              Endif
            Next
          Endif
          If WTRNOK = 1
            Gosub AB_DEB
            WOK = 0
            Goto NEXT_EEC_UN_PNH
          Else
            #--- Valeur fiscale valorisée avec les éléments de l'avoir
            If WFISAMTDTA <> 0 and WFISAMTDTA <> [M:DEBG]FISAMT(nolign-1)
              [M:DEBG]FISAMT(nolign-1) = WFISAMTDTA
              [M:DEBG]LINVALOFLG(nolign-1)=2
            Endif
            #--- Valeur statistique valorisée avec les éléments de l'avoir
            If WSTAAMTDTA <> 0 and WSTAAMTDTA <> [M:DEBG]STAAMT(nolign-1)
              [M:DEBG]STAAMT(nolign-1) = WSTAAMTDTA
              [M:DEBG]LINVALOFLG(nolign-1)=2
            Endif
          Endif
        # Endif :# fin MAJ
      Endif
    Endif
  Endif #--CPO DM 105661 Ajout de la sous-traitance

  #--CPO DM 105661 Ajout de la sous-traitance
  If WTRNOK=1 or WOK=0
    Gosub AB_DEB
    WOK = 0
    Goto NEXT_EEC_UN_PNH
  Endif
  #--/

  #--- Ecriture des éléments du masque DEBGEN dans le fichier DEB
  Gosub EEC_DEBGEN
  If WOK = 0 : Gosub AB_DEB : Goto NEXT_EEC_UN_PNH : Endif
  #--- On met à jour le flag LINEECFLG de la ligne suite à la prise en compte
  If [F:PNH]PNHNUM <> ""
    W_NUMPIECE   = [F:PNH]PNHNUM
    W_NUMLINPIEC = [F:PND]PNDLIN
    Update [PND] Where PNHNUM = W_NUMPIECE and PNDLIN = W_NUMLINPIEC With LINEECFLG = 2
    If fstat
      Call FSTA("PND") From GLOCK
      Gosub AB_DEB
      WOK = 0
      Goto NEXT_EEC_UN_PNH
    Endif
    If WOKDETAIL = 0
      #--- Maj no traitement dans la pièce de retour
      #--- uniquement si eecnumdeb=0
      If [F:PNH]EECNUMDEB=0
        Update [PNH] Where PNHNUM = W_NUMPIECE With EECNUMDEB = [M]EECNUMDEB
        If fstat
          Call FSTA("PNH") From GLOCK
          Gosub AB_DEB
          WOK = 0
          Goto NEXT_EEC_UN_PNH
        Endif
      Endif
    Endif
    Raz W_NUMPIECE
    Raz W_NUMLINPIEC
  Endif
  #--- Si on arrive jusqu'ici, le détail a été pris en compte
  WOKDETAIL = 1

  Call ECR_TRACE(mess(627,197,1)-[F:PNH]PNHNUM-num$([F:PND]PNDLIN)-mess(296,197,1),0) From GESECRAN

  Commit

$NEXT_EEC_UN_PNH
Next
If WOK=0       : Return : Endif
If WOKDETAIL=0 : Return : Endif

Return
#######################################################################
#Remplissage du masque de génération avec les éléments liés aux pièces de retour
#######################################################################
$DEBG_PNH
#ATTENTION : chaque ligne de retour peut avoir sa propre devise
#Comme le masque de génération n'a qu'un seul CURDOC pour l'ensemble des lignes,
#il faut, pour chaque ligne, créer le masque et le sauvegarder.
WOK=1
If nolign=1
  Raz [M:DEBG]
  [M:DEBG]CPY       = [M:DIA]CPY
  [M:DEBG]CUR       = [F:CPY]ACCCUR
  [M:DEBG]EECNUMDEB = [M:DIA]EECNUMDEB
  [M:DEBG]DEBDAT    = [M:DIA]DEBDAT
  [M:DEBG]VCRTYP    = 8
  [M:DEBG]VCRNUM    = [F:PNH]PNHNUM
  [M:DEBG]DAT       = [F:PNH]RTNDAT
  #--- Chaque ligne a sa propre devise
  [M:DEBG]CURDOC    = [F:PND]NETCUR :#CPRCUR
  [M:DEBG]BPRNUM    = [F:PNH]BPSINV
  If [F:PNH]EECNUM<>""
    [M:DEBG]EECNUM = [F:PNH]EECNUM
  Else
    #--- N° d'identif CEE du fournisseur facturant
    If [F:BPR]BPRNUM <> [F:PNH]BPSINV
      Read [BPR]BPR0=[F:PNH]BPSINV
      If fstat : Raz [F:BPR] : Endif
    Endif
    [M:DEBG]EECNUM  = [F:BPR]EECNUM
  Endif
  #--- Cas du n° de TVA issu du pays expéditeur
  If [M:DEBG]EECNUM <> ""
    If left$([M:DEBG]EECNUM,2)=W_EECCRYFROM or left$([M:DEBG]EECNUM,3)=W_EECCRYFROM
      Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM,0) From GESECRAN
      Call ECR_TRACE(mess(740,197,1),0) From GESECRAN :# "Numéro de TVA issu du pays expéditeur"
    Endif
  Endif
Endif
If [F:PND]PNHFCY<>""
  If [F:FCY]FCY<>[F:PND]PNHFCY
    Read [FCY]FCY0=[F:PND]PNHFCY
    If fstat : Raz [F:FCY] : Endif
  Endif
  Read [BPA]BPA0=3;[F:PND]PNHFCY;[F:FCY]BPAADD
  If fstat : Raz [F:BPA] : Endif
  If [F:BPA]POSCOD<>""
    [M:DEBG]REG (nolign-1) = left$([F:BPA]POSCOD,2)
  Endif
Endif
#--- Site de stockage
[M:DEBG]STOFCY  (nolign-1) = [F:PNH]PNHFCY
[M:DEBG]CRYFCY  (nolign-1) = W_EECCRYFROM
#--- Etat fédéral
If dim([M:DEBG]STAFED)>0
  Raz WSTAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
  Read [ITF]ITF0=[F:PND]ITMREF;[F:PNH]PNHFCY
  If fstat : Raz [F:ITF] : Endif
  If dim([F:ITF]STAFED)<>0 and [F:ITF]STAFED<>""
    WSTAFED=[F:ITF]STAFED #[M:DEBG]STAFED(nolign-1)=[F:ITF]STAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
  Else
    If dim([F:ITM]STAFED)>0 and [F:ITM]STAFED<>""
      WSTAFED=[F:ITM]STAFED #[M:DEBG]STAFED(nolign-1)=[F:ITM]STAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
    Endif
  Endif
  Gosub SET_M_DEBG_STAFED From FUNDEBA # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
Endif
#---
[M:DEBG]VCRLIN  (nolign-1) = [F:PND]PNDLIN
[M:DEBG]FLO     (nolign-1) = 2
[M:DEBG]ITMREF  (nolign-1) = [F:PND]ITMREF
[M:DEBG]ITMDES1 (nolign-1) = [F:PND]ITMDES1
[M:DEBG]CUSREF  (nolign-1) = [F:ITM]CUSREF
[M:DEBG]EECNAT  (nolign-1) = [F:PNH]EECNAT
[M:DEBG]EECSCH  (nolign-1) = [F:PNH]EECSCH
If W_EECCRYFFW<>""
  [M:DEBG]DESCRY (nolign-1) = W_EECCRYFFW
Else
  [M:DEBG]DESCRY (nolign-1) = W_EECCRYTO
Endif
#Pas de pays d'origine pour les flux d'expédition
#If [F:PND]ORICRY <> ""
#  LCRY=[F:PND]ORICRY
#  Gosub LEC_TCY
#  [M:DEBG]ORICRY(nolign-1)=[F:TCY]ISO
#Else
#  #--- Le pays d'origine pour le retour est le pays ORICRY de la ligne de réception
#  If [F:PND]PTHNUM <> "" and [F:PND]PTDLIN > 0
#    Read [F:PTD]PTD0=[F:PND]PTHNUM;[F:PND]PTDLIN
#    If fstat : Raz [F:PTD] : Endif
#    If !fstat and [F:PTD]ORICRY <> ""
#      LCRY=[F:PTD]ORICRY
#      Gosub LEC_TCY
#      [M:DEBG]ORICRY(nolign-1)=[F:TCY]ISO
#    Endif
#  Endif
#Endif

#Issue X3-124702 - 2019-03-12 by VAVIL
If func TRTLECLEG.FGETLEG([M:DEBG]CPY,"T") ="POR"
LCRY=[F:FCY]CRY
Gosub LEC_TCY
If [F:TCY]EECFLG=2 & [F:TCY]EECCOD<>""
  [M:DEBG]ORICRY(nolign-1)=[F:TCY]EECCOD
Else
  [M:DEBG]ORICRY(nolign-1)=[F:TCY]ISO
Endif
Endif
#Issue end X3-124702

#--- Sur les retours, nous pouvons renseigner les unités de poids et le poid unitaire
# Nous testons ci ces derniers sont renseignés, avant de les chercher dans l'article
If [F:PND]UNTWEI <> 0
  If toupper(left$([F:PND]WEU,2))="KG"
   # Issue X3-36119 - 2017-05-05 by CPO : (SAM 122067) Weight declared on CEE Customs doc
   #[M:DEBG]NETMAS (nolign-1) = [F:PND]UNTWEI*[F:PND]QTYSTU
    [M:DEBG]NETMAS (nolign-1) = [F:PND]UNTWEI*[F:PND]QTYUOM
   # End issue 122067
  Else
    I=find("KG",GUNITE(1..GDIMUNT))
    If I=0 I=find("Kg",GUNITE(1..GDIMUNT)) Endif
    If I=0 I=find("kg",GUNITE(1..GDIMUNT)) Endif
    If I<>0
      # Issue X3-36119 - 2017-05-05 by CPO : (SAM 122067) Weight declared on CEE Customs doc
      #Read [TCO]TCO0=[F:PND]WEU;GUNITE(I)
      #If !fstat [M:DEBG]NETMAS (nolign-1) = [F:PND]UNTWEI*[F:PND]QTYSTU*[F:TCO]COEUOM Endif
      [M:DEBG]NETMAS (nolign-1) = [F:PND]UNTWEI*[F:PND]QTYUOM
      Call CONVERT_QTY ([F:PND]WEU,GUNITE(I),[M:DEBG]NETMAS (nolign-1)) From TRTX3
      # End issue 122067
    Endif
  Endif
Elsif [F:ITM]ITMWEI<>0
  If toupper(left$([F:ITM]WEU,2))="KG"
    [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:PND]QTYSTU
  Else
    I=find("KG",GUNITE(1..GDIMUNT))
    If I=0 I=find("Kg",GUNITE(1..GDIMUNT)) Endif
    If I=0 I=find("kg",GUNITE(1..GDIMUNT)) Endif
    If I<>0
      # Issue X3-36119 - 2017-05-05 by CPO : (SAM 122067) Weight declared on CEE Customs doc
      # Read [TCO]TCO0=[F:ITM]WEU;GUNITE(I)
      # If !fstat [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:PND]QTYSTU*[F:TCO]COEUOM Endif
      [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:PND]QTYSTU
      Call CONVERT_QTY ([F:ITM]WEU,GUNITE(I),[M:DEBG]NETMAS (nolign-1)) From TRTX3
      # End issue 122067
    Endif
  Endif
Endif

If [F:ITM]EEU<>"" & [F:ITM]EEUSTUCOE<>0
  [M:DEBG]EECUNT (nolign-1) =[F:PND]QTYSTU/[F:ITM]EEUSTUCOE
Endif
[M:DEBG]EECTRN  (nolign-1) = [F:PNH]EECTRN
[M:DEBG]EECICT  (nolign-1) = [F:PNH]EECICT
[M:DEBG]EECLOC  (nolign-1) = [F:PNH]EECLOC
#--- Calcul de la valeur fiscale
#--- Calcul de la valeur statistique
#--- Prise en compte des éléments de facturation : en V6 la valorisation n'est pas faite sur les retours
#--- Répartition sur chaque ligne au prorata des montants
[M:DEBG]FISAMT(nolign-1) = [F:PND]LINAMT
#--- Si le montant de la ligne est nul, on utilise le prix de revient, si le paramétrage le permet
#--CPO DM 105661 Ajout de la sous-traitance
#--WMVT est initialisé en dehors du if
Raz WMVT
WMVT=14                                            :# Retour fournisseur
If [F:PND]LINCAT=2 : WMVT=23 : Endif               :# Retour fournisseur matière pour sous-traitance
#--Uniquement si lié à un composé provenant d'une réception
If [F:PND]PTHNUM <> "" and [F:PND]PTDLIN > 0
  Read [F:PTD]PTD0=[F:PND]PTHNUM;[F:PND]PTDLIN
  If fstat : Raz [F:PTD] : Endif
  If [F:PTD]LINTYP=2
    W_COMPOSE_RETOUR_RCP=1
    WMVT=22                                        :# Retour fournisseur produit fini sous-traitance
  Endif
Endif

Raz WTROUVE
Raz WVALSTO
If find(WMVT,22,23)>0
  Call FLUX_REGNAT(WMVT,[F:PNH]PNHFCY,W_CRYFROM,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
  If WTROUVE and (WMVT=22 or WMVT=23)
    If (GBIDC2<>"" or GBIDC3<>"")
      [M:DEBG]EECNAT  (nolign-1) = GBIDC3
      [M:DEBG]EECSCH  (nolign-1) = GBIDC2
      Call ECR_TRACE(mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN),0) From GESECRAN
      # Retour fournisseur produit fini sous-traitance : le Régime CEE et/ou la Nature ont été modifiés
      # Retour fournisseur matières pour sous-traitance : le Régime CEE et/ou la Nature ont été modifiés
      Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(752,197,1),0) From GESECRAN
    Else
      Call ECR_TRACE(mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN),0) From GESECRAN # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG and error if setup non found/inactive
      Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(911,197,1),1) From GESECRAN # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG and error if setup non found/inactive
      #--Pas de paramètrage éffectué
      WOK=0 : Return
    Endif
  Else
    # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG and error if setup non found/inactive
    Call ECR_TRACE(mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN),0) From GESECRAN
    Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(911,197,1),1) From GESECRAN
    WOK=0 : Return
    # End issue X3-131291
  Endif
Endif
#--/
#--CPO DM 105661 Ajout de la sous-traitance
#--Déplacement du test valeurs vides de EECSCH et EECNAT
#--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
#--- Si Régime et Nature sont vides, la ligne n'est pas extraite
If [M:DEBG]EECSCH(nolign-1)<>"" or [M:DEBG]EECNAT(nolign-1)<>""
  [L]W_ISEMPTY_EEC_SCH_NAT=0
Else
  #--On passe à la ligne suivante
  WOK=0 : Return
Endif
#--/

#--CPO DM 105661 Ajout de la sous-traitance
If WMVT=22
  Gosub DEBG_PNH_SST From FUNDEBB
  If OK=0 : Return : Endif
Else
#--/
  If [M:DEBG]FISAMT(nolign-1)<=0
    #--- Si le montant net de la ligne est 0, on prend le prix du mouvement
    #--- Ce dernier est libéllé dans la devise figurant dans "CPRCUR", est porte sur la quantité en UStock
    #--- On tient compte du paramétrage de la valeur stock du flux
    #--CPO DM 105661 Ajout de la sous-traitance
    #--Possible appel avant
  #  Raz WMVT
  #  WMVT=14                                            : # Retour fournisseur
  #  Raz WTROUVE
  #  Raz WVALSTO
  #  Call FLUX_REGNAT(WMVT,[F:PNH]PNHFCY,W_CRYFROM,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
    If WTROUVE=0
      Raz WVALSTO
      Call FLUX_REGNAT(WMVT,[F:PNH]PNHFCY,W_CRYFROM,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
    Endif
    If WTROUVE and WVALSTO=2
      [M:DEBG]FISAMT(nolign-1) = [F:PND]QTYSTU*[F:PND]CPR
    Else
      #--- Il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes
      Raz JL0,JL1
      #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
      #JL0=find([F:PNH]EECSCH,REG_CODE)
      #JL1=find([F:PNH]EECNAT,NAT_CODE)
      #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
      #--CPO DM 105661 Ajout de la sous-traitance
      #--Il faut utiliser les infos de M:DEBG
      #Call LEC_TSC_LEG(GCURLEG,[F:PNH]EECSCH,JL0) From TRTLECLEG
      #If JL0>0 : Raz [F:TSC] : Endif
      #Call LEC_TEC_LEG(GCURLEG,[F:PNH]EECNAT,JL1) From TRTLECLEG
      #If JL1>0 : Raz [F:TEC] : Endif
      Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
      If JL0>0 : Raz [F:TSC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
      If JL1>0 : Raz [F:TEC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      #--/
      If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
      #--/
        [M:DEBG]FISAMT(nolign-1) = [F:PND]QTYSTU*[F:PND]CPR
      Endif
    Endif
    If [M:DEBG]FISAMT(nolign-1)>0
      If [F:PND]CPRCUR <> [F:PND]NETCUR
        #--- Il faut convertir le montant dans la devise du document
        WFISAMT=[M:DEBG]FISAMT(nolign-1)
        Raz STAT
        Call CONVERT([F:PND]CPRCUR,[F:PND]NETCUR,WCUR,GEECTYPCUR,[F:PND]RTNDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
        If STAT
          WOK=0
          Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-mess(71,199,1),1) From GESECRAN
          Return
        Endif
      Endif
    Endif
  Endif

  [M:DEBG]STAAMT(nolign-1)  = [M:DEBG]FISAMT(nolign-1)
  If [F:PND]EECINCRAT <> 0
    [M:DEBG]STAAMT(nolign-1) = [M:DEBG]STAAMT(nolign-1)*[F:PND]EECINCRAT
  Endif
  #--- Conversion de la valeur fiscale, le cas échéant
  If [F:PND]NETCUR <> WCUR
    WFISAMT=[M:DEBG]FISAMT(nolign-1)
    Raz STAT
    Call CONVERT([F:PND]NETCUR,WCUR,WCUR,GEECTYPCUR,[F:PND]RTNDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
    If STAT
      Raz STAT
      # Nous devons chercher le type de cours renseigné sur la pièce de livraison, le cas échéant
      If [F:PND]PTHNUM <> ""
        If [F:PTH]PTHNUM <> [F:PND]PTHNUM
          Read [F:PTH]PTH0=[F:PND]PTHNUM
          If fstat
            Raz [F:PTH] : WOK=0
            Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-mess(71,199,1),1) From GESECRAN
            Return
          Endif
        Else
          Call CONVERT([F:PND]NETCUR,WCUR,WCUR,[F:PTH]CHGTYP,[F:PND]RTNDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
          If STAT
            WOK=0
            Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-mess(71,199,1),1) From GESECRAN
            Return
          Endif
        Endif
      Else
        WOK=0
        Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-mess(71,199,1),1) From GESECRAN
        Return
      Endif
    Endif
  Endif
  #--- Conversion de la valeur statistique, le cas échéant
  If [F:PND]NETCUR <> WCUR
    WSTAAMT=[M:DEBG]STAAMT(nolign-1)
    Raz STAT
    Call CONVERT([F:PND]NETCUR,WCUR,WCUR,GEECTYPCUR,[F:PND]RTNDAT,WSTAAMT,[M:DEBG]STAAMT(nolign-1),STAT) From TRTDEV
    If STAT
      Raz STAT
      # Nous devons chercher le type de cours renseigné sur la pièce de livraison, le cas échéant
      If [F:PND]PTHNUM <> ""
        If [F:PTH]PTHNUM <> [F:PND]PTHNUM
          Read [F:PTH]PTH0=[F:PND]PTHNUM
          If fstat
            Raz [F:PTH] : WOK=0
            Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-mess(71,199,1),1) From GESECRAN
            Return
          Endif
        Else
          Call CONVERT([F:PND]NETCUR,WCUR,WCUR,[F:PTH]CHGTYP,[F:PND]RTNDAT,WSTAAMT,[M:DEBG]STAAMT(nolign-1),STAT) From TRTDEV
          If STAT
            WOK=0
            Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-mess(71,199,1),1) From GESECRAN
            Return
          Endif
        Endif
      Else
        WOK=0
        Call ECR_TRACE(mess(735,197,1)-[F:PNH]PNHNUM-mess(71,199,1),1) From GESECRAN
        Return
      Endif
    Endif
  Endif
#  #--CPO DM 105661 Ajout de la sous-traitance
#  #--Les retours de produits finis sont valorisés avec la réception
#  #--Afin d'être cohérents, on valorise égalment les autres types de retours avec les réceptions, le cas échéant
#  #-----------------------------------------------
#  If [F:PND]PTHNUM<>"" and [PND]PTDLIN<>0
#    If [F:PTH]PTHNUM<>[F:PND]PTHNUM
#      Read [F:PTH]PTH0=[PND]PTHNUM
#      If fstat<>0 : Raz [F:PTH] : Endif
#      #--On ne valorise que les éléments répartis
#      #--Re-calcul déslors qu'il y a changement de réception
#      WNUMEROPIECE = [F:PTH]PTHNUM
#      Raz WTOTDTA,WTOTDTAVS
#      Gosub ACH_TOTDTA From FUNDEB
#      WINVDTAAMT2   = WTOTDTA
#      WINVDTAAMTVS2 = WTOTDTAVS
#      Raz WNUMEROPIECE
#    Endif
#
#    If [F:PTD]PTHNUM<>[F:PND]PTHNUM or [F:PTD]PTDLIN<>[F:PND]PTDLIN
#      Read [PTD]PTD0=[PND]PTHNUM;[PND]PTDLIN
#      If fstat<>0 : Raz [F:PTD] : Endif
#    Endif
#
#    Raz  WTMP_FISAMT,W_MTTHTLINVS
#
#    If [F:PTD]QTYSTU<>0
#      WTMP_FISAMT = ([F:PTD]LINAMT*[F:PND]QTYSTU)/[F:PTD]QTYSTU
#    Endif
#    If WTMP_FISAMT<=0
#      #--- Si le montant net de la ligne est 0, on prend le prix du mouvement
#      #--- Ce dernier est libéllé dans la devise figurant dans "CPRCUR", est porte sur la quantité en UStock
#      #--- On tient compte du paramétrage de la valeur stock du flux
#      If WTROUVE and WVALSTO=2
#        If [F:PTD]QTYSTU<>0
#          WTMP_FISAMT = (([F:PTD]QTYSTU*[F:PTD]CPR)*[F:PND]QTYSTU)/[F:PTD]QTYSTU
#        Endif
#      Else
#        #--- Il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes
#        Raz JL0,JL1
#        Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
#        If JL0>0 : Raz [F:TSC] : Endif
#        Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
#        If JL1>0 : Raz [F:TEC] : Endif
#        If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
#          If [F:PTD]QTYSTU<>0
#            WTMP_FISAMT = (([F:PTD]QTYSTU*[F:PTD]CPR)*[F:PND]QTYSTU)/[F:PTD]QTYSTU
#          Endif
#        Endif
#      Endif
#      If WTMP_FISAMT>0
#        If [F:PTD]CPRCUR <> [F:PTH]CUR
#          #--- Il faut convertir le montant dans la devise du document
#          WFISAMT=WTMP_FISAMT
#          Raz STAT
#          Call CONVERT([F:PTD]CPRCUR,[F:PTH]CUR,WCUR,GEECTYPCUR,[F:PTH]NDEDAT,WFISAMT,WTMP_FISAMT,STAT) From TRTDEV
#          If STAT
#            Raz STAT
#            Call CONVERT([F:PTD]CPRCUR,[F:PTH]CUR,WCUR,[F:PTH]CHGTYP,[F:PTH]NDEDAT,WFISAMT,WTMP_FISAMT,STAT) From TRTDEV
#            If STAT
#              WOK=0
#              Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-mess(71,199,1),1) From GESECRAN
#              Return
#            Endif
#          Endif
#        Endif
#      Endif
#    Endif
#
#    #--- Prise en compte du taux de majoration CEE
#    If [F:PTD]EECINCRAT <> 0
#      W_MTTHTLINVS = WTMP_FISAMT*[F:PTD]EECINCRAT
#    Else
#      W_MTTHTLINVS = WTMP_FISAMT
#    Endif
#
#    # Attention :
#    # Chaque DISCRGAMTx sera pris en compte si l'élément de facturation duquel il provient a CLCDEB > 1
#    # De plus les éléments peuvent rentrer différement dans le calcul de la valeur fiscale et/ou de la valeur statistique
#    WPIECE       = "PTH"
#    WDETAILPIECE = "PTD"
#    Gosub ACH_TOTDISCRG
#    WFACDISCRG   = WTOTDISCRG
#    WFACDISCRGVS = WTOTDISCRGVS
#    Raz WPIECE : Raz WDETAILPIECE
#    # Si le total des lignes ne permet pas de proratiser,
#    # il faut prendre en compte les éléments déjà éclatés sur les lignes
#    [M:DEBG]FISAMT(nolign-1) = WTMP_FISAMT
#    [M:DEBG]STAAMT(nolign-1) = W_MTTHTLINVS
#    If [F:PTH]TOTLINAMT <> 0 and [F:PTD]QTYSTU <> 0
#      [M:DEBG]FISAMT(nolign-1) += (((WINVDTAAMT2  *[F:PTD]LINAMT)/[F:PTH]TOTLINAMT)*[F:PND]QTYSTU)/[F:PTD]QTYSTU
#      [M:DEBG]STAAMT(nolign-1) += (((WINVDTAAMTVS2*[F:PTD]LINAMT)/[F:PTH]TOTLINAMT)*[F:PND]QTYSTU)/[F:PTD]QTYSTU
#    Endif
#    #--On en prends que les éléments éclatés sur les lignes
#    If [F:PTD]QTYSTU <> 0
#      [M:DEBG]FISAMT(nolign-1) +=  (WFACDISCRG  *[F:PND]QTYSTU)/[F:PTD]QTYSTU
#      [M:DEBG]STAAMT(nolign-1) +=  (WFACDISCRGVS*[F:PND]QTYSTU)/[F:PTD]QTYSTU
#    Endif
#
#    Raz WINVDTAAMT, WINVDTAAMTVS
#
#    #--- Conversion de la valeur fiscale, le cas échéant
#    If [F:PTH]CUR <> WCUR
#      WFISAMT=[M:DEBG]FISAMT(nolign-1)
#      Raz STAT
#      Call CONVERT([F:PTH]CUR,WCUR,WCUR,GEECTYPCUR,[F:PTH]NDEDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
#      If STAT
#        Raz STAT
#        Call CONVERT([F:PTH]CUR,WCUR,WCUR,[F:PTH]CHGTYP,[F:PTH]NDEDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
#        If STAT
#          WOK=0
#          Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-mess(71,199,1),1) From GESECRAN
#          Return
#        Endif
#      Endif
#    Endif
#    #--- Conversion de la valeur statistique, le cas échéant
#    If [F:PTH]CUR <> WCUR
#      WSTAAMT=[M:DEBG]STAAMT(nolign-1)
#      Raz STAT
#      Call CONVERT([F:PTH]CUR,WCUR,WCUR,GEECTYPCUR,[F:PTH]NDEDAT,WSTAAMT,[M:DEBG]STAAMT(nolign-1),STAT) From TRTDEV
#      If STAT
#        Raz STAT
#        Call CONVERT([F:PTH]CUR,WCUR,WCUR,[F:PTH]CHGTYP,[F:PTH]NDEDAT,WSTAAMT,[M:DEBG]STAAMT(nolign-1),STAT) From TRTDEV
#        If STAT
#          WOK=0
#          Call ECR_TRACE(mess(735,197,1)-[F:PTH]PTHNUM-mess(71,199,1),1) From GESECRAN
#          Return
#        Endif
#      Endif
#    Endif
#  Endif
#  #--- Renseignement des pièces prises en compte lors de la valorisation
#  #--- Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
#  Raz WNOLINVALO
#  Raz WVCRNUMVALO
#  Raz WVCRLINVALO
#  If nolign > NBLIGNESDET
#    Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
#    Call ECR_TRACE(mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN),1) From GESECRAN
#  Else
#    WINDICE=find([F:PND]PTHNUM,WVCRNUMVALO(0..14,nolign-1))
#    If WINDICE<=0 or (WINDICE>0 and !find([F:PND]PTDLIN,WVCRLINVALO(WINDICE-1,nolign-1)))
#      WNOLINVALO += 1
#      If WNOLINVALO > 15 or nolign > NBLIGNESDET :#CPO 75397 100
#        Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
#        Call ECR_TRACE(mess(735,197,1)-[F:PND]PNHNUM-num$([F:PND]PNDLIN),1) From GESECRAN
#      Else
#        WVCRNUMVALO(WNOLINVALO-1,nolign-1)=[F:PND]PTHNUM
#        WVCRLINVALO(WNOLINVALO-1,nolign-1)=[F:PND]PTDLIN
#      Endif
#    Endif
#  Endif
  #-----------------------------------------------
  #--/
Endif #--CPO DM 105661 Ajout de la sous-traitance
If WOK=0 : Return : Endif #--CPO DM 105661 Ajout de la sous-traitance

[M:DEBG]NIV(nolign-1) = GNIVINT
[M:DEBG]AMTNOTINVL (nolign-1)= [F:PND]LINAMT
[M:DEBG]NBDEB = nolign

Return
#######################################################################
#Prise en compte des éléments de facturation présents sur les avoirs lièes aux retours
#dans le calcul de la valeur fiscale et/ou statistique,
#le cas échéant
#######################################################################
$DEBG_DTA_PNH
#--- Vérification si les factures ne font pas l'objet d'une autre déclaration
If [M]REG=2
  If ([F:PIH]EECNUMDEB <> 0 & [F:PIH]EECNUMDEB <> [M]EECNUMDEB) : WPASVALO = 1 : Return : Endif
Else
  If  [F:PIH]EECNUMDEB <> 0 : WPASVALO = 1 : Return : Endif
Endif
#--- Enregistrement PIV doit exister
If [F:PIV]NUM <> [F:PIH]NUM
  Read [PIV]PIV0=[F:PIH]NUM
  If fstat : WPASVALO = 1 : Raz [F:PIV] : Return : Endif
Endif
WFISAMT = [F:PID]AMTNOTLIN
#--- La prise en compte de EECINCRAT est faite ici
#--- car après il peut y avoir des éléments de facturation pris en compte uniquement dans la valeur statistique
#--- Pas de EECINCRAT dans le PID
#--- Nous devons le chercher dans la pièce de retour
If [F:PND]EECINCRAT <> 0
  WSTAAMT  = [F:PID]AMTNOTLIN*[F:PND]EECINCRAT
Else
  WSTAAMT  = [F:PID]AMTNOTLIN
Endif
If [F:PID]AMTNOTLIN=0
  #--- Si le montant net de la ligne est 0, on prend le prix du mouvement du retour
  #--- Ce dernier est libéllé dans la devise figurant dans "CPRCUR", est porte sur la quantité en UStock
  #--- On tient compte du paramétrage de la valeur stock du flux
  #Raz WMVT
  WMVT=14                                            : # Retour fournisseur
  Raz WTROUVE
  Raz WVALSTO
  Call FLUX_REGNAT(WMVT,[F:PNH]PNHFCY,W_CRYFROM,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
  If WTROUVE and WVALSTO=2
    WFISAMT = [F:PID]QTYSTU*[F:PND]CPR :# "Prix de revient" de la ligne de retour
  Else
    #--- Il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes
    Raz JL0,JL1
    #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
    #JL0=find([F:PNH]EECSCH,REG_CODE)
    #JL1=find([F:PNH]EECNAT,NAT_CODE)
    #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
    #--CPO DM 105661 Ajout de la sous-traitance
    #--Il faut utiliser les infos de M:DEBG
    #Call LEC_TSC_LEG(GCURLEG,[F:PNH]EECSCH,JL0) From TRTLECLEG
    #If JL0>0 : Raz [F:TSC] : Endif
    #Call LEC_TEC_LEG(GCURLEG,[F:PNH]EECNAT,JL1) From TRTLECLEG
    #If JL1>0 : Raz [F:TEC] : Endif
    Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
    If JL0>0 : Raz [F:TSC] : Endif
    # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
    If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
      Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
    Endif
    # End issue X3-131291
    Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
    If JL1>0 : Raz [F:TEC] : Endif
    # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
    If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
      Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
    Endif
    # End issue X3-131291
    #--/
    If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
    #--/
      WFISAMT = [F:PID]QTYSTU*[F:PND]CPR :# "Prix de revient" de la ligne de retour
    Endif
  Endif
  If WFISAMT > 0
    If [F:PIH]CUR <> [F:PND]CPRCUR
      WKMONTANT = WFISAMT
      Raz STAT
      Call CONVERT([F:PND]CPRCUR,[F:PIH]CUR,WCUR,GEECTYPCUR,[F:PIH]ACCDAT,WKMONTANT,WFISAMT,STAT) From TRTDEV
      If STAT
        Raz STAT
        Call CONVERT([F:PND]CPRCUR,[F:PIH]CUR,WCUR,[F:PIH]CURTYP,[F:PIH]ACCDAT,WKMONTANT,WFISAMT,STAT) From TRTDEV
        If STAT
          Call ECR_TRACE(mess(735,197,1)-[F:PIH]NUM-mess(71,199,1),1) From GESECRAN
          WPASVALO = 1 : Return
        Endif
      Endif
      If [F:PND]EECINCRAT <> 0
        WSTAAMT  = WFISAMT*[F:PND]EECINCRAT
      Else
        WSTAAMT  = WFISAMT
      Endif
    Endif
  Endif
Endif
#--- En-tête, nous calculons la somme des éléments de facturation de l'en-tête
#--- Eléments de facturation
#Les éléments de facturation sont présents sur les pieds des pièces autres que les factures
#Prise en compte des éléments non répartis sur les lignes : INVLINFLG = 1 ou 6,
#a condition qu'ils entrent dans le calcul de la valeur fiscale et/ou valeur statistique : CLCDEB = 2 ou 3
#puis répartition sur les lignes, au prorata des montants de chaque ligne
WNUMEROPIECE = [F:PID]NUM
W_VCRTYP=8 # Issue 110289 - 2015-08-12 by CPO : Invoicing elements when using same counter on different documents
Gosub ACH_TOTDTA
WFACDTAAMT   = WTOTDTA
WFACDTAAMTVS = WTOTDTAVS
Raz WNUMEROPIECE
Raz W_VCRTYP # Issue 110289 - 2015-08-12 by CPO
W_NUM = [F:PID]NUM
#--- Nous traitons la ligne de détail avoir liée au détail de retour
#--- Calcul de la somme des éléments de facturation répartis sur les lignes
# Attention :
# Chaque DISCRGAMTx sera pris en compte si l'élément de facturation duquel il provient a CLCDEB > 1
# De plus les éléments peuvent rentrer différement dans le calcul de la valeur fiscale et/ou de la valeur statistique
WPIECE       = "PIV"
WDETAILPIECE = "PID"
Gosub ACH_TOTDISCRG
WFACDISCRG   = WTOTDISCRG
WFACDISCRGVS = WTOTDISCRGVS
Raz WPIECE : Raz WDETAILPIECE
# Si le total des lignes ne permet pas de proratiser,
# il faut prendre en compte les éléments déjà éclatés sur les lignes
If [F:PIV]TOTLINAMT <> 0
  WFISAMT += ((WFACDTAAMT*[F:PID]AMTNOTLIN)/[F:PIV]TOTLINAMT) + WFACDISCRG
  WSTAAMT += ((WFACDTAAMTVS*[F:PID]AMTNOTLIN)/[F:PIV]TOTLINAMT) + WFACDISCRGVS
Else
  WFISAMT += WFACDISCRG
  WSTAAMT += WFACDISCRGVS
Endif
#--- Conversion de la valeur fiscale, le cas échéant
If [F:PIH]CUR <> WCUR
  WMONTANT = WFISAMT
  Raz STAT
  Call CONVERT([F:PIH]CUR,WCUR,WCUR,GEECTYPCUR,[F:PIH]ACCDAT,WMONTANT,WFISAMT,STAT) From TRTDEV
  If STAT
    Raz STAT
    Call CONVERT([F:PIH]CUR,WCUR,WCUR,[F:PIH]CURTYP,[F:PIH]ACCDAT,WMONTANT,WFISAMT,STAT) From TRTDEV
    If STAT
      Call ECR_TRACE(mess(742,197,1)-[F:PIH]NUM-mess(71,199,1),1) From GESECRAN
      WPASVALO = 1 : Return
    Endif
  Endif
Endif
#--- Conversion de la valeur statistique, le cas échéant
If [F:PIH]CUR <> WCUR
  WMONTANT = WSTAAMT
  Raz STAT
  Call CONVERT([F:PIH]CUR,WCUR,WCUR,GEECTYPCUR,[F:PIH]ACCDAT,WMONTANT,WSTAAMT,STAT) From TRTDEV
  If STAT
    Raz STAT
    Call CONVERT([F:PIH]CUR,WCUR,WCUR,[F:PIH]CURTYP,[F:PIH]ACCDAT,WMONTANT,WSTAAMT,STAT) From TRTDEV
    If STAT
      Call ECR_TRACE(mess(742,197,1)-[F:PIH]NUM-mess(71,199,1),1) From GESECRAN
      WPASVALO = 1 : Return
    Endif
  Endif
Endif
WFISAMTDTA += WFISAMT : Raz WFISAMT
WSTAAMTDTA += WSTAAMT : Raz WSTAAMT

Return
#- partie transférée dans FUNDEBA
#######################################################################
# Achats : Factures / Avoirs fournisseurs
#----------------------------------------------------------------------
#
#fin - partie transférée dans FUNDEBA
#-----------------------------------------------------------------------
$ACH_TOTDTA
#--Nombre instructions trop important
Gosub ACH_TOTDTA From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$ACH_TOTDISCRG
#--Nombre instructions trop important
Gosub ACH_TOTDISCRG From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#######################################################################
# Ventes : Livraisons clients
#          ( classique, pret, s/traitance, inter-sites, inter-societe )
#----------------------------------------------------------------------
$EEC_SDH

WUPDFIL="SDH" : WFLO=2
WUPDTYP=22 :# Expédition Ventes - utilisé dans les points d'entrée (conformité versions antérieures)

Call ECR_TRACE(string$(70,"-"),0) From GESECRAN
Call ECR_TRACE(mess(623,197,1),0) From GESECRAN
Call ECR_TRACE(string$(70,"-"),0) From GESECRAN

#--CPO 81821 Il faut tenir compte de la date d'expédition
#--pour les livraisons dont la facture intervient avant la date de livraison
#--Dans la boucle For [SDH] il faut tester également :
#--que la facture soit bien validée et que la date de la facture soit <= à la date DEB [M]DEBDAT !!
#CRITERE  = ' [F:SDH]DLVDAT<=[M]DEBDAT'               : # Date livraison < ou = a selection
CRITERE  = ' (([F:SDH]DLVDAT<=[M]DEBDAT) | ([F:SDH]SHIDAT<=[M]DEBDAT & [F:SDH]SIHNUM<>""))'               : # Date livraison < ou = a selection
#--/
CRITERE += ' & [F:SDH]CFMFLG=2'                      : # Validé
CRITERE += ' & [F:SDH]CPY=[M]CPY'

If [M]REG=2
  CRITERE += '& ([F:SDH]EECNUMDEB=[M]EECNUMDEB | [F:SDH]EECNUMDEB=0)'
Else
  CRITERE += '& [F:SDH]EECNUMDEB=0'
Endif

Gosub ALIFILSUP

For [SDH]SDH2 Where (evalue(CRITERE) & evalue(FILSUP))
  # Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
  Raz WVCRNUMVALO
  Raz WVCRLINVALO
  #--- Contrôle si la pièce doit être prise en compte pour la DEB
  Gosub CTL_EEC
  If WOK=0 : Goto NEXT_SDH : Endif
  #--CPO 81821 Il faut tenir compte de la date d'expédition
  #--pour les livraisons dont la facture intervient avant la date de livraison
  #--Dans la boucle For [SDH] il faut tester également :
  #--que la facture soit bien validée et que la date de la facture soit <= à la date DEB [M]DEBDAT !!
  If [F:SDH]SIHNUM<>"" and [F:SDH]DLVDAT>[M]DEBDAT
    #--lecture de la facture
    If [F:SIH]NUM<>[F:SDH]SIHNUM
      Read [F:SIH]SIH0=[F:SDH]SIHNUM
      If fstat : Raz [F:SIH] : WOK=0 : Goto NEXT_SDH : Endif
    Endif
    If [F:SIH]ACCDAT>[M]DEBDAT | [F:SIH]STA <> 3 : WOK=0 : Goto NEXT_SDH : Endif
    Raz [F:SIH]
  Endif
  #--/
  [L]W_ISEMPTY_EEC_SCH_NAT = 0 #--CPO DM 105661 Ajout de la sous-traitance
  If [F:SDH]LND=2 and [F:SDH]SIHNUM<>""
    #--- Si Livraison de prêt facturée, le Régime/Nature peuvent être pris depuis la Facture
    # Goto NEXT_SDH
    #--- Si livraison de prêt, le Régime doit être "29"
    #--- Si livraison de prêt facturée, et Régime 21, DEB sur livraison (vente à l'éssai)
    # If [F:SDH]EECSCH<>"29" & [F:SDH]EECSCH<>"21" : Goto NEXT_SDH : Endif
    #--- Si le Régime est le "21" (vente à l'éssai) la ligne est extraite si la pièce est facturée
    # If [F:SDH]EECSCH="21"  & [F:SDH]INVFLG=1     : Goto NEXT_SDH : Endif
  Else
    #--CPO DM 105661 Ajout de la sous-traitance
    #--Déplacement du test valeurs vides EECSCH et EECNAT après le parcours des lignes
    #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
    #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
#    If [F:SDH]EECSCH="" and [F:SDH]EECNAT=""
#      If [M]PRNULREGNA=2
#        Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(746,197,1),0) From GESECRAN
#      Endif
#      Goto NEXT_SDH
#    Endif
    If [F:SDH]EECSCH="" and [F:SDH]EECNAT=""
      #--Si, après parcours des lignes, le flag est toujours à 1, on passe à la pièce suivante
      [L]W_ISEMPTY_EEC_SCH_NAT = 1
    Endif
    #--/
  Endif
  #--- Type de mouvement
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Cohérence de l'ordre avec celui utilisé sur les lignes...
  #WMVT=1                                          : # Livraison classique
  #If [F:SDH]LND=2      : WMVT=3 : Endif           : # Livraison de prêt
  #If [F:SDH]SCO=2      : WMVT=4 : Endif           : # livraison pour sous-traitance
  #If [F:SDH]BETFCY=2   : WMVT=5 : Endif           : # Livraison inter-sites
  #If [F:SDH]BETCPY=2   : WMVT=2 : Endif           : # Livraison inter-sociétés
  #If [F:SDH]FFWNUM<>"" : WMVT=6 : Endif           : # Livraison export avec transit.
  WMVT=1                                          : # Livraison classique
  If [F:SDH]BETFCY=2   : WMVT=5 : Endif           : # Livraison inter-sites
  If [F:SDH]BETCPY=2   : WMVT=2 : Endif           : # Livraison inter-sociétés
  If [F:SDH]LND=2      : WMVT=3 : Endif           : # Livraison de prêt
  If [F:SDH]SCO=2      : WMVT=4 : Endif           : # livraison pour sous-traitance
  If [F:SDH]FFWNUM<>"" : WMVT=6 : Endif           : # Livraison export avec transit.
  #--/
  #--- Livraison contremarque directe
  #--- une même livraison peut avoir des lignes de ctm et des lignes normales
  #--- Régime 21 ou 31 ?
  #--- Solution implémentée : R21 et changement du régime lors du ttt d'une ligne de livraison de type ctm
  # Afin de retrouver les bons numéros en cas de rollback
  WOLDLININT = WNOLININT
  WOLDLINEXP = WNOLINEXP
  Call DEBTRANS From GLOCK
  Trbegin [DEB]
  #--- Eléments de facturation
  # Depuis V6 : les éléments de facturation sont présents sur les pieds des pièces autres que les factures
  # Prise en compte des éléments non répartis sur les lignes : INVLINFLG = 1 ou 6,
  # a condition qu'ils entrent dans le calcul de la valeur fiscale et/ou valeur statistique : CLCDEB = 2 ou 3
  # puis répartition sur les lignes, au prorata des montants de chaque ligne
  # Somme des éléments de facturation non répartis sur les lignes
  WNUMEROPIECE = [F:SDH]SDHNUM
  W_VCRTYP=2 # Issue 110289 - 2015-08-12 by CPO : Invoicing elements when using same counter on different documents
  Gosub VEN_TOTDTA
  WINVDTAAMT   = WTOTDTA
  WINVDTAAMTVS = WTOTDTAVS
  Raz WNUMEROPIECE
  Raz W_VCRTYP # Issue 110289 - 2015-08-12 by CPO
  #--- Prise en compte des éléments de l'entête de pièce, puis de chaque ligne de détail
  Gosub EEC_UN_SDH
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacement du test valeurs vides EECSCH et EECNAT après le parcours des lignes
  #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
  If [L]W_ISEMPTY_EEC_SCH_NAT = 1
    #--Si, après parcours des lignes, le flag est toujours à 1, on passe à la pièce suivante
    #--Il passe à 0 si au moins une ligne permets d'alimenter les régimes/natures spéciaux
      If [M]PRNULREGNA=2
        Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(746,197,1),0) From GESECRAN
      Endif
      WOK=0
  Endif
  #--/
  If WOK=0 : Gosub AB_DEB : Goto NEXT_SDH : Endif
  #--- Ecriture des éléments du masque DEBGEN dans le fichier DEB
  Gosub EEC_DEBGEN
  If WOK=0 : Gosub AB_DEB : Goto NEXT_SDH : Endif
  #--- On met à jour le champ EECNUMDEB si l'écriture dans le fichier DEB a réussi
  #Uniquement si au moins une ligne a été renseignée dans le masque de génération
  If [M:DEBG]NBDEB > 0
    W_NUMPIECE = [F:SDH]SDHNUM
    If W_NUMPIECE <> ""
      #--- Maj no traitement dans la pièce de réception
      Update [SDH] Where SDHNUM = W_NUMPIECE With EECNUMDEB = [M]EECNUMDEB
      If fstat
        Call FSTA("SDH") From GLOCK
        Gosub AB_DEB
        Goto NEXT_SDH
      Endif
      Raz W_NUMPIECE
    Endif
  Else
    #--- si aucune ligne extraite
    Gosub AB_DEB
    Goto  NEXT_SDH
  Endif

  Call ECR_TRACE(mess(129,197,1)-[F:SDH]SDHNUM-mess(741,197,1),0) From GESECRAN

  Commit
$NEXT_SDH
Next

Return
#----------------------------------------------------------------------
$EEC_UN_SDH
WOK=1
nolign=0
#--- Chargement du masque DEBGEN
For [SDD] Where SDHNUM=[F:SDH]SDHNUM
  WOKLIG = 1
  W_CHANGED_MVT=0 :#--CPO DM 105661 Ajout de la sous-traitance
  #--CPO 106690 Cas de deux lignes de type "divers", n'ayant pas d'article et qui se suivent
  If [F:SDD]ITMREF="" :  Goto NEXT_EEC_UN_SDH : Endif
  #--/
  If [F:ITM]ITMREF <> [F:SDD]ITMREF
    Read [F:ITM]ITM0=[F:SDD]ITMREF
    If fstat : Raz [F:ITM] : Goto NEXT_EEC_UN_SDH : Endif
  Endif
  #--- Si l'article n'est pas "Soumis à la DEB", on saute la ligne de détail
  If [F:ITM]EECGES <> 2
    #--CPO 74679 Amélioration de la trace
    WMESS_CODE=3 : WMESS_TRACE=mess(735,197,1)-[F:SDD]SDHNUM-num$([F:SDD]SDDLIN)-[F:ITM]ITMREF : Gosub MESS_TRACE
    #--CPO
    Goto NEXT_EEC_UN_SDH
  Endif
  #--- Prise en compte du paramètre permettant de retarder la déclaration des
  #--- livraisons facturables mais non facturées complétement
  #--- Livraison facturable = livraison validée (condition faisant partie des critères de sélection des pièces)
  #--- et il ne s'agit pas d'un gratuit (FOCFLG=1)
  If [F:SDD]FOCFLG<>3 and [F:SDH]SIHNUM=""
   # FQ 52820 - sauf inter-sites et sous-traitance
   # X3-64479 : Be able to create non invoiceable deliveries from project tasks / X3-137210 (LD 12/09/19)
   # sauf livraisons non facturables / except non billable deliveries
   #If ([F:SDH]BETFCY<>2 or [F:SDH]BETCPY=2) and [F:SDH]SCO<>2
   If ([F:SDH]BETFCY<>2 or [F:SDH]BETCPY=2) and [F:SDH]SCO<>2 and [F:SDH]SDHCAT<>4
   # X3-64479 : Be able to create non invoiceable deliveries from project tasks / X3-137210 (LD 12/09/19)
    If [F:SDH]DLVDAT>[M]DEBDAT-GEECEXTDELA
      #--CPO 74679 Amélioration de la trace
      WMESS_CODE=2 : WMESS_TRACE=mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN) : Gosub MESS_TRACE
      #--CPO
      Goto NEXT_EEC_UN_SDH
    Endif
   Endif
  Endif

  #--CPO DM 105661 Ajout de la sous-traitance
  #---on extrait uniquement les lignes de type "Nomenclature composé"
  #---et celles "Standard"
  If find([F:SDD]LINTYP,11,12,13)>0 #find([F:SDD]LINTYP,3,4,5,7,8,9,11,12,13)=0
    #--CPO 74679 Amélioration de la trace
    WMESS_CODE=4 : WMESS_TRACE=mess(735,197,1)-[F:SDD]SDHNUM-num$([F:SDD]SDDLIN) : Gosub MESS_TRACE
    #--CPO
    Goto NEXT_EEC_UN_SDH
  Endif
  #--/
  #--CPO DM 105661 Ajout de la sous-traitance
  #--C'est mieux de faire l'init de WMVT en dehors du test sur W_MTTHTLIN
  WMVT=1                                          : # Livraison classique
  If [F:SDH]BETFCY=2   : WMVT=5 : Endif           : # Livraison inter-sites
  If [F:SDH]BETCPY=2   : WMVT=2 : Endif           : # Livraison inter-sociétés
  If [F:SDH]LND=2      : WMVT=3 : Endif           : # Livraison de prêt
  #--CPO DM 105661 Ajout de la sous-traitance
  #If [F:SDH]SCO=2      : WMVT=4 : Endif          : # livraison pour sous-traitance
  If [F:SDH]SCO=2 and [F:SDD]LINTYP = 1
                         WMVT=4                   : # livraison matières pour sous-traitance
  Endif
  If [F:SDH]LND<>2 and [F:SDH]SCO<>2 and [F:SDD]LINTYP=10
                         WMVT=21                  : # livraison de produit fini sous-traitance
  Endif
  #--/
  If [F:SDD]FOCFLG=3   : WMVT=18: Endif           : # Livraison de gratuits
  If [F:SDH]FFWNUM<>"" : WMVT=6 : Endif           : # Livraison export avec transit.
  #--/
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Un seul appel à FLUX_REGNAT
#  #--- Cas d'une ligne de gratuits
#  #--- Il faut rechercher le régime et la nature de ce mouvement, en tenant compte de la législation de la société
#  #--- le Mvt=18
#  Raz WEECNAT,WEECSCH
#  If [F:SDD]FOCFLG=3
#    # If GEECEXTFREE=2
#      WMVT= 18 :# "Livraison de gratuits"
#      Raz WVALSTO,WTROUVE
#      Call FLUX_REGNAT(WMVT,[F:SDH]STOFCY,[F:FCY]CRY,WEECSCH,WEECNAT,WVALSTO,WTROUVE) From FUNDEBA
#      #Il faut avoir un régime et une nature de renseignés.
#      #If WTROUVE=1
#      If WTROUVE=1 and (WEECSCH<>"" or WEECNAT<>"")
#        Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),0) From GESECRAN
#        # Livraison de gratuits : le Régime CEE et/ou la Nature ont été modifiés
#        Call ECR_TRACE(mess(739,197,1),0) From GESECRAN
#        W_CHANGED_MVT=1 :#--CPO DM 105661 Ajout de la sous-traitance
#      Else
#        #--- Si ligne de gratuits et si le paramètre ne permet pas l'extraction de ces derniers,
#        #--- on ne prend pas en compte la ligne
#        Goto NEXT_EEC_UN_SDH
#      Endif
#    #Else
#    #  #--- Si ligne de gratuit et que le paramètre ne permet pas l'extraction de ces derniers,
#    #  #--- on ne prend pas en compte la ligne
#    #  Goto NEXT_EEC_UN_SDH
#    #Endif
#  Endif
  #--- Cas des lignes de gratuits ou de sous-traitance
  #--- Il faut rechercher le régime et la nature de ce mouvement, en tenant compte de la législation de la société
  Raz WEECNAT,WEECSCH
  Raz WVALSTO,WTROUVE
  If find(WMVT,18,21)>0
    Call FLUX_REGNAT(WMVT,[F:SDH]STOFCY,[F:FCY]CRY,WEECSCH,WEECNAT,WVALSTO,WTROUVE) From FUNDEBA
    If WTROUVE=1 and (WEECSCH<>"" or WEECNAT<>"")
      Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),0) From GESECRAN
      Case WMVT
        When 18 :         # Livraison de gratuits : le Régime CEE et/ou la Nature ont été modifiés
                 Call ECR_TRACE(mess(739,197,1),0) From GESECRAN
        When 4 : #--suite remarque CH 29/06/2015 (c'est une info en-tête qui donne ce type;soit elle est initialisée soit modifiée par user)
                 #        # Livraison pour sous-traitance : le Régime CEE et/ou la Nature ont été modifiés
                 #Call ECR_TRACE(mess(4,2236,1)-":"-mess(752,197,1),0) From GESECRAN
        When 21 :         # Livraison de sous-traitance : le Régime CEE et/ou la Nature ont été modifiés
                 Call ECR_TRACE(mess(21,2236,1)-":"-mess(752,197,1),0) From GESECRAN
      Endcase
      W_CHANGED_MVT=1 :#--CPO DM 105661 Ajout de la sous-traitance
    Else
      If WMVT = 18
        #--- Si ligne de gratuits et si le paramètre ne permet pas l'extraction de ces derniers,
        #--- on ne prend pas en compte la ligne
        Goto NEXT_EEC_UN_SDH
      Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG and error if setup non found/inactive
      Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),0) From GESECRAN
      Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(911,197,1),1) From GESECRAN
      Goto NEXT_EEC_UN_SDH
      # End issue X3-131291
    Endif
  Endif
  #--/

  #FQ 56398 (suite de 51074) - Point d'entrée pour gérer des contrôles à la ligne
  Local Integer SAUVGPE     : SAUVGPE=GPE : GPE=0
  #La variable GPE permet d'accepter ou de refuser la ligne
  # 0 -> la ligne est acceptée
  # 1 -> la ligne est refusée, on passe à la suivante
  GPOINT="DEBCTLLIG" : Gosub ENTREE From EXEFNC
  If GPE : GPE=SAUVGPE : Goto NEXT_EEC_UN_SDH : Endif
  #FQ 56398

  nolign +=1
  #--- Chargement du masque avec les éléments de la ligne
  Gosub DEBG_SDH
  #--- Le cours de change n'a pas été trouvé
  If WOK = 0 : Break : Endif
  #--- La ligne ne sera pas prise en compte, mais sans incidence sur les autres ligne du détail
  If WOKLIG = 0 : nolign -= 1 : Goto NEXT_EEC_UN_SDH : Endif
  #--- Valorisation factures origine Livraison
  # Si le détail est facturé, alors nous prenons en compte les éléments de la facture pour le calcul de la valeur fiscale et/ou stat
  # seulement dans le cas où il y a différence avec ce qui a été calculé depuis la ligne de livraison
  #--- Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
  Raz WNOLINVALO
  If [F:SDH]SIHNUM<>""                             :# si livraison facturee
    Raz WFACDTAAMT, WFACDTAAMTVS, WFISAMTDTA, WSTAAMTDTA, W_NUM, WTOTAMTNOT, WMAJ, WPASVALO, WTRNOK
    #--- valorisation avec les lignes facturées
    # Issue X3-66286 - 2017-12-28 by CPO : Wrong EEC exchange declaration if a pro forma exists
    #--in case of proforma, there are more then one invoice line entry
    #Read [SID]SID3=[F:SDD]SDHNUM;[F:SDD]SDDLIN
    Filter [F:SID] Where [F:SID]SDHNUM=[F:SDD]SDHNUM and [F:SID]SDDLIN=[F:SDD]SDDLIN and NUM=[F:SDH]SIHNUM
    Read [F:SID] First
    Filter [F:SID]
    # End issue X3-66286
    If fstat : Raz [F:SID] : Endif
    If !fstat
      #--- La facture doit correspondre à la facture renseignée dans l'entête de la livraison traitée
      If [F:SID]NUM = [F:SDH]SIHNUM
        If ([M]REG=1 & [F:SID]LINEECFLG <> 2) | [M]REG=2
          Gosub DEBG_DTA_SDH                       :# prise en compte des éléments de facturation
          #--- Valeur fiscale valorisée avec les éléments de la facture
          If WPASVALO=0
            #--- Si Livraison de prêt facturée, on prend les valeurs des Régimes/Natures de la facture
            If [F:SDH]LND=2
              #FQ 52635
              If [F:SDH]EECNAT=""
                [M:DEBG]EECNAT  (nolign-1) = [F:SIV]EECNAT
              Endif
              If [F:SDH]EECSCH=""
                [M:DEBG]EECSCH  (nolign-1) = [F:SIV]EECSCH
              Endif
              #--CPO DM 105661 Ajout de la sous-traitance
              #--Déplacé juste après la reprise des infos depuis la facture, avant le update sur fact
              #--- Fin Valorisation factures origine Livraison
              #--- Si Livraison de prêt et le Régime/Nature repris de la facture sont tjs à ""
              #--- on ne prends pas en compte la ligne
              If [F:SDH]LND=2 and [M:DEBG]EECNAT(nolign-1)="" and [M:DEBG]EECSCH(nolign-1)=""
                WOKLIG = 0 : nolign -= 1 : Goto NEXT_EEC_UN_SDH
              Endif
              #--/
            Endif
            If WFISAMTDTA <> 0 and WFISAMTDTA <> [M:DEBG]FISAMT(nolign-1)
              WMAJ = 1
            Endif
            #--- Valeur statistique valorisée avec les éléments de la facture
            If WSTAAMTDTA <> 0 and WSTAAMTDTA <> [M:DEBG]STAAMT(nolign-1)
              WMAJ = 1
            Endif
            # Raz WTRNOK
            # If WMAJ
              If WMAJ
                W_NUMPIECE   = [F:SID]NUM
                W_NUMLINPIEC = [F:SID]SIDLIN
                #--- Mise à jour de LINEECFLG du détail facture
                Update [SID] Where NUM=W_NUMPIECE and SIDLIN=W_NUMLINPIEC With LINEECFLG = 2
                If fstat : Call FSTA("SID") From GLOCK : WTRNOK = 1 : Endif
              Endif
              #--- Mise à jour du champ EECNUMDEB de la facture ayant pour origine la livraison à traiter
              If (WTRNOK = 0) and ([F:SIH]NUM = [F:SDH]SIHNUM)
                If WMAJ
                  #--- Uniquement s'il n'y a pas de lignes supplémentaires
                  # (il faut laisser la possibilité que la facture puisse être prise en compte lors du traitement des factures)
                  Raz WLINSUP
                  For [SIDW]SID0 Where NUM = [F:SID]NUM
                    If [F:SIDW]SDHNUM = "" or [F:SIDW]SDHNUM <> [F:SDH]SDHNUM
                      WLINSUP = 1 : Break
                    Endif
                  Next
                  If WLINSUP = 0
                    Update [SIH] Where NUM=[F:SID]NUM With EECNUMDEB=[M]EECNUMDEB
                    If fstat : Call FSTA("SIH") From GLOCK : WTRNOK = 1 : Endif
                  Endif
                Endif
              Else
                WTRNOK = 1
              Endif
              #--- Mise à jour du champ EECNUMDEB du(des) avoir(s) sur la facture ayant comme origine la livraison traitée

              If WTRNOK = 0 :# Pas la peine d'aller plus loin s'il y a erreur
                #--- Renseignement des pièces prises en compte lors de la valorisation
                #--- Ligne facture de la ligne de livraison
                #--CPO 75397 Indice incorrect
                If nolign > NBLIGNESDET
                  Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
                  Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),1) From GESECRAN
                  WTRNOK = 1
                Else
                #--CPO 75397
                  WINDICE=find([F:SID]NUM,WVCRNUMVALO(0..14,nolign-1))
                  If WINDICE<=0 or (WINDICE>0 and !find([F:SID]SIDLIN,WVCRLINVALO(WINDICE-1,nolign-1)))
                    WNOLINVALO = 1
                    WVCRNUMVALO(WNOLINVALO-1,nolign-1)=[F:SID]NUM
                    WVCRLINVALO(WNOLINVALO-1,nolign-1)=[F:SID]SIDLIN
                  Endif
                Endif :#--CPO 75397
                #--- Prise en compte des factures/avoirs complémentaires
                #--- uniquement si le paramètre général "EECVALOCPL" est à "Oui"
                #CPO 06/03/09 (vu avec CH)
                #les avoirs de ventes ne doivent pas impacter la valeur de la livraison
                #puisqu’ils sont déclarés comme des régularisations financières
                #If GEECVALOCPL=2
                #  For [SIDC] Where SIHORINUM=[F:SID]NUM & SIDORILIN=[F:SID]SIDLIN

                #  Next
                #Endif
              Endif
              #--- Validation de la transaction selon le cas
              If WTRNOK : WOK = 0 : Break
              Else
                #--- Tout est OK : en prend en compte les nouvelles valeurs
                #--- La Livraison qui génère la ligne DEB est valorisée avec les éléments des factures/avoirs
                #--- Nouvelle valeur fiscale valorisée
                If WFISAMTDTA <> 0 and WFISAMTDTA <> [M:DEBG]FISAMT(nolign-1)
                  [M:DEBG]FISAMT(nolign-1) = WFISAMTDTA
                  [M:DEBG]LINVALOFLG(nolign-1)=2
                Endif
                #--- Nouvelle valeur statistique valorisée
                If WSTAAMTDTA <> 0 and WSTAAMTDTA <> [M:DEBG]STAAMT(nolign-1)
                  [M:DEBG]STAAMT(nolign-1) = WSTAAMTDTA
                  [M:DEBG]LINVALOFLG(nolign-1)=2
                Endif
              Endif
            # Endif
          Endif
        Endif
      Endif
    Endif
  Endif

  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacé juste après la reprise des infos depuis la facture, avant le update sur fact
  #--- Fin Valorisation factures origine Livraison
  #--- Si Livraison de prêt et le Régime/Nature repris de la facture sont tjs à ""
  #--- on ne prends pas en compte la ligne
  #If [F:SDH]LND=2 and [M:DEBG]EECNAT(nolign-1)="" and [M:DEBG]EECSCH(nolign-1)=""
  #  WOKLIG = 0 : nolign -= 1 : Goto NEXT_EEC_UN_SDH
  #Endif
  #--/

  #------------------------------------------------------------------------------------------
  #--- Cas de la Livraison ayant un retour avec déduction de la facture de livraison
  #---Cette livraison est valorisée sur la facture si tous les retours avec déduction facture
  #---datent d'avant la date d'extraction courante de la DEB
  #---(Condition de réalisation de la valo de la livraison dans ce cas précis)
  If [M:DEBG]LINVALOFLG(nolign-1)<> 2 or
&   (WPASVALO=0 and [F:SDH]SIHNUM<>"") :# si la facture ne modifie pas le mtt de la livraison
    Local Decimal WQTYSTURETN
    Local Decimal WQTYSTURETN1
    #-recherche si existe des lignes de retour de ce type, datés d'avant l'extraction en cours
    For [SRD] Where SDHNUM=[F:SDD]SDHNUM and SDDLIN=[F:SDD]SDDLIN and RTNINVUPD=2
      Read [SRH]SRH0=[F:SRD]SRHNUM
      If fstat : Raz [F:SRH] : WQTYSTURETN=0: WQTYSTURETN1=0 : Break : Endif
      If [F:SRH]RTNDAT<=[M]DEBDAT or find([F:SRH]EECNUMDEB,0,[M]EECNUMDEB)
        #--ligne retour avant la date d'extraction
        #--la ligne de retour ne sera pas extraite sur la présente DEB
        WQTYSTURETN += [F:SRD]QTYSTU
      Else
        #--ligne retour après la date d'extraction
        #--la ligne de retour sera extraite lors d'un prochaine DEB
        WQTYSTURETN1 += [F:SRD]QTYSTU
      Endif
    Next
    #---Normalement il ne doit pas y avoirs de lignes datées d'après la date de DEB courante
    #---d'où la condition d'avoir un WQTYSTURETN1 à 0 !
    If WQTYSTURETN>0 and WQTYSTURETN1=0
      #-il existe de telles lignes de retour
      #-la quantité du/des retours vient(ent)en déduction de celle de la livraison
      #--on recalcule la masse nette et les unités cee à partir de la facture
      If [F:SID]SDHNUM<>[F:SDD]SDHNUM or [F:SID]SDDLIN<>[F:SDD]SDDLIN
        # Issue X3-66286 - 2017-12-28 by CPO : Wrong EEC exchange declaration if a pro forma exists
        #--in case of proforma, there are more then one invoice line entry
        #Read [SID]SID3=[F:SDD]SDHNUM;[F:SDD]SDDLIN
        Filter [F:SID] Where [F:SID]SDHNUM=[F:SDD]SDHNUM and [F:SID]SDDLIN=[F:SDD]SDDLIN and NUM=[F:SDH]SIHNUM
        Read [F:SID] First
        Filter [F:SID]
        If fstat : Raz [F:SID] : Goto NEXT_EEC_UN_SDH : Endif
        # End issue X3-66286
      Endif
      If [F:ITM]ITMREF <> [F:SID]ITMREF
        Read [F:ITM]ITM0=[F:SID]ITMREF
        If fstat : Raz [F:ITM] : Goto NEXT_EEC_UN_SDH : Endif
      Endif
      If [F:ITM]ITMWEI<>0
        If toupper(left$([F:ITM]WEU,2))="KG"
          [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:SID]QTYSTU
        Else
          I=find("KG",GUNITE(1..GDIMUNT))
          If I=0 I=find("Kg",GUNITE(1..GDIMUNT)) Endif
          If I=0 I=find("kg",GUNITE(1..GDIMUNT)) Endif
          If I<>0
            Read [TCO]TCO0=[F:ITM]WEU;GUNITE(I)
            If !fstat [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:SID]QTYSTU*[F:TCO]COEUOM Endif
          Endif
        Endif
      Endif
      If [F:ITM]EEU<>"" & [F:ITM]EEUSTUCOE<>0
        [M:DEBG]EECUNT (nolign-1) =[F:SID]QTYSTU/[F:ITM]EEUSTUCOE
      Endif
    Endif
  Endif
  #--- fin cas de la livraison avec retour déduit de la facture de livraison
  #------------------------------------------------------------------------------------------

$NEXT_EEC_UN_SDH
Next

If WOK = 0 : Return : Endif
If nolign = 0 : WOK = 0 : Return : Endif

Return
#----------------------------------------------------------------------
$DEBG_SDH
If nolign=1
  Raz [M:DEBG]
  [M:DEBG]CPY       = [M:DIA]CPY
  [M:DEBG]CUR       = [F:CPY]ACCCUR
  [M:DEBG]EECNUMDEB = [M:DIA]EECNUMDEB
  [M:DEBG]DEBDAT    = [M:DIA]DEBDAT
  [M:DEBG]VCRTYP    = 4
  [M:DEBG]VCRNUM    = [F:SDH]SDHNUM
  [M:DEBG]DAT       = [F:SDH]DLVDAT
  #--CPO 81821 Il faut tenir compte de la date de la facture
  #--si elle intervient avant la date de livraison
  If [F:SDH]SIHNUM<>"" and [F:SDH]DLVDAT>[M]DEBDAT
    #--lecture de la facture
    If [F:SIH]NUM<>[F:SDH]SIHNUM
      Read [F:SIH]SIH0=[F:SDH]SIHNUM
      If fstat : Raz [F:SIH] : Endif
    Endif
    If [F:SIH]ACCDAT<>[0/0/0] and [F:SIH]ACCDAT<=[M]DEBDAT and [F:SIH]STA = 3
      [M:DEBG]DAT = [F:SIH]ACCDAT
    Endif
    Raz [F:SIH]
  Endif
  #--/
  [M:DEBG]CURDOC    = [F:SDH]CUR
  [M:DEBG]BPRNUM    = [F:SDH]BPCINV
  If [F:SDH]BPIEECNUM<>""
    [M:DEBG]EECNUM = [F:SDH]BPIEECNUM
  Else
    Read [BPR]BPR0=[F:SDH]BPCINV
    If fstat : Raz [F:BPR] : Endif
    [M:DEBG]EECNUM  = [F:BPR]EECNUM
  Endif
  #--- Cas du n° de TVA issu du pays expéditeur
  If [M:DEBG]EECNUM <> ""
    If left$([M:DEBG]EECNUM,2)=W_EECCRYFROM
      Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM,0) From GESECRAN
      # "Radical du numéro de TVA identique à celui du site expéditeur"
      Call ECR_TRACE(mess(740,197,1),0) From GESECRAN
    Endif
  Endif

  If [F:SDH]STOFCY<>""
    If [F:FCY]FCY<>[F:SDH]STOFCY
      Read [FCY]FCY0=[F:SDH]STOFCY
      If fstat : Raz [F:FCY] : Endif
    Endif
    Read [BPA]BPA0=3;[F:SDH]STOFCY;[F:FCY]BPAADD
    If fstat : Raz [F:BPA] : Endif
    If [F:BPA]POSCOD<>""
      [M:DEBG]REG (0) = left$([F:BPA]POSCOD,2)
    Endif
  Endif
Endif
#--- Site de stockage
[M:DEBG]STOFCY  (nolign-1) = [F:SDH]STOFCY
[M:DEBG]CRYFCY  (nolign-1) = W_EECCRYFROM
#--- Etat fédéral
If dim([M:DEBG]STAFED)>0
  Raz WSTAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
  Read [ITF]ITF0=[F:SDD]ITMREF;[F:SDH]STOFCY
  If fstat : Raz [F:ITF] : Endif
  If dim([F:ITF]STAFED)<>0 and [F:ITF]STAFED<>""
    WSTAFED=[F:ITF]STAFED #[M:DEBG]STAFED(nolign-1)=[F:ITF]STAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
  Else
    If dim([F:ITM]STAFED)>0 and [F:ITM]STAFED<>""
      WSTAFED=[F:ITM]STAFED #[M:DEBG]STAFED(nolign-1)=[F:ITM]STAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
    Endif
  Endif
  Gosub SET_M_DEBG_STAFED From FUNDEBA # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
Endif
#---
[M:DEBG]VCRLIN  (nolign-1) = [F:SDD]SDDLIN
[M:DEBG]FLO     (nolign-1) = 2
[M:DEBG]ITMREF  (nolign-1) = [F:SDD]ITMREF
[M:DEBG]ITMDES1 (nolign-1) = [F:SDD]ITMDES1
[M:DEBG]CUSREF  (nolign-1) = [F:ITM]CUSREF
#--CPO DM 105661 Ajout de la sous-traitance
#If [F:SDD]FOCFLG=3
If [F:SDD]FOCFLG=3 or [L]W_CHANGED_MVT=1
#--/
  [M:DEBG]EECNAT  (nolign-1) = WEECNAT
  [M:DEBG]EECSCH  (nolign-1) = WEECSCH
  #CPO - vu avec CH : c'est le paramètre EECEXTFREE qui décide si on extrait une ligne à 0
  #[M:DEBG]FOCITM  (nolign-1) = 2 :#Article gratuit (ne tient pas compte de EECEXTFREE)
Else
  [M:DEBG]EECNAT  (nolign-1) = [F:SDH]EECNAT
  [M:DEBG]EECSCH  (nolign-1) = [F:SDH]EECSCH
Endif

#--- Cas de la Livraison de contremarque directe => Régime positionné à la valeur du flux de la table des regimes et nat. par mvt.
Raz WTROUVE
Raz WVALSTO
If [F:SDD]SOHNUM <> "" and [F:SDD]SOPLIN <> 0 and [F:SDD]SOQSEQ
  Read [SOQ]SOQ0=[F:SDD]SOHNUM;[F:SDD]SOPLIN;[F:SDD]SOQSEQ
  If fstat : Raz [F:SOQ] : Endif
  If [F:SOQ]FMI=2 and [F:SOQ]FMINUM <> ""  : # Contremarque directe
    Read [POH]POH0=[F:SOQ]FMINUM
    If fstat : Raz [F:POH] : Endif

    #--- TS Issue 101474 --CPO OK
    If [F:POH]CRY=""
      If [F:BPA]BPATYP<>1 or [F:BPA]BPANUM<>[F:POH]BPSNUM or [F:BPA]BPAADD<>[F:POH]BPAADD
        Read [BPA]BPA0=1;[F:POH]BPSNUM;[F:POH]BPAADD
        If fstat : Raz [F:BPA] : Endif
      Endif
      [F:POH]CRY = [F:BPA]CRY
      #  Read [BPA]BPA0=1;[F:POH]BPSNUM;[F:POH]BPAADD
      #  If !fstat : [F:POH]CRY=[F:BPA]CRY : Endif
    Endif
    If [F:POH]BPOCRY=""
      If [F:BPA]BPATYP<>1 or [F:BPA]BPANUM<>[F:POH]BPSNUM or [F:BPA]BPAADD<>[F:POH]BPOADD
        Read [BPA]BPA0=1;[F:POH]BPSNUM;[F:POH]BPOADD
        If fstat : Raz [F:BPA] : Endif
      Endif
      [F:POH]BPOCRY = [F:BPA]CRY
      #  Read [BPA]BPA0=1;[F:POH]BPSNUM;[F:POH]BPOADD
      #  If !fstat : [F:POH]BPOCRY=[F:BPA]CRY : Endif
    Endif
    #---

    #--- Le pays du fournisseur doit être UE à la date de la commande
    JL0=find([F:POH]CRY,T_CRY)
    # Issue X3-131291 - 2019-05-07 by CPO : Added test on UE exit date
    If JL0 and [F:POH]ORDDAT >= T_EECDAT(JL0-1) and (T_EECDATOUT(JL0-1) = AVOID.ADATE | [F:POH]ORDDAT < T_EECDATOUT(JL0-1))
      Raz JL0
      #--- Echange triangulaire si les pays des trois différents sites sont différents et sont UE
      JL0=find([F:POH]BPOCRY,T_CRY)
      # Issue X3-131291 - 2019-05-07 by CPO : Added test on UE exit date
      If JL0 and T_EECCOD(JL0-1)<>"" and [F:POH]ORDDAT >= T_EECDAT(JL0-1) and (T_EECDATOUT(JL0-1) = AVOID.ADATE | [F:POH]ORDDAT < T_EECDATOUT(JL0-1))
        #--- Le pays du fournisseur doit être différent de ceux de la Livraison de ctm
        If T_EECCOD(JL0-1) <> W_EECCRYFROM and T_EECCOD(JL0-1) <> W_EECCRYTO
          Read [FCY]FCY0=[F:SDH]STOFCY : # pays depart
          If fstat : Raz [F:FCY] : Endif
          # MVT= 7 : "Livraison de contremarque directe"
          WMVT = 7 #--CPO DM 105661 Ajout de la sous-traitance
          Call FLUX_REGNAT(7,[F:SDH]STOFCY,[F:FCY]CRY,[M:DEBG]EECSCH(nolign-1),[M:DEBG]EECNAT(nolign-1),WVALSTO,WTROUVE) From FUNDEBA
          If WTROUVE=1
            Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),0) From GESECRAN
            # "Echange triangulaire : le Régime CEE et/ou la Nature ont été modifiés"
            Call ECR_TRACE(mess(737,197,1),0) From GESECRAN
            W_CHANGED_MVT=1 :#--CPO DM 105661 Ajout de la sous-traitance
          Else
            # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG and error if setup non found/inactive
            Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),0) From GESECRAN
            Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(911,197,1),1) From GESECRAN
            WOKLIG=0 : Return
            # End issue X3-131291
          Endif
        Elsif T_EECCOD(JL0-1) = W_EECCRYTO
          #---Ctm directe, mais le fss expéditeur et le client livré sont dans le même pays
          # Issue X3-131291 - 2019-05-07 by CPO : Added test on UE exit date
          # "Echange triangulaire : 'Le fournisseur expéditeur et le client livré ou le site de vente sont dans le même pays'
          Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),0) From GESECRAN
          Call ECR_TRACE(mess(824,197,1)+" : "+mess(825,197,1),0) From GESECRAN
          # End issue X3-131291
          WOKLIG=0 : Return
        Endif
      Else
        #---La date de commande de ctm est antérieure à l'entrée dans l'UE du pays fss
        #---ou le fss expéditeur n'est pas dans un pays UE
        # Issue X3-131291 - 2019-05-07 by CPO : Added test on UE exit date
        Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),0) From GESECRAN
        # "Echange triangulaire : 'La date de commande de contremarque est antérieure à l'entrée dans l'UE du pays de'+'l'adresse commande du fournisseur'
        # ou le pays de l'adresse commande du fournisseur n'est pas un pays UE
        Call ECR_TRACE(mess(824,197,1)+" : "+mess(826,197,1)+" "+mess(828,197,1)+", "+mess(829,197,1)+" "+mess(828,197,1)+" "+mess(830,197,1),0) From GESECRAN
        # End issue X3-131291
        WOKLIG=0 : Return
      Endif
    Else
      #---CTM dir, mais le pays du fss expéditeur n'appartient pas à l'UE à la date de cde de ctm
      # Issue X3-131291 - 2019-05-07 by CPO : Added test on UE exit date
      Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN),0) From GESECRAN
      # "Echange triangulaire : 'La date de commande de contremarque est antérieure à l'entrée dans l'UE du pays de'+'l'adresse commande du fournisseur'
      # ou le pays de l'adresse commande du fournisseur n'est pas un pays UE
      Call ECR_TRACE(mess(824,197,1)+" : "+mess(826,197,1)+" "+mess(828,197,1)+", "+mess(829,197,1)+" "+mess(828,197,1)+" "+mess(830,197,1),0) From GESECRAN
      # End issue X3-131291
      WOKLIG=0 : Return
    Endif
  Endif
Endif

#--CPO DM 105661 Ajout de la sous-traitance
#--Déplacement du test valeurs vides de EECSCH et EECNAT
#--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
#--- Si Régime et Nature sont vides, la ligne n'est pas extraite
If [F:SDH]LND<>2 or [F:SDH]SIHNUM=""  :#--hors livr de prêt facturées, car init depuis la facture et test si vide après
  If [M:DEBG]EECSCH(nolign-1)<>"" or [M:DEBG]EECNAT(nolign-1)<>""
    [L]W_ISEMPTY_EEC_SCH_NAT=0
  Else
    If [M]PRNULREGNA=2 and W_ISEMPTY_EEC_SCH_NAT=0
      Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-num$([F:SDD]SDDLIN)-[F:SDD]ITMREF-mess(746,197,1)
&    -mess(744,197,1)-mess(745,197,1),0) From GESECRAN
    Endif
    #--On passe à la ligne suivante
    WOKLIG=0 : Return
  Endif
Endif
#--/

If W_EECCRYFFW<>""  [M:DEBG]DESCRY (nolign-1) = W_EECCRYFFW
  Else              [M:DEBG]DESCRY (nolign-1) = W_EECCRYTO
Endif
[M:DEBG]ORICRY  (nolign-1) = ""                      : # pas de pays origine pour les flux expédition
#Issue X3-124702 - 2019-03-12 by VAVIL
If func TRTLECLEG.FGETLEG([M:DEBG]CPY,"T") ="POR"
LCRY=[F:FCY]CRY
Gosub LEC_TCY
If [F:TCY]EECFLG=2 & [F:TCY]EECCOD<>""
  [M:DEBG]ORICRY(nolign-1)=[F:TCY]EECCOD
Else
  [M:DEBG]ORICRY(nolign-1)=[F:TCY]ISO
Endif
Endif
#Issue end X3-124702
[M:DEBG]REG     (nolign-1) = [M:DEBG]REG(0)          : # site expé à l'entête
If [F:ITM]ITMWEI<>0
  If toupper(left$([F:ITM]WEU,2))="KG"
    [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:SDD]QTYSTU
  Else
    I=find("KG",GUNITE(1..GDIMUNT))
    If I=0 I=find("Kg",GUNITE(1..GDIMUNT)) Endif
    If I=0 I=find("kg",GUNITE(1..GDIMUNT)) Endif
    If I<>0
      Read [TCO]TCO0=[F:ITM]WEU;GUNITE(I)
      If !fstat [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:SDD]QTYSTU*[F:TCO]COEUOM Endif
    Endif
  Endif
Endif
If [F:ITM]EEU<>"" & [F:ITM]EEUSTUCOE<>0
  [M:DEBG]EECUNT (nolign-1) =[F:SDD]QTYSTU/[F:ITM]EEUSTUCOE
Endif
[M:DEBG]EECTRN  (nolign-1) = [F:SDH]EECTRN
[M:DEBG]EECICT  (nolign-1) = [F:SDH]EECICT
[M:DEBG]EECLOC  (nolign-1) = [F:SDH]EECLOC

Raz W_MTTHTLIN
If [F:SDD]NETPRINOT <> 0
  W_MTTHTLIN = [F:SDD]NETPRINOT*[F:SDD]QTY
Else
  #--- Si prix net = 0 on prend le prix de revient CPRPRI
  #--- ce dernier est libellé dans la devise du document, et porte sur la quantité UV
  #--- Hors ligne liée à un composant kit/sous-traité ou nomenclature
  If find([F:SDD]LINTYP,3,4,5,7,8,9,11,12,13)=0
    #--- test ici car possible appel si ctm directe
    If WTROUVE and WVALSTO=2
      W_MTTHTLIN = [F:SDD]CPRPRI*[F:SDD]QTY
    Else
      #--- On regarde d'abord le flag valeur stock du paramétrage des flux par régimes/natures
      #--CPO DM 105661 Ajout de la sous-traitance
      #--C'est mieux de faire l'init de WMVT en dehors du test sur W_MTTHTLIN
#      Raz WMVT
#      WMVT=1                                          : # Livraison classique
#      If [F:SDH]BETFCY=2   : WMVT=5 : Endif           : # Livraison inter-sites
#      If [F:SDH]BETCPY=2   : WMVT=2 : Endif           : # Livraison inter-sociétés
#      #--CPO DM 105661 Ajout de la sous-traitance
#      #If [F:SDH]SCO=2      : WMVT=4 : Endif          : # livraison pour sous-traitance
#      If [F:SDH]SCO=2 and [F:SDD]LINTYP = 1
#                             WMVT=4                   : # livraison matières pour sous-traitance
#      Endif
#      If [F:SDH]LND<>2 and [F:SDH]SCO<>2 and [F:SDD]LINTYP=10
#                             WMVT=21                  : # livraison de produit fini sous-traitance
#      Endif
#      #--/
#      If [F:SDD]FOCFLG=3   : WMVT=18: Endif           : # Livraison de gratuits
#      If [F:SDH]FFWNUM<>"" : WMVT=6 : Endif           : # Livraison export avec transit.
#      Raz WTROUVE,WVALSTO
      #--/
      Raz WTROUVE,WVALSTO
      Call FLUX_REGNAT(WMVT,[F:SDH]STOFCY,[F:FCY]CRY,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
      If WTROUVE and WVALSTO=2
        W_MTTHTLIN = [F:SDD]CPRPRI*[F:SDD]QTY
      Else
        #--- Il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes
        Raz JL0,JL1
        #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
        #JL0=find([M:DEBG]EECSCH(nolign-1),REG_CODE) :# Pour tenir compte de la modif de Reg/Nat des gratuits
        #JL1=find([M:DEBG]EECNAT(nolign-1),NAT_CODE) :# Pour tenir compte de la modif de Reg/Nat des gratuits
        #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
        Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
        If JL0>0 : Raz [F:TSC] : Endif
        # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
        If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
          Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
        Endif
        # End issue X3-131291
        Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
        If JL1>0 : Raz [F:TEC] : Endif
        # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
        If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
          Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
        Endif
        # End issue X3-131291
        If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
        #--/
          W_MTTHTLIN = [F:SDD]CPRPRI*[F:SDD]QTY
        Endif
      Endif
    Endif
  Endif
Endif

#--CPO DM 105661 Ajout de la sous-traitance
If WMVT=21
  Gosub DEBG_SDH_SST From FUNDEBB
Else
#--/
  [M:DEBG]FISAMT  (nolign-1) = W_MTTHTLIN
  #--- Prise en compte du coefficient de majoration CEE, le cas échéant
  [M:DEBG]STAAMT  (nolign-1) = W_MTTHTLIN
  If [F:BPD]BPCNUM = [F:SDH]BPCORD and [F:BPD]BPAADD = [F:SDH]BPAADD
    If [F:BPD]EECINCRAT <> 0
      [M:DEBG]STAAMT  (nolign-1) = [M:DEBG]STAAMT  (nolign-1)*[F:BPD]EECINCRAT
    Endif
  Else
    Read [BPD]BPD0=[F:SDH]BPCORD;[F:SDH]BPAADD
    If fstat : Raz [F:BPD] : Endif
    If [F:BPD]EECINCRAT <> 0
      [M:DEBG]STAAMT  (nolign-1) = [M:DEBG]STAAMT  (nolign-1)*[F:BPD]EECINCRAT
    Endif
  Endif
  #--- Prise en compte des éléments de facturation répartis sur la ligne
  WPIECE = "SDD"
  Gosub VEN_TOTDISCRG
  WDISCRGAMT   = WTOTDISCRG
  WDISCRGAMTVS = WTOTDISCRGVS
  Raz WPIECE
  # Si le total des lignes ne permet pas de proratiser,
  # il faut prendre en compte les éléments déjà éclatés sur les lignes
  If [F:SDH]DLVNOT <> 0
    #--- Il faut proratiser par rapport au [F:SDD]NETPRINOT*[F:SDD]QTY, même si = 0
    #--- car sinon, si on prend W_MTTHTLIN qui tient compte du CPRPRI,
    #--- nous risquons d'avoir un total des lignes > au [F:SDH]DLVNOT et un faux prorata !
    [M:DEBG]FISAMT(nolign-1) += ((WINVDTAAMT*([F:SDD]NETPRINOT*[F:SDD]QTY))/[F:SDH]DLVNOT) + WDISCRGAMT
    [M:DEBG]STAAMT(nolign-1) += ((WINVDTAAMTVS*([F:SDD]NETPRINOT*[F:SDD]QTY))/[F:SDH]DLVNOT) + WDISCRGAMTVS
  Else
    [M:DEBG]FISAMT(nolign-1) += WDISCRGAMT
    [M:DEBG]STAAMT(nolign-1) += WDISCRGAMTVS
  Endif
Endif :#--CPO DM 105661 Ajout de la sous-traitance

#--- Conversion de la valeur fiscale, le cas échéant
If [F:SDH]CUR <> WCUR
  WFISAMT=[M:DEBG]FISAMT(nolign-1)
  Raz STAT
  Call CONVERT([F:SDH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SDH]DLVDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
  If STAT
    Raz STAT
    Call CONVERT([F:SDH]CUR,WCUR,WCUR,[F:SDH]CHGTYP,[F:SDH]DLVDAT,WFISAMT,[M:DEBG]FISAMT(nolign-1),STAT) From TRTDEV
    If STAT
      WOK=0 :# Il n'y a pas de cours de change pour la pièce, donc les détails suivants ne seront pas traités
      Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(71,199,1),1) From GESECRAN
      Return
    Endif
  Endif
Endif
#--- Conversion de la valeur statistique, le cas échéant
If [F:SDH]CUR <> WCUR
  WSTAAMT=[M:DEBG]STAAMT(nolign-1)
  Raz STAT
  Call CONVERT([F:SDH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SDH]DLVDAT,WSTAAMT,[M:DEBG]STAAMT(nolign-1),STAT) From TRTDEV
  If STAT
    Raz STAT
    Call CONVERT([F:SDH]CUR,WCUR,WCUR,[F:SDH]CHGTYP,[F:SDH]DLVDAT,WSTAAMT,[M:DEBG]STAAMT(nolign-1),STAT) From TRTDEV
    If STAT
      WOK=0 :# Il n'y a pas de cours de change pour la pièce, donc les détails suivants ne seront pas traités
      Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(71,199,1),1) From GESECRAN
      Return
    Endif
  Endif
Endif
[M:DEBG]NIV   (nolign-1) = GNIVEXP
[M:DEBG]NBDEB=nolign

Return
#----------------------------------------------------------------------
$DEBG_DTA_SDH

Raz WPASVALO
#--- Enregistrement SIH doit exister
If [F:SIH]NUM <> [F:SID]NUM
  Read [SIH]SIH0=[F:SID]NUM
  If fstat : WPASVALO = 1 : Raz [F:SIH] : Return : Endif
Endif
#--- Uniquement les factures validées
If [F:SIH]STA <> 3 : WPASVALO = 1 : Return : Endif
#--- Uniquement s'il n'y a pas de lignes supplémentaires
# (il faut laisser la possibilité que la facture puisse être prise en compte lors du traitement des factures)
Raz WLINSUP
For [SIDW]SID0 Where NUM = [F:SID]NUM
  If [F:SIDW]SDHNUM = "" or [F:SIDW]SDHNUM <> [F:SDH]SDHNUM
    WLINSUP = 1 : Break
  Endif
Next
If WLINSUP = 0
  If [M]REG=2
    If ([F:SIH]EECNUMDEB <> 0 & [F:SIH]EECNUMDEB <> [M]EECNUMDEB) : WPASVALO = 1 : Return : Endif
  Else
    If  [F:SIH]EECNUMDEB <> 0 : WPASVALO = 1 : Return : Endif
  Endif
Endif
#----------------------------------------------------------------------
#--Cas de la ligne de livraison ayant des retours avec déduction de la facture sur livraison
#--Si toutes les lignes de retour de ce types sont datées d'avant la date d'extraction,
#--on valorise la livraison à partir de la facture (qui elle tient compte de ces retours) et
#--les lignes de retours concernées ne seront pas extraites.
Raz WTROUVE
For [SRD] Where SDHNUM=[F:SDD]SDHNUM and SDDLIN=[F:SDD]SDDLIN and RTNINVUPD=2
  Read [SRH]SRH0=[F:SRD]SRHNUM
  If fstat : Raz [F:SRH] : WTROUVE=1 : Break : Endif
  If [F:SRH]RTNDAT > [M]DEBDAT or !find([F:SRH]EECNUMDEB,0,[M]EECNUMDEB)
    WTROUVE=1
  Endif
Next
#--Si on trouve une ligne de retour avec déduction facture ou que le retour soit extrait
#--sur une autre DEB, on ne valorise pas la livraison et on extrait les lignes de retour
If WTROUVE : WPASVALO=1 : Return : Endif
#----------------------------------------------------------------------
#--- Enregistrement SIV doit exister
If [F:SIV]NUM <> [F:SID]NUM
  Read [SIV]SIV0=[F:SID]NUM
  If fstat : WPASVALO = 1 : Raz [F:SIV] : Return : Endif
Endif
WFISAMT = [F:SID]AMTNOTLIN
#--- Prise en compte de EECINCRAT
WSTAAMT = [F:SID]AMTNOTLIN
#--- Prise en compte du coefficient de majoration CEE, le cas échéant
If [F:BPD]BPCNUM = [F:SIV]BPCORD and [F:BPD]BPAADD = [F:SIV]BPAADD
 If [F:BPD]EECINCRAT <> 0
  WSTAAMT = [F:SID]AMTNOTLIN*[F:BPD]EECINCRAT
 Endif
Else
  Read [BPD]BPD0=[F:SIV]BPCORD;[F:SIV]BPAADD
  If fstat : Raz [F:BPD] : Endif
  If [F:BPD]EECINCRAT <> 0
    WSTAAMT = [F:SID]AMTNOTLIN*[F:BPD]EECINCRAT
  Endif
Endif

If [F:SID]AMTNOTLIN=0
  #--- Si prix net = 0 on prend le prix de revient CPRPRI
  #--- ce dernier est libellé dans la devise du document, et porte sur la quantité UV
  #--- Hors ligne liée à un composant kit/sous-traité ou nomenclature
  If find([F:SID]LINTYP,3,4,5,7,8,9,11,12,13)=0
    #--- On regarde d'abord le flag valeur stock du paramétrage des flux par régimes/natures
    #--CPO DM 105661 Ajout de la sous-traitance
    #--C'est mieux de faire l'init de WMVT en dehors du test sur [F:SID]AMTNOTLIN
#    Raz WMVT
#    WMVT=1                                          : # Livraison classique
#    If [F:SDH]BETFCY=2   : WMVT=5 : Endif           : # Livraison inter-sites
#    If [F:SDH]BETCPY=2   : WMVT=2 : Endif           : # Livraison inter-sociétés
#    If [F:SDH]LND=2      : WMVT=3 : Endif           : # Livraison de prêt
#    If [F:SDH]SCO=2      : WMVT=4 : Endif           : # livraison sous-traitance
#    If [F:SDD]FOCFLG=3   : WMVT=18: Endif           : # Livraison de gratuits
#    If [F:SDH]FFWNUM<>"" : WMVT=6 : Endif           : # Livraison export avec transit.
    #--/
    Raz WTROUVE,WVALSTO
    Call FLUX_REGNAT(WMVT,[F:SDH]STOFCY,[F:FCY]CRY,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
    If WTROUVE and WVALSTO=2
      If [F:SDD]SAUSTUCOE<>0
        WFISAMT = ([F:SDD]CPRPRI/[F:SDD]SAUSTUCOE)*[F:SID]QTYSTU
      Endif
    Else
      #--- Il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes
      Raz JL0,JL1
      #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
      #JL0=find([M:DEBG]EECSCH(nolign-1),REG_CODE) :# Pour tenir compte de la modif de Reg/Nat des gratuits
      #JL1=find([M:DEBG]EECNAT(nolign-1),NAT_CODE) :# Pour tenir compte de la modif de Reg/Nat des gratuits
      #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
      Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
      If JL0>0 : Raz [F:TSC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
      If JL1>0 : Raz [F:TEC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
      #--/
        If [F:SDD]SAUSTUCOE<>0
          WFISAMT = ([F:SDD]CPRPRI/[F:SDD]SAUSTUCOE)*[F:SID]QTYSTU
        Endif
      Endif
    Endif
    If WFISAMT > 0
      #Il faut convertir le montant obtenu de la devise de livraison en celle de facturation
      If [F:SDH]CUR <> [F:SIH]CUR
        WKMONTANT = WFISAMT
        Raz STAT
        Call CONVERT([F:SDH]CUR,[F:SIH]CUR,WCUR,GEECTYPCUR,[F:SDH]DLVDAT,WKMONTANT,WFISAMT,STAT) From TRTDEV
        If STAT
            Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(71,199,1),1) From GESECRAN
            WPASVALO = 1 : Return
        Endif
      Endif
      WSTAAMT = WFISAMT #--CPO DM 105661 Ajout de la sous-traitance
      #--- Prise en compte du coefficient de majoration CEE, le cas échéant
      If [F:BPD]BPCNUM = [F:SIV]BPCORD and [F:BPD]BPAADD = [F:SIV]BPAADD
        If [F:BPD]EECINCRAT <> 0
          WSTAAMT = WFISAMT*[F:BPD]EECINCRAT
        Endif
      Endif
    Endif
  Endif
Endif

#--- En-tête, nous calculons la somme des éléments de facturation de l'en-tête
#--- Eléments de facturation
# Les éléments de facturation sont présents sur les pieds des pièces autres que les factures
# Prise en compte des éléments non répartis sur les lignes : INVLINFLG = 1 ou 6,
# a condition qu'ils entrent dans le calcul de la valeur fiscale et/ou valeur statistique : CLCDEB = 2 ou 3
# puis répartition sur les lignes, au prorata des montants de chaque ligne
WNUMEROPIECE = [F:SIV]NUM
W_VCRTYP=4 # Issue 110289 - 2015-08-12 by CPO : Invoicing elements when using same counter on different documents
# Somme des éléments de facturation non répartis sur les lignes
Gosub VEN_TOTDTA
WFACDTAAMT   = WTOTDTA
WFACDTAAMTVS = WTOTDTAVS
Raz WNUMEROPIECE
Raz W_VCRTYP # Issue 110289 - 2015-08-12 by CPO
# Nous devons calculer la somme des montants HT des détails d'une pièce
# car le total ne doit pas contenir d'éléments de facturation
# AMTNOT : contient ces éléments, donc il ne pourra pas être utilisé pour la proratisation
# Nouveaux buffers
Raz WTOTAMTNOT
#--- Somme montants HT détails
For [SIDW]SID0 Where NUM=[F:SID]NUM
  WTOTAMTNOT += [F:SIDW]AMTNOTLIN
Next
W_NUM = [F:SID]NUM
#--CPO DM 105661 Ajout de la sous-traitance
If WMVT=21
  Gosub DEBG_DTA_SDH_SST From FUNDEBB
Else
  #--/
  #--- Nous traitons la ligne de détail facture liée au détail de réception
  #--- Calcul de la somme des éléments de facturation répartis sur les lignes
  # Attention :
  # Chaque DISCRGAMTx sera pris en compte si l'élément de facturation duquel il provient a CLCDEB > 1
  # De plus les éléments peuvent rentrer différement dans le calcul de la valeur fiscale et/ou de la valeur statistique
  WPIECE = "SID"
  Gosub VEN_TOTDISCRG
  WFACDISCRG   = WTOTDISCRG
  WFACDISCRGVS = WTOTDISCRGVS
  Raz WPIECE
  # Si le total des lignes ne permet pas de proratiser,
  # il faut prendre en compte les éléments déjà éclatés sur les lignes
  If WTOTAMTNOT <> 0
    #--CPO DM 105661 Ajout de la sous-traitance
    WFISAMT += ((WFACDTAAMT  *[F:SID]AMTNOTLIN)/WTOTAMTNOT) + WFACDISCRG
    WSTAAMT += ((WFACDTAAMTVS*[F:SID]AMTNOTLIN)/WTOTAMTNOT) + WFACDISCRGVS
  Else
    WFISAMT += WFACDISCRG
    WSTAAMT += WFACDISCRGVS
  Endif
Endif :#--CPO DM 105661 Ajout de la sous-traitance

#--- Conversion de la valeur fiscale, le cas échéant
If [F:SIH]CUR <> WCUR
  WMONTANT = WFISAMT
  Raz STAT
  Call CONVERT([F:SIH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SIH]ACCDAT,WMONTANT,WFISAMT,STAT) From TRTDEV
  If STAT
    Raz STAT
    Call CONVERT([F:SIH]CUR,WCUR,WCUR,[F:SIH]CURTYP,[F:SIH]ACCDAT,WMONTANT,WFISAMT,STAT) From TRTDEV
    If STAT
      Call ECR_TRACE(mess(742,197,1)-[F:SIH]NUM-mess(71,199,1),1) From GESECRAN
      WPASVALO = 1 : Return
    Endif
  Endif
Endif
#--- Conversion de la valeur statistique, le cas échéant
If [F:SIH]CUR <> WCUR
  WMONTANT = WSTAAMT
  Raz STAT
  Call CONVERT([F:SIH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SIH]ACCDAT,WMONTANT,WSTAAMT,STAT) From TRTDEV
  If STAT
    Raz STAT
    Call CONVERT([F:SIH]CUR,WCUR,WCUR,[F:SIH]CURTYP,[F:SIH]ACCDAT,WMONTANT,WSTAAMT,STAT) From TRTDEV
    If STAT
      Call ECR_TRACE(mess(742,197,1)-[F:SIH]NUM-mess(71,199,1),1) From GESECRAN
      WPASVALO = 1 : Return
    Endif
  Endif
Endif
WFISAMTDTA += WFISAMT : Raz WFISAMT
WSTAAMTDTA += WSTAAMT : Raz WSTAAMT
#--- Recherche si existe des avoirs ayant comme origine une facture liée à ma livraison
#--- Le cas échéant, il faut prendre en compte le montant de cet(ces) avoirs(s) dans la valorisation de ma livraison pour la DEB
#--- uniquement si le paramètre général "EECVALOCPL" est à "Oui"
#CPO 06/03/09 (vu avec CH)
#les avoirs de ventes ne doivent pas impacter la valeur de la livraison
#puisqu’ils sont déclarés comme des régularisations financières
#If GEECVALOCPL=2
#  For [SIDC] Where SIHORINUM=[F:SIH]NUM & SIDORILIN=[F:SID]SIDLIN and SRHNUM = "" :# pour éviter de prendre en compte des avoirs sur retours arrivés après la facture de livr

#  Next
#  If WPASVALO = 1 : Return : Endif
#Endif

Return
#######################################################################
# Ventes : Retours clients
#----------------------------------------------------------------------
$EEC_SRH

WUPDFIL="SRH" : WFLO=1
WUPDTYP=12 :# Introduction Ventes - utilisé dans les points d'entrée (conformité versions antérieures)

Call ECR_TRACE(string$(70,"-"),0) From GESECRAN
Call ECR_TRACE(mess(624,197,1),0) From GESECRAN
Call ECR_TRACE(string$(70,"-"),0) From GESECRAN

CRITERE  = '[F:SRH]RTNDAT<=[M]DEBDAT'                : # Date retour < ou = a selection
CRITERE += ' & [F:SRH]CPY=[M]CPY'

If [M]REG=2
  CRITERE += '& ([F:SRH]EECNUMDEB=[M]EECNUMDEB | [F:SRH]EECNUMDEB=0)'
Else
  CRITERE += '& [F:SRH]EECNUMDEB=0'
Endif

Gosub ALIFILSUP

# For [SRH]SRH2 Where (evalue(CRITERE) & evalue(FILSUP))
#--- Afin de lire les pièces dans l'ordre
Filter [SRH] Where (evalue(CRITERE) & evalue(FILSUP)) Order By RTNDAT Asc;SRHNUM Asc
For [SRH]
  # Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
  Raz WVCRNUMVALO
  Raz WVCRLINVALO
  Gosub CTL_EEC
  If WOK=0 : Goto NEXT_SRH : Endif

  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacement du test valeurs vides dans EECSCH et EECNAT
  #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
#  If [F:SRH]EECSCH="" and [F:SRH]EECNAT=""
#    If [M]PRNULREGNA=2
#      Call ECR_TRACE(mess(735,197,1)-[F:SRH]SRHNUM-mess(746,197,1),0) From GESECRAN
#    Endif
#    Goto NEXT_SRH
#  Endif
  [L]W_ISEMPTY_EEC_SCH_NAT = 0
  If [F:SRH]EECSCH="" and [F:SRH]EECNAT=""
    [L]W_ISEMPTY_EEC_SCH_NAT = 1
  Endif
  #--/
  #--- Type de mouvement
  WMVT=12                                     : # Retour client
  If [F:SRH]LNDRTN=2 : WMVT=13 : Endif        : # Retour de prêt
  #DM52929
  If [F:SRH]SCORTN=2 : WMVT=19 : Endif       : # Retour matière de sous-traitance
  # Afin de retrouver les bons numéros en cas de rollback
  WOLDLININT = WNOLININT
  WOLDLINEXP = WNOLINEXP
  Call DEBTRANS From GLOCK
  Trbegin [DEB]
  #--- Prise en compte des éléments de l'entête de pièce, puis de chaque ligne de détail
  Gosub EEC_UN_SRH
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Déplacement du test valeurs vides EECSCH et EECNAT après le parcours des lignes
  #--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
  #--- Si Régime et Nature sont vides, la ligne n'est pas extraite
  If [L]W_ISEMPTY_EEC_SCH_NAT = 1
    #--Si, après parcours des lignes, le flag est toujours à 1, on passe à la pièce suivante
    #--Il passe à 0 si au moins une ligne permets d'alimenter les régimes/natures spéciaux
    If [M]PRNULREGNA=2
      Call ECR_TRACE(mess(735,197,1)-[F:SRH]SRHNUM-mess(746,197,1),0) From GESECRAN
    Endif
    WOK=0
  Endif
  #--/
  If WOK=0 : Gosub AB_DEB : Goto NEXT_SRH : Endif
  #--- Ecriture des éléments du masque DEBGEN dans le fichier DEB
  Gosub EEC_DEBGEN
  If WOK=0 : Gosub AB_DEB : Goto NEXT_SRH : Endif
  #--- On met à jour le champ EECNUMDEB si l'écriture dans le fichier DEB a réussi
  # Uniquement si au moins une ligne a été renseignée dans le masque de génération
  If [M:DEBG]NBDEB > 0
    W_NUMPIECE = [F:SRH]SRHNUM
    If W_NUMPIECE <> ""
      #--- Maj no traitement dans la pièce de réception
      Update [SRH] Where SRHNUM = W_NUMPIECE With EECNUMDEB = [M]EECNUMDEB
      If fstat
        Call FSTA("SRH") From GLOCK
        Gosub AB_DEB
        Goto NEXT_SRH
      Endif
      Raz W_NUMPIECE
    Endif
  Else
    Gosub AB_DEB
    Goto NEXT_SRH
  Endif

  Call ECR_TRACE(mess(624,197,1)-[F:SRH]SRHNUM-mess(296,197,1),0) From GESECRAN

  Commit
$NEXT_SRH
Next
Filter [SRH]

Return
#----------------------------------------------------------------------
$EEC_UN_SRH
WOK=1
W_COMPOSE_RETOUR_LIVR = 0 #--CPO DM 105661 Ajout de la sous-traitance
nolign=0
#--- Chargement du masque DEBGEN
For [SRD] Where SRHNUM=[F:SRH]SRHNUM
  WOKLIG = 1
  W_CHANGED_MVT=0 :#--CPO DM 105661 Ajout de la sous-traitance
  #--CPO 106690 Cas de deux lignes de type "divers", n'ayant pas d'article et qui se suivent
  If [F:SRD]ITMREF="" :  Goto NEXT_EEC_UN_SRH : Endif
  #--/
  If [F:ITM]ITMREF <> [F:SRD]ITMREF
    Read [F:ITM]ITM0=[F:SRD]ITMREF
    If fstat : Raz [F:ITM] : Goto NEXT_EEC_UN_SRH : Endif
  Endif
  #--- Si l'article n'est pas "Soumis à la DEB", on saute la ligne de détail
  If [F:ITM]EECGES <> 2
    #--CPO 74679 Amélioration de la trace
    WMESS_CODE=3 : WMESS_TRACE=mess(735,197,1)-[F:SRD]SRHNUM-num$([F:SRD]SRDLIN)-[F:ITM]ITMREF : Gosub MESS_TRACE
    #--CPO
    Goto NEXT_EEC_UN_SRH
  Endif
  #-----------------------------------------------------------------------------------
  #--CPO DM 105661 Ajout de la sous-traitance
  #---on extrait uniquement les lignes de type "Nomenclature composé"
  #---et celles "Standard"
  If [SRD]SDHNUM<>"" and [SRD]SDDLIN>0
    If [SDD]SDHNUM<>[SRD]SDHNUM or [SDD]SDDLIN<>[SRD]SDDLIN
      Read [F:SDD]SDD0=[SRD]SDHNUM;[SRD]SDDLIN
      If fstat : Raz [F:SDD] : Endif
    Endif
    If find([F:SDD]LINTYP,11,12,13)>0
      If W_COMPOSE_RETOUR_LIVR = 1
        #--CPO 74679 Amélioration de la trace
        WMESS_CODE=4 : WMESS_TRACE=mess(735,197,1)-[F:SRD]SRHNUM-num$([F:SRD]SRDLIN) : Gosub MESS_TRACE
        #--CPO
        Goto NEXT_EEC_UN_SRH
      Endif
    Elsif [F:SDD]LINTYP=10
      #--Ligne de composé ayant comme origine une livraison
      W_COMPOSE_RETOUR_LIVR = 1
    Else
      #--Nous avons rencontré une ligne normale, on remet à 0 le flag composé
      W_COMPOSE_RETOUR_LIVR = 0
    Endif
  Else
    #--Nous avons rencontré une ligne non liée à une livraison, on remet le flag à 0
    W_COMPOSE_RETOUR_LIVR = 0
  Endif
  #--/
  #--Cas des retours avec déduction des factures sur livraison
  #--ces lignes ne sont pas déclarées si la livraison est sur la même extraction
  #--et qu'elle soit facturée
  #--et que tous les autres retours de ce type datent d'avant l'extraction
  If [F:SRD]RTNINVUPD=2
     Read [SDH]SDH0=[F:SRD]SDHNUM
     If fstat : Raz [F:SDH] : Endif
     If [F:SDH]SIHNUM<>"" and [F:SDH]EECNUMDEB=[M]EECNUMDEB
        Raz WTROUVE
        #--la livraison doit avoir été valorisée à partir de la facture
        Look [F:DEB]DEB1=[M:DIA]CPY;4;[F:SRD]SDHNUM;[F:SRD]SDDLIN;2
        If !fstat
          Read [F:DEB]DEB1 Curr
          If fstat : Raz [F:DEB] : Endif
          If [F:DEB]LINVALOFLG=2
            # Issue X3-66286 - 2017-12-28 by CPO : Wrong EEC exchange declaration if a pro forma exists
            #--in case of proforma, there are more then one invoice line entry
            #For [SID]SID3 Where SDHNUM=[F:SRD]SDHNUM and SDDLIN=[F:SRD]SDDLIN
            For [SID]SID3 Where SDHNUM=[F:SRD]SDHNUM and SDDLIN=[F:SRD]SDDLIN and NUM=[F:SDH]SIHNUM
            # End issue X3-66286
              If fstat : Raz [F:SID] : Endif
              WINDICE=find([F:SID]NUM,[F:DEB]VCRNUMVALO)
              If (WINDICE>0 and find([F:SID]SIDLIN,[F:DEB]VCRLINVALO(WINDICE-1)))
                #--tous les autres retours de ce type de cette livraison doivent dater d'avant l'extraction
                For [SRDW] Where SDHNUM=[F:SRD]SDHNUM and SDDLIN=[F:SRD]SDDLIN and RTNINVUPD=2
                  Read [SRHW]SRH0=[F:SRDW]SRHNUM
                  If fstat : Raz [F:SRHW] : WTROUVE=1 : Break : Endif
                  If [F:SRHW]RTNDAT > [M]DEBDAT or !find([F:SRHW]EECNUMDEB,0,[M]EECNUMDEB)
                    WTROUVE=1 : Break
                  Endif
                Next
                #--Si date d'un des retours de ce type est suppérieure à la date d'extraction ou
                #--qu'il ait été extrait sur une autre DEB,
                #--on extrait la lignes de retour
                If WTROUVE=1 : Break : Endif
              Endif
            Next
            If WTROUVE=0 : Goto NEXT_EEC_UN_SRH : Endif
          Endif
        Endif
     Endif
  Endif
  #-----------------------------------------------------------------------------------
  #--- Prise en compte du paramètre permettant de retarder la déclaration des
  #--- retours en attente d'avoir
  If [F:SRD]RTNCNOFLG=2 and [F:SRD]SIHNUM=""
   # FQ 52820 - sauf inter-sites, sauf sous-traitance
   If ([F:SRH]BETFCY<>2 or [F:SRH]BETCPY=2) and [F:SRH]SCORTN <> 2
    If [F:SRH]RTNDAT>[M]DEBDAT-GEECEXTDELA
      #--CPO 74679 Amélioration de la trace
      WMESS_CODE=2 : WMESS_TRACE=mess(735,197,1)-[F:SRD]SRHNUM-num$([F:SRD]SRDLIN) : Gosub MESS_TRACE
      #--CPO
      Goto NEXT_EEC_UN_SRH
    Endif
   Endif
  Endif

  #FQ 56398 (suite de 51074) - Point d'entrée pour gérer des contrôles à la ligne
  Local Integer SAUVGPE     : SAUVGPE=GPE : GPE=0
  #La variable GPE permet d'accepter ou de refuser la ligne
  # 0 -> la ligne est acceptée
  # 1 -> la ligne est refusée, on passe à la suivante
  GPOINT="DEBCTLLIG" : Gosub ENTREE From EXEFNC
  If GPE : GPE=SAUVGPE : Goto NEXT_EEC_UN_SRH : Endif
  #FQ 56398

  nolign +=1
  #--- Chargement du masque avec les éléments de la ligne
  Gosub DEBG_SRH
  # Si un détail ne peut être pris en compte, alors on ne prend pas en compte la pièce non plus
  # Présence du n° d'identification CEE du tiers
  If WOK = 0  : Break : Endif
  If WOKLIG=0 : nolign -= 1 : Goto NEXT_EEC_UN_SRH : Endif
  #--- Valorisation Avoirs origine Retour
  # Si le détail est facturé, alors nous prenons en compte les éléments de l'avoir pour le calcul de la valeur fiscale et/ou stat
  # seulement dans le cas où il y a différence avec ce qui a été calculé depuis la ligne de retour
  # Attention : sur les retours il n'y a pas d'éléments de facturation.
  #--- Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
  Raz WNOLINVALO
  If [F:SRD]SIHNUM<>""                             : # si avoir sur le retour
    Raz WFACDTAAMT, WFACDTAAMTVS, WFISAMTDTA, WSTAAMTDTA, W_NUM, WTOTAMTNOT, WMAJ, WPASVALO, WTRNOK
    #--- valorisation avec les lignes facturées
    Read  [SID]SID0=[F:SRD]SIHNUM;[F:SRD]SIDLIN
    If fstat : Raz [F:SID] : Endif
    If !fstat
      If ([M]REG=1 & [F:SID]LINEECFLG <> 2) | [M]REG=2
        Gosub DEBG_DTA_SRH                      : #prise en compte des éléments de facturation
        If WPASVALO = 0
          #--- Valeur fiscale valorisée avec les éléments de la facture
          If WFISAMTDTA <> 0 and WFISAMTDTA <> [M:DEBG]FISAMT(nolign-1)
            WMAJ=1
          Endif
          #--- Valeur statistique valorisée avec les éléments de la facture
          If WSTAAMTDTA <> 0 and WSTAAMTDTA <> [M:DEBG]STAAMT(nolign-1)
            WMAJ=1
          Endif
          # If WMAJ
            #--- Renseignement des pièces prises en compte lors de la valorisation
            WINDICE=find([F:SID]NUM,WVCRNUMVALO(0..14,nolign-1))
            If WINDICE<=0 or (WINDICE>0 and !find([F:SID]SIDLIN,WVCRLINVALO(WINDICE-1,nolign-1)))
              WNOLINVALO = 1
              WVCRNUMVALO(WNOLINVALO-1,nolign-1)=[F:SID]NUM
              WVCRLINVALO(WNOLINVALO-1,nolign-1)=[F:SID]SIDLIN
            Endif
            If WMAJ
              W_NUMPIECE   = [F:SID]NUM
              W_NUMLINPIEC = [F:SID]SIDLIN
              Update [SID] Where NUM=W_NUMPIECE and SIDLIN=W_NUMLINPIEC With LINEECFLG = 2
              If fstat : Call FSTA("SID") From GLOCK : WTRNOK = 1 : Endif
            Endif
            #--- Mise à jour EECNUMDEB de l'entête de l'avoir
            If WTRNOK = 0
              If WMAJ
                # Uniquement s'il n'y a pas de lignes supplémentaires
                # (il faut laisser la possibilité que l'avoir puisse être pris en compte lors du traitement des factures)
                Raz WLINSUP
                For [SIDW]SID0 Where NUM = [F:SIH]NUM
                  If [F:SIDW]SRHNUM = "" or [F:SIDW]SRHNUM <> [F:SRH]SRHNUM
                    WLINSUP = 1 : Break
                  Endif
                Next
                #------------------------------
                #---et si l'avoir n'a pas un n° d'extraction différent
                #---(cas d'un avoir sur retour arrivé après l'extraction du retour
                #--- et qui a été extrait ultérieurement en donnant un flux de Régul)
                If WLINSUP = 0 and ([F:SIH]EECNUMDEB=0) :# or [F:SIH]EECNUMDEB=[M]EECNUMDEB)
                  Update [SIH] Where NUM=[F:SID]NUM With EECNUMDEB=[M]EECNUMDEB
                  If fstat : Call FSTA("SIH") From GLOCK : WTRNOK = 1 : Endif
                Endif
              Endif
            Endif
            If WTRNOK
              WOK = 0 : Break
            Else
              #--- Valeur fiscale valorisée avec les éléments de la facture
              If WFISAMTDTA <> 0 and WFISAMTDTA <> [M:DEBG]FISAMT(nolign-1)
                [M:DEBG]FISAMT(nolign-1) = WFISAMTDTA
                [M:DEBG]LINVALOFLG(nolign-1)=2
              Endif
              #--- Valeur statistique valorisée avec les éléments de la facture
              If WSTAAMTDTA <> 0 and WSTAAMTDTA <> [M:DEBG]STAAMT(nolign-1)
                [M:DEBG]STAAMT(nolign-1) = WSTAAMTDTA
                [M:DEBG]LINVALOFLG(nolign-1)=2
              Endif
            Endif
          # Endif :# fin MAJ
        Endif
      Endif
    Endif
  Endif
  #--- Fin Valorisation factures origine Livraison

$NEXT_EEC_UN_SRH
Next

If WOK=0 : Return : Endif
If nolign = 0 : WOK = 0 : Return : Endif

Return
#----------------------------------------------------------------------
$DEBG_SRH
If nolign=1
  Raz [M:DEBG]
  [M:DEBG]CPY       = [M:DIA]CPY
  [M:DEBG]CUR       = [F:CPY]ACCCUR
  [M:DEBG]EECNUMDEB = [M:DIA]EECNUMDEB
  [M:DEBG]DEBDAT    = [M:DIA]DEBDAT
  [M:DEBG]VCRTYP    = 13
  [M:DEBG]VCRNUM    = [F:SRH]SRHNUM
  [M:DEBG]DAT       = [F:SRH]RTNDAT
  [M:DEBG]CURDOC    = [F:SRD]CUR       :# Attention il peut y avoir une devise différente par ligne de détail
  [M:DEBG]BPRNUM  = [F:SRH]BPCINV
  If [F:SRH]BPIEECNUM<>""
    [M:DEBG]EECNUM = [F:SRH]BPIEECNUM
  Else
    Read [BPR]BPR0=[F:SRH]BPCINV
    If fstat : Raz [F:BPR] : Endif
    If [F:BPR]EECNUM <> ""
      [M:DEBG]EECNUM  = [F:BPR]EECNUM
    Endif
  Endif
  #FQ 52621
  #--- Cas du n° de TVA issu du pays de réception
  If [M:DEBG]EECNUM <> ""
    If left$([M:DEBG]EECNUM,2)=W_EECCRYTO
      Call ECR_TRACE(mess(735,197,1)-[F:SRH]SRHNUM,0) From GESECRAN
      # "Radical du numéro de TVA identique à celui du site de réception"
      Call ECR_TRACE(mess(751,197,1),0) From GESECRAN
    Endif
  Endif
  If [F:SRH]STOFCY<>""
    If [F:FCY]FCY<>[F:SRH]STOFCY
      Read [FCY]FCY0=[F:SRH]STOFCY
      If fstat : Raz [F:FCY] : Endif
    Endif
    Read [BPA]BPA0=3;[F:SRH]STOFCY;[F:FCY]BPAADD
    If fstat : Raz [F:BPA] : Endif
    If [F:BPA]POSCOD<>""
      [M:DEBG]REG (0) = left$([F:BPA]POSCOD,2)
    Endif
  Endif
Endif
#--- Site de stockage
[M:DEBG]STOFCY  (nolign-1) = [F:SRH]STOFCY
[M:DEBG]CRYFCY  (nolign-1) = W_EECCRYTO
#--- Etat fédéral
If dim([M:DEBG]STAFED)>0
  Raz WSTAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
  Read [ITF]ITF0=[F:SRD]ITMREF;[F:SRH]STOFCY
  If fstat : Raz [F:ITF] : Endif
  If dim([F:ITF]STAFED)<>0 and [F:ITF]STAFED<>""
    WSTAFED=[F:ITF]STAFED #[M:DEBG]STAFED(nolign-1)=[F:ITF]STAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
  Else
    If dim([F:ITM]STAFED)>0 and [F:ITM]STAFED<>""
      WSTAFED=[F:ITM]STAFED #[M:DEBG]STAFED(nolign-1)=[F:ITM]STAFED # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
    Endif
  Endif
  Gosub SET_M_DEBG_STAFED From FUNDEBA # Issue X3-122251 - 2019-05-16 by CPO : BE-Intrastat_declaration
Endif
#---
[M:DEBG]VCRLIN  (nolign-1) = [F:SRD]SRDLIN
[M:DEBG]FLO     (nolign-1) = 1
[M:DEBG]ITMREF  (nolign-1) = [F:SRD]ITMREF
[M:DEBG]ITMDES1 (nolign-1) = [F:SRD]ITMDES1
[M:DEBG]CUSREF  (nolign-1) = [F:ITM]CUSREF
#--CPO DM 105661 Ajout de la sous-traitance
#--Déplacé après l'init par la sous-traitance
#[M:DEBG]EECNAT  (nolign-1) = [F:SRH]EECNAT
#[M:DEBG]EECSCH  (nolign-1) = [F:SRH]EECSCH
#--/
If W_EECCRYFFW<>""  [M:DEBG]DESCRY (nolign-1) = W_EECCRYFFW
  Else              [M:DEBG]DESCRY (nolign-1) = W_EECCRYFROM
Endif
#--CPO DM 105661 Ajout de la sous-traitance
WMVT=12                                    : # Retour client
If [F:SRH]LNDRTN=2 : WMVT=13 : Endif       : # Retour de prêt
#DM52929
If [F:SRH]SCORTN=2 : WMVT=19 : Endif       : # Retour matière de sous-traitance
#--/
Raz WVALSTO,WTROUVE
#--- Le pays d'origine est celui du site d'expédition d'origine
If [F:SRD]SDHNUM <> ""
  #--- Ligne issue de livraison
  Read [SDD]SDD0=[F:SRD]SDHNUM;[F:SRD]SDDLIN
  If fstat : Raz [F:SDD] : Endif
  Read [SDH]SDH0=[F:SRD]SDHNUM
  If fstat : Raz [F:SDH] : Endif
  If [F:SDH]STOFCY <> ""
    Read [FCY]FCY0=[F:SDH]STOFCY
    If fstat : Raz [F:FCY] : Endif
  Else
    If [F:FCY]FCY<>[F:SRH]STOFCY
      Read [FCY]FCY0=[F:SRH]STOFCY
      If fstat : Raz [F:FCY] : Endif
    Endif
  Endif
  #--CPO DM 105661 Ajout de la sous-traitance
  #--Le retour client de produit fini sous-traitance n'est pas clairement identifié dans SRETURND
  #--Le seul moyen de voir est de tester le LINTYP=10 de la ligne de livraison à l'origine du retour
  If [F:SDD]LINTYP=10 and [F:SRH]SCORTN<>2 and [F:SRH]LNDRTN<>2
    Raz WEECNAT,WEECSCH
    W_COMPOSE_RETOUR_LIVR=1
    WMVT=24                   : # Retour client produit fini sous-traitance
    Call FLUX_REGNAT(WMVT,[F:SRH]STOFCY,[F:FCY]CRY,WEECSCH,WEECNAT,WVALSTO,WTROUVE) From FUNDEBA
    #Il faut avoir un régime et une nature de renseignés.
    If WTROUVE=1 and (WEECSCH<>"" or WEECNAT<>"")
      Call ECR_TRACE(mess(735,197,1)-[F:SRH]SRHNUM-num$([F:SRD]SRDLIN),0) From GESECRAN
      # Retour client produit fini sous-traitance : le Régime CEE et/ou la Nature ont été modifiés
      Call ECR_TRACE(mess(24,2236,1)-":"-mess(752,197,1),0) From GESECRAN
      W_CHANGED_MVT=1
    Else
# A CONFIRMER
#      #--- Si ligne de sous-traitance et si pas de paramétrage permettant pas l'extraction de ces derniers,
#      #--- on ne prend pas en compte la ligne
#      WOKLIG=0 : Return
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG and error if setup non found/inactive
      Call ECR_TRACE(mess(735,197,1)-[F:SRH]SRHNUM-num$([F:SRD]SRDLIN),0) From GESECRAN
      Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(909,197,1)-"/"+mess(910,197,1)-mess(911,197,1),1) From GESECRAN
      WOKLIG=0 : Return
      # End issue X3-131291
    Endif
  Endif
  # X3-64479 : Be able to create non invoiceable deliveries from project tasks / X3-137210 (LD 12/09/19)
  # Return line of a non-billable delivery
  If [F:SDH]SDHCAT=4
    Raz WEECNAT,WEECSCH
    WMVT=26                   : # Retour non facturable / Non billable return
    Call FLUX_REGNAT(WMVT,[F:SRH]STOFCY,[F:FCY]CRY,WEECSCH,WEECNAT,WVALSTO,WTROUVE) From FUNDEBA
    # Il faut avoir un régime et une nature renseignés
    # Statistial rule / Transaction nature have to be fed
    If WTROUVE=1 and (WEECSCH<>"" or WEECNAT<>"")
      Call ECR_TRACE(mess(735,197,1)-[F:SRH]SRHNUM-num$([F:SRD]SRDLIN),0) From GESECRAN
      # Retour non facturable : le Régime CEE et/ou la Nature ont été modifiés
      # Non billable return : The EU rule and/or the Nature have been modified
      Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(752,197,1),0) From GESECRAN
      W_CHANGED_MVT=1
    Else
      # Si pas de paramétrage, on ne prend pas en compte la ligne
      # Retour non facturable : Régime statistique et/ou Nature transaction non paramétrés pour le mouvement ou données désactivées
      # Non billable return : The statistical rule and/or transaction type is not set up for the movement or the data is disable
      Call ECR_TRACE(mess(735,197,1)-[F:SRH]SRHNUM-num$([F:SRD]SRDLIN),0) From GESECRAN
      Call ECR_TRACE(mess(WMVT,2236,1)-":"-mess(911,197,1),1) From GESECRAN
      WOKLIG=0 : Return
    Endif
  Endif
  # X3-64479 : Be able to create non invoiceable deliveries from project tasks / X3-137210 (LD 12/09/19)
  #--/
Else
  #--- Retour direct
  Read [FCY]FCY0=[F:SRH]STOFCY
  If fstat : Raz [F:FCY] : Endif
Endif
If [F:FCY]CRY<>""
  LCRY=[F:FCY]CRY
  Gosub LEC_TCY
  If [F:TCY]EECFLG=2 & [F:TCY]EECCOD<>""
    [M:DEBG]ORICRY(nolign-1)=[F:TCY]EECCOD
  Else
    [M:DEBG]ORICRY(nolign-1)=[F:TCY]ISO
  Endif
Endif

#--CPO DM 105661 Ajout de la sous-traitance
#--Déplacé après l'init par la sous-traitance
If W_CHANGED_MVT=1
  [M:DEBG]EECNAT  (nolign-1) = WEECNAT
  [M:DEBG]EECSCH  (nolign-1) = WEECSCH
Else
  [M:DEBG]EECNAT  (nolign-1) = [F:SRH]EECNAT
  [M:DEBG]EECSCH  (nolign-1) = [F:SRH]EECSCH
Endif
#--/
#--CPO DM 105661 Ajout de la sous-traitance
#--Déplacement du test valeurs vides dans EECSCH et EECNAT
#--Etant donné que potentiellement il est possible de les modifier pour les flux spéciaux
#--- Si Régime et Nature sont vides, la ligne n'est pas extraite
If [M:DEBG]EECSCH  (nolign-1)<>"" or [M:DEBG]EECNAT  (nolign-1)<>""
  [L]W_ISEMPTY_EEC_SCH_NAT = 0
Else
  If [M]PRNULREGNA=2 and W_ISEMPTY_EEC_SCH_NAT=0
    Call ECR_TRACE(mess(735,197,1)-[F:SRD]SRHNUM-num$([F:SRD]SRDLIN)-[F:SRD]ITMREF-mess(746,197,1)
&    -mess(744,197,1)-mess(745,197,1),0) From GESECRAN
  Endif
  WOKLIG=0 : Return
Endif
#--/

#--CPO 94689 Intrastat for Customer returns with nil quantity
If [F:SRD]QTY=0
  #--Si la quantité retour est à 0, la ligne n'est pas extraite
  WOKLIG=0
  WMESS_CODE=8 : WMESS_TRACE=mess(735,197,1)-[F:SRD]SRHNUM-num$([F:SRD]SRDLIN)-[F:SRD]ITMREF : Gosub MESS_TRACE
  Return
Elsif ([F:SRD]QTY<[F:SRD]EXTQTY and [F:SRD]SIHNUM="") or
&     (find(2,[F:SDH]LND,[F:SDH]SCO)>0 and [F:SRD]QTY<[F:SRD]DLVQTY and [F:SRD]SIHNUM="")
  #--Si la quantité retour est < à la qté retour prévue,
  #--la ligne est extraite, mais on affiche quand même un message warning
  WMESS_CODE=9 : WMESS_TRACE=mess(735,197,1)-[F:SRD]SRHNUM-num$([F:SRD]SRDLIN)-[F:SRD]ITMREF : Gosub MESS_TRACE
Endif
#--/

[M:DEBG]REG     (nolign-1) = [M:DEBG]REG(0)
If [F:ITM]ITMWEI<>0
  If toupper(left$([F:ITM]WEU,2))="KG"
    [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:SRD]QTYSTU
  Else
    I=find("KG",GUNITE(1..GDIMUNT))
    If I=0 I=find("Kg",GUNITE(1..GDIMUNT)) Endif
    If I=0 I=find("kg",GUNITE(1..GDIMUNT)) Endif
    If I<>0
      Read [TCO]TCO0=[F:ITM]WEU;GUNITE(I)
      If !fstat [M:DEBG]NETMAS (nolign-1) = [F:ITM]ITMWEI*[F:SRD]QTYSTU*[F:TCO]COEUOM Endif
    Endif
  Endif
Endif
If [F:ITM]EEU<>"" & [F:ITM]EEUSTUCOE<>0
  [M:DEBG]EECUNT (nolign-1) =[F:SRD]QTYSTU/[F:ITM]EEUSTUCOE
Endif
[M:DEBG]EECTRN  (nolign-1) = [F:SRH]EECTRN
[M:DEBG]EECICT  (nolign-1) = [F:SRH]EECICT
[M:DEBG]EECLOC  (nolign-1) = [F:SRH]EECLOC

Raz W_MTTHTLIN
#--CPO DM 105661 Ajout de la sous-traitance
#--de la ligne de livraison d'origine
If WMVT=24
  #--Cas de la ligne de retour de produit fini
  #--c'est la somme des lignes composants (hors matières fournies)
  #--Chercher les lignes de composants (hors matières fournies)
  #--Sur la ligne de livraison à l'origine de la ligne de retour
  #TODO
  Gosub DEBG_SRH_SST From FUNDEBB
  If WOKLIG=0 : Return : Endif # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG and error if setup non found/inactive
Else
#--/
  If [F:SRD]NETPRINOT <> 0
    W_MTTHTLIN = [F:SRD]NETPRINOT*[F:SRD]QTY
    If W_MTTHTLIN > 0
      #--- Conversion du montant, le cas échéant
      If [F:SRD]CUR<>"" and [F:SRD]CUR <> WCUR
        WFISAMT=W_MTTHTLIN
        Raz STAT
        Call CONVERT([F:SRD]CUR,WCUR,WCUR,GEECTYPCUR,[F:SRD]RTNDAT,WFISAMT,W_MTTHTLIN,STAT) From TRTDEV
        If STAT
          WOK=0
          Call ECR_TRACE(mess(735,197,1)-[F:SRH]SRHNUM-mess(71,199,1),1) From GESECRAN
          Return
        Endif
      Endif
    Endif
  Else
    #--- Si prix net à 0, on prend le PRIORD
    #--- PRIORD - devise de la société => ne nécéssite pas de conversion (extraction DEB par société)
    #--- CONVERSION A FAIRE => au moment ou on valorisera les élements de facturation (qui seront dans la devise du document) !!!
    #--- prix valable pour 1 US => il faut prendre [F:SRD]QTYSTU
    #--- Il faut tenir compte du paramétrage "Valeur stock" du paramétrage des flux
    Raz WTROUVE
    Raz WVALSTO
    #Type de flux - WMVT est positionné dans l'entête
    #--- Type de flux
    Call FLUX_REGNAT(WMVT,[F:SRH]STOFCY,W_CRYTO,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
    If WTROUVE=1 and WVALSTO=2
        W_MTTHTLIN = [F:SRD]PRIORD*[F:SRD]QTYSTU
    Else
      #--- Si la valeur stock dans les flux est à "Non", on tient compte du paramétrage "Valeur stock" des Régimes et/ou Natures
      Raz JL0,JL1
      #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
      #JL0=find([F:SRH]EECSCH,REG_CODE)
      #JL1=find([F:SRH]EECNAT,NAT_CODE)
      #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
      #--CPO DM 105661 Ajout de la sous-traitance
      #--Il faut utiliser les infos de M:DEBG
      Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
      If JL0>0 : Raz [F:TSC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
      If JL1>0 : Raz [F:TEC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
      #--/
        W_MTTHTLIN = [F:SRD]PRIORD*[F:SRD]QTYSTU
      Endif
    Endif
  Endif
  #--- Retour de prêt
  #--- si le prix du mvt de retour est à 0, on prend celui de la ligne de livraison
  #--- ATTENTION : pas de valorisation des élts de facturation de la livraison
  If ([F:SRH]LNDRTN=2) and (W_MTTHTLIN <= 0)
    If [F:SRD]SDHNUM <> "" and [F:SDD]SDHNUM=[F:SRD]SDHNUM and [F:SDD]SDDLIN=[F:SRD]SDDLIN
      #--- la ligne de livraison à été lue avant lors de la recherche du pays d'origine
      Read [SDH]SDH0=[F:SRD]SDHNUM
      If fstat : Raz [F:SDH] : Endif
      If [F:SDD]NETPRINOT <> 0
        #le prix net de la ligne de livraison est pour 1 UV
        #il faut transformer l'UV en US et prendre celui ci pour les quantités en US de retour
        If [F:SDD]QTYSTU<>0
          W_MTTHTLIN = (([F:SDD]NETPRINOT*[F:SDD]QTY)/[F:SDD]QTYSTU)*[F:SRD]QTYSTU
        Endif
      Else
        #--- Si prix net = 0 on prend le prix de revient CPRPRI
        #--- ce dernier est libellé dans la devise du document de livraison
        #--- Hors ligne liée à un composant kit/sous-traité ou nomenclature
        If find([F:SDD]LINTYP,3,4,5,7,8,9,11,12,13)=0
          If [F:SDH]STOFCY<>""
            #--- Il faut tenir compte du paramétrage "Valeur stock" du paramétrage des flux
            Raz WTROUVE
            Raz WVALSTO
            #WMVT=3        :# 3 - Livraison de prêt
            Read [FCY]FCY0=[F:SDH]STOFCY
            If fstat : Raz [F:FCY] : Endif
            Call FLUX_REGNAT(3,[F:SDH]STOFCY,[F:FCY]CRY,GBIDC2,GBIDC3,WVALSTO,WTROUVE)  From FUNDEBA
            If WTROUVE=1 and WVALSTO=2
              #le prix de revient de la ligne de livraison est pour 1 UV
              #il faut transformer l'UV en US et prendre celui ci pour les quantités en US de retour
              If [F:SDD]QTYSTU<>0
                W_MTTHTLIN = (([F:SDD]CPRPRI*[F:SDD]QTY)/[F:SDD]QTYSTU)*[F:SRD]QTYSTU
              Endif
            Else
              #--- Sinon, il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes et/ou Natures
              Raz JL0,JL1
              #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
              #JL0=find([F:SDH]EECSCH,REG_CODE)
              #JL1=find([F:SDRH]EECNAT,NAT_CODE)
              #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
              Call LEC_TSC_LEG(GCURLEG,[F:SDH]EECSCH,JL0) From TRTLECLEG
              If JL0>0 : Raz [F:TSC] : Endif
              # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
              If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
                Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
              Endif
              # End issue X3-131291
              Call LEC_TEC_LEG(GCURLEG,[F:SDH]EECNAT,JL1) From TRTLECLEG
              If JL1>0 : Raz [F:TEC] : Endif
              # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
              If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
                Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
              Endif
              # End issue X3-131291
              If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
              #--/
                #le prix de revient de la ligne de livraison est pour 1 UV
                #il faut transformer l'UV en US et prendre celui ci pour les quantités en US de retour
                If [F:SDD]QTYSTU<>0
                  W_MTTHTLIN = (([F:SDD]CPRPRI*[F:SDD]QTY)/[F:SDD]QTYSTU)*[F:SRD]QTYSTU
                Endif
              Endif
            Endif
          Endif
        Endif
      Endif
      #--- si la devise de la livraison est différente de la devise de déclaration, il faut convertir le mtt
      If W_MTTHTLIN >0
        If [F:SDH]CUR<> "" and [F:SDH]CUR <> WCUR
          WFISAMT=W_MTTHTLIN
          Raz STAT
          Call CONVERT([F:SDH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SDH]DLVDAT,WFISAMT,W_MTTHTLIN,STAT) From TRTDEV
          If STAT
            Raz STAT
            Call CONVERT([F:SDH]CUR,WCUR,WCUR,[F:SDH]CHGTYP,[F:SDH]DLVDAT,WFISAMT,W_MTTHTLIN,STAT) From TRTDEV
            If STAT
              WOKLIG=0 :# Il n'y a pas de cours de change pour la pièce, donc le détail ne sera pas traité
              Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(71,199,1),1) From GESECRAN
              Return
            Endif
          Endif
        Endif
      Endif
    Endif
  Endif

  [M:DEBG]FISAMT  (nolign-1) = W_MTTHTLIN
  #--- Prise en compte du coefficient de majoration CEE, le cas échéant
  [M:DEBG]STAAMT  (nolign-1) = W_MTTHTLIN
  If [F:BPD]BPCNUM = [F:SRH]BPCORD and [F:BPD]BPAADD = [F:SRH]BPAADD
   If [F:BPD]EECINCRAT <> 0
    [M:DEBG]STAAMT  (nolign-1) = [M:DEBG]STAAMT  (nolign-1)*[F:BPD]EECINCRAT
   Endif
  Else
    Read [BPD]BPD0=[F:SRH]BPCORD;[F:SRH]BPAADD
    If fstat : Raz [F:BPD] : Endif
    If [F:BPD]EECINCRAT <> 0
      [M:DEBG]STAAMT  (nolign-1) = [M:DEBG]STAAMT  (nolign-1)*[F:BPD]EECINCRAT
    Endif
  Endif
  #--- Attention à la prise en compte des éléments de facturation dans les retours
  #--- il faudra proratiser par rapport au produit de la quantité et du prix de la ligne
  #--- par rapport au mtt total de la pièce (voir calcul dans les livraisons et/ou facturations)
  #--- Modification à prévoir lors d'une version ultérieure
  #----------------------------------------------------------------------------------------------
  #DM 53877
  #Il faut prendre en compte les éléments de facturation de la ligne de livraison
  #(les éléments répartis sur les lignes)
  #--- Prise en compte des éléments de facturation répartis sur la ligne
  If [F:SRD]SDHNUM <> "" and [F:SDD]SDHNUM=[F:SRD]SDHNUM and [F:SDD]SDDLIN=[F:SRD]SDDLIN

    #--- la ligne de livraison à été lue avant lors de la recherche du pays d'origine
    Read [SDH]SDH0=[F:SRD]SDHNUM
    If fstat : Raz [F:SDH] : Endif
    WPIECE = "SDD"
    Gosub VEN_TOTDISCRG
    WDISCRGAMT  =WTOTDISCRG
    WDISCRGAMTVS=WTOTDISCRGVS

    Raz WPIECE
    #--- si la devise de la livraison est différente de la devise de déclaration, il faut convertir le mtt
    If WTOTDISCRG >0
      If [F:SDH]CUR<> "" and [F:SDH]CUR <> WCUR
        WDISCRGAMT=WTOTDISCRG
        Raz STAT
        Call CONVERT([F:SDH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SDH]DLVDAT,WDISCRGAMT,WTOTDISCRG,STAT) From TRTDEV
        If STAT
          Raz STAT
          Call CONVERT([F:SDH]CUR,WCUR,WCUR,[F:SDH]CHGTYP,[F:SDH]DLVDAT,WDISCRGAMT,WTOTDISCRG,STAT) From TRTDEV
          If STAT
            WOKLIG=0 :# Il n'y a pas de cours de change pour la pièce, donc le détail ne sera pas traité
            Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(71,199,1),1) From GESECRAN
            Return
          Endif
        Endif
      Endif
    Endif
    If WTOTDISCRGVS >0
      If [F:SDH]CUR<> "" and [F:SDH]CUR <> WCUR
        WDISCRGAMTVS=WTOTDISCRGVS
        Raz STAT
        Call CONVERT([F:SDH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SDH]DLVDAT,WDISCRGAMTVS,WTOTDISCRGVS,STAT) From TRTDEV
        If STAT
          Raz STAT
          Call CONVERT([F:SDH]CUR,WCUR,WCUR,[F:SDH]CHGTYP,[F:SDH]DLVDAT,WDISCRGAMTVS,WTOTDISCRGVS,STAT) From TRTDEV
          If STAT
            WOKLIG=0 :# Il n'y a pas de cours de change pour la pièce, donc le détail ne sera pas traité
            Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(71,199,1),1) From GESECRAN
            Return
          Endif
        Endif
      Endif
    Endif
    #Il faut proratiser les éléments obtenus de la livraison, par rapport au quantités du retour
    If [F:SDD]QTYSTU<>0
      [M:DEBG]FISAMT  (nolign-1) +=   WTOTDISCRG*[F:SRD]QTYSTU/[F:SDD]QTYSTU
      [M:DEBG]STAAMT  (nolign-1) += WTOTDISCRGVS*[F:SRD]QTYSTU/[F:SDD]QTYSTU
    Endif
#    #--CPO DM 105661 Ajout de la sous-traitance
#    #--Valorisation des éléments de facturation de pied de la livraison
#    Raz W_MTTHTLIN
#    Raz W_MTTHTLINVS
#    WNUMEROPIECE = [F:SDH]SDHNUM
#    Gosub VEN_TOTDTA From FUNDEB
#    WINVDTAAMT2   = WTOTDTA
#    WINVDTAAMTVS2 = WTOTDTAVS
#    Raz WNUMEROPIECE
#    #--/
#    If [F:SDH]DLVNOT <> 0 and [F:SRD]QTYSTU<>0
#      #--- Il faut proratiser par rapport au [F:SDD]NETPRINOT*[F:SDD]QTY, même si = 0
#      #--- car sinon, si on prend W_MTTHTLIN qui tient compte du CPRPRI,
#      #--- nous risquons d'avoir un total des lignes > au [F:SDH]DLVNOT et un faux prorata !
#      W_MTTHTLIN   += (((WINVDTAAMT2  *([F:SDD]NETPRINOT*[F:SDD]QTY))/[F:SDH]DLVNOT)*[F:SDD]QTYSTU)/[F:SRD]QTYSTU
#      W_MTTHTLINVS += (((WINVDTAAMTVS2*([F:SDD]NETPRINOT*[F:SDD]QTY))/[F:SDH]DLVNOT)*[F:SDD]QTYSTU)/[F:SRD]QTYSTU
#    Endif
#    #Il faut proratiser les éléments obtenus de la livraison, par rapport au quantités du retour
#    If [F:SRD]QTYSTU<>0
#      W_MTTHTLIN   += (WDISCRGAMT  *[F:SDD]QTYSTU)/[F:SRD]QTYSTU
#      W_MTTHTLINVS += (WDISCRGAMTVS*[F:SDD]QTYSTU)/[F:SRD]QTYSTU
#    Endif
#    If W_MTTHTLIN >0
#      If [F:SDH]CUR<> "" and [F:SDH]CUR <> WCUR
#        WTMP_FISAMT=W_MTTHTLIN
#        Raz STAT
#        Call CONVERT([F:SDH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SDH]DLVDAT,WTMP_FISAMT,W_MTTHTLIN,STAT) From TRTDEV
#        If STAT
#          Raz STAT
#          Call CONVERT([F:SDH]CUR,WCUR,WCUR,[F:SDH]CHGTYP,[F:SDH]DLVDAT,WTMP_FISAMT,W_MTTHTLIN,STAT) From TRTDEV
#          If STAT
#            WOKLIG=0 :# Il n'y a pas de cours de change pour la pièce, donc le détail ne sera pas traité
#            Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(71,199,1),1) From GESECRAN
#            Return
#          Endif
#        Endif
#      Endif
#    Endif
#    If W_MTTHTLINVS >0
#      If [F:SDH]CUR<> "" and [F:SDH]CUR <> WCUR
#        WTMP_FISAMTVS=W_MTTHTLINVS
#        Raz STAT
#        Call CONVERT([F:SDH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SDH]DLVDAT,WTMP_FISAMTVS,W_MTTHTLINVS,STAT) From TRTDEV
#        If STAT
#          Raz STAT
#          Call CONVERT([F:SDH]CUR,WCUR,WCUR,[F:SDH]CHGTYP,[F:SDH]DLVDAT,WTMP_FISAMTVS,W_MTTHTLINVS,STAT) From TRTDEV
#          If STAT
#            WOKLIG=0 :# Il n'y a pas de cours de change pour la pièce, donc le détail ne sera pas traité
#            Call ECR_TRACE(mess(735,197,1)-[F:SDH]SDHNUM-mess(71,199,1),1) From GESECRAN
#            Return
#          Endif
#        Endif
#      Endif
#    Endif
#    [M:DEBG]FISAMT  (nolign-1) = W_MTTHTLIN
#    [M:DEBG]STAAMT  (nolign-1) = W_MTTHTLINVS
#    #--- Renseignement des pièces prises en compte lors de la valorisation
#    #--- Variables contenant les pièces prises en compte lors de la valorisation de chaque ligne de détail
#    Raz WNOLINVALO
#    Raz WVCRNUMVALO
#    Raz WVCRLINVALO
#    If nolign > NBLIGNESDET
#      Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
#      Call ECR_TRACE(mess(735,197,1)-[F:SRD]SRHNUM-num$([F:SRD]SRDLIN),1) From GESECRAN
#    Else
#      WINDICE=find([F:SRD]SDHNUM,WVCRNUMVALO(0..14,nolign-1))
#      If WINDICE<=0 or (WINDICE>0 and !find([F:SRD]SDDLIN,WVCRLINVALO(WINDICE-1,nolign-1)))
#        WNOLINVALO += 1
#        If WNOLINVALO > 15 or nolign > NBLIGNESDET :#CPO 75397 100
#          Call ECR_TRACE(mess(736,197,1),1) From GESECRAN  :#Dépassement du nombre de pièces à prendre en compte lors de la valorisation
#          Call ECR_TRACE(mess(735,197,1)-[F:SRD]SRHNUM-num$([F:SRD]SRDLIN),1) From GESECRAN
#        Else
#          WVCRNUMVALO(WNOLINVALO-1,nolign-1)=[F:SRD]SDHNUM
#          WVCRLINVALO(WNOLINVALO-1,nolign-1)=[F:SRD]SDDLIN
#        Endif
#      Endif
#    Endif
    #--/
  Endif
Endif :#--CPO DM 105661 Ajout de la sous-traitance
  #----------------------------------------------------------------------------------------------
[M:DEBG]NIV     (nolign-1) = GNIVEXP
[M:DEBG]NBDEB=nolign

Return
#----------------------------------------------------------------------
$DEBG_DTA_SRH
#--- Enregistrement SIH doit exister
If [F:SIH]NUM <> [F:SID]NUM
  Read [SIH]SIH0=[F:SID]NUM
  If fstat : WPASVALO = 1 : Raz [F:SIH] : Return : Endif
Endif
#--- Uniquement les factures validées
If [F:SIH]STA <> 3 : WPASVALO = 1 : Return : Endif
# Uniquement s'il n'y a pas de lignes supplémentaires
# (il faut laisser la possibilité que l'avoir puisse être pris en compte lors du traitement des factures)
Raz WLINSUP
For [SIDW]SID0 Where NUM = [F:SIH]NUM
  If [F:SIDW]SRHNUM = "" or [F:SIDW]SRHNUM <> [F:SRH]SRHNUM
    WLINSUP = 1 : Break
  Endif
Next
If WLINSUP = 0
  If [M]REG=2
    If ([F:SIH]EECNUMDEB <> 0 & [F:SIH]EECNUMDEB <> [M]EECNUMDEB) : WPASVALO = 1 : Return : Endif
  Else
    If  [F:SIH]EECNUMDEB <> 0 : WPASVALO = 1 : Return : Endif
  Endif
Endif
#--- Enregistrement SIV doit exister
If [F:SIV]NUM <> [F:SID]NUM
  Read [SIV]SIV0=[F:SID]NUM
  If fstat : WPASVALO = 1 : Raz [F:SIV] : Return : Endif
Endif
#--- La pièce doit être un Avoir sur retour
If [F:SIV]INVTYP <> 2 or [F:SIV]SIHORI <> 6 : WPASVALO = 1 : Return : Endif
WFISAMT = [F:SID]AMTNOTLIN
#--- La prise en compte de EECINCRAT est faite ici
WSTAAMT = [F:SID]AMTNOTLIN
#--- Prise en compte du coefficient de majoration CEE, le cas échéant
If [F:BPD]BPCNUM = [F:SIV]BPCORD and [F:BPD]BPAADD = [F:SIV]BPAADD
 If [F:BPD]EECINCRAT <> 0
  WSTAAMT = [F:SID]AMTNOTLIN*[F:BPD]EECINCRAT
 Endif
Else
  Read [BPD]BPD0=[F:SIV]BPCORD;[F:SIV]BPAADD
  If fstat : Raz [F:BPD] : Endif
  If [F:BPD]EECINCRAT <> 0
    WSTAAMT = [F:SID]AMTNOTLIN*[F:BPD]EECINCRAT
  Endif
Endif
If [F:SID]AMTNOTLIN=0
  #--- Si prix net à 0, on prend le PRIORD
  #--- PRIORD - devise de la société => ne nécéssite pas de conversion (extraction DEB par société)
  #--- CONVERSION A FAIRE => au moment ou on valorisera les élements de facturation (qui seront dans la devise du document) !!!
  #--- prix valable pour 1 US => il faut prendre [F:SID]QTYSTU
  #--- Il faut tenir compte du paramétrage "Valeur stock" du paramétrage des flux
  #--- Hors ligne liée à un composant kit/sous-traité ou nomenclature
  If find([F:SID]LINTYP,3,4,5,7,8,9,11,12,13)=0
    #--- On regarde d'abord le flag valeur stock du paramétrage des flux par régimes/natures
    Raz WTROUVE,WVALSTO
    Call FLUX_REGNAT(WMVT,[F:SRH]STOFCY,W_CRYTO,GBIDC2,GBIDC3,WVALSTO,WTROUVE) From FUNDEBA
    If WTROUVE=1 and WVALSTO=2
      WFISAMT = [F:SRD]PRIORD*[F:SID]QTYSTU
    Else
      #--- Il faut tenir compte du paramétrage "Valeur stock" de la table des Régimes
      Raz JL0,JL1
      #--CPO 71937 Déclinaison multi-lég TABEECSCH et TABEECNAT
      #JL0=find([M:DEBG]EECSCH(nolign-1),REG_CODE) :# Pour tenir compte de la modif de Reg/Nat des gratuits
      #JL1=find([M:DEBG]EECNAT(nolign-1),NAT_CODE) :# Pour tenir compte de la modif de Reg/Nat des gratuits
      #If (JL0 and REG_VALSTO(JL0-1)=2) or (JL1 and NAT_VALSTO(JL1-1)=2)
      Call LEC_TSC_LEG(GCURLEG,[M:DEBG]EECSCH(nolign-1),JL0) From TRTLECLEG
      If JL0>0 : Raz [F:TSC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL0=0 and [F:TSC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(909,197,0)-[F:TSC]EECSCH-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      Call LEC_TEC_LEG(GCURLEG,[M:DEBG]EECNAT(nolign-1),JL1) From TRTLECLEG
      If JL1>0 : Raz [F:TEC] : Endif
      # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added ENAFLG=2 test and log warning
      If JL1=0 and [F:TEC]ENAFLG<>[V]CST_AYES
        Call ECR_TRACE(mess(910,197,0)-[F:TEC]EECNAT-':'-mess(2,126,0),-1) From GESECRAN
      Endif
      # End issue X3-131291
      If [F:TSC]VALSTO=2 | [F:TEC]VALSTO=2
      #--/
        WFISAMT = [F:SRD]PRIORD*[F:SID]QTYSTU
      Endif
    Endif
    #Il faut convertir le montant obtenu de la devise de la société en celle de facturation
    #car le priord est libéllé dans la devise de société
    #(à cette valeur on rajoute les éventuels elts de facturation -> en devise facturation)
    If WFISAMT > 0
      If WCUR <> [F:SIH]CUR
        WKMONTANT = WFISAMT
        Raz STAT
        Call CONVERT(WCUR,[F:SIH]CUR,WCUR,GEECTYPCUR,[F:SIH]ACCDAT ,WKMONTANT,WFISAMT,STAT) From TRTDEV
        If STAT
          Raz STAT
          Call CONVERT(WCUR,[F:SIH]CUR,WCUR,[F:SIH]CURTYP,[F:SIH]ACCDAT,WKMONTANT,WFISAMT,STAT) From TRTDEV
          If STAT
            Call ECR_TRACE(mess(735,197,1)-[F:SIH]NUM-mess(71,199,1),1) From GESECRAN
            WPASVALO = 1 : Return
          Endif
        Endif
      Endif
      #--- Prise en compte du coefficient de majoration CEE, le cas échéant
      If [F:BPD]BPCNUM = [F:SIV]BPCORD and [F:BPD]BPAADD = [F:SIV]BPAADD
        If [F:BPD]EECINCRAT <> 0
          WSTAAMT = WFISAMT*[F:BPD]EECINCRAT
        Endif
      Endif
    Endif
  Endif
Endif
# En-tête, nous calculons la somme des éléments de facturation de l'en-tête
#--- Eléments de facturation
# Depuis V6 : les éléments de facturation sont présents sur les pieds des pièces autres que les factures
# Prise en compte des éléments non répartis sur les lignes : INVLINFLG = 1 ou 6,
# a condition qu'ils entrent dans le calcul de la valeur fiscale et/ou valeur statistique : CLCDEB = 2 ou 3
# puis répartition sur les lignes, au prorata des montants de chaque ligne
WNUMEROPIECE = [F:SIV]NUM
W_VCRTYP=4 # Issue 110289 - 2015-08-12 by CPO : Invoicing elements when using same counter on different documents
Gosub VEN_TOTDTA
WFACDTAAMT   = WTOTDTA
WFACDTAAMTVS = WTOTDTAVS
Raz WNUMEROPIECE
Raz W_VCRTYP # Issue 110289 - 2015-08-12 by CPO
# Nous devons calculer la somme des montants HT des détails d'une pièce
# car le total ne doit pas contenir d'éléments de facturation
# AMTNOT : contient ces éléments, donc il ne pourra pas être utilisé pour la proratisation
#--- Nouveaux buffers
Raz WTOTAMTNOT
#--- Somme montants HT détails
For [SIDW]SID0 Where NUM=[F:SID]NUM
  WTOTAMTNOT += [F:SIDW]AMTNOTLIN
Next
W_NUM = [F:SID]NUM
#--CPO DM 105661 Ajout de la sous-traitance
If WMVT=24
  Gosub DEBG_DTA_SRH_SST From FUNDEBB
Else
#--/
  #--- Nous traitons la ligne de détail facture liée au détail de réception
  #--- Calcul de la somme des éléments de facturation répartis sur les lignes
  # Attention :
  # Les éléments peuvent rentrer différement dans le calcul de la valeur fiscale et/ou de la valeur statistique
  WPIECE= "SID"
  Gosub VEN_TOTDISCRG
  WFACDISCRG   = WTOTDISCRG
  WFACDISCRGVS = WTOTDISCRGVS
  Raz WPIECE
  # Si le total des lignes ne permet pas de proratiser,
  # il faut prendre en compte les éléments déjà éclatés sur les lignes
  If WTOTAMTNOT <> 0
    WFISAMT += ((WFACDTAAMT*[F:SID]AMTNOTLIN)/WTOTAMTNOT) + WFACDISCRG
    WSTAAMT += ((WFACDTAAMTVS*[F:SID]AMTNOTLIN)/WTOTAMTNOT) + WFACDISCRGVS
  Else
    WFISAMT += WFACDISCRG
    WSTAAMT += WFACDISCRGVS
  Endif
  #--- Conversion de la valeur fiscale, le cas échéant
  If [F:SIH]CUR <> WCUR
    WMONTANT = WFISAMT
    Raz STAT
    Call CONVERT([F:SIH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SIH]ACCDAT,WMONTANT,WFISAMT,STAT) From TRTDEV
    If STAT
      Raz STAT
      Call CONVERT([F:SIH]CUR,WCUR,WCUR,[F:SIH]CURTYP,[F:SIH]ACCDAT,WMONTANT,WFISAMT,STAT) From TRTDEV
      If STAT
        Call ECR_TRACE(mess(742,197,1)-[F:SIH]NUM-mess(71,199,1),1) From GESECRAN
        WPASVALO = 1 : Return
      Endif
    Endif
  Endif
  #--- Conversion de la valeur statistique, le cas échéant
  If [F:SIH]CUR <> WCUR
    WMONTANT = WSTAAMT
    Raz STAT
    Call CONVERT([F:SIH]CUR,WCUR,WCUR,GEECTYPCUR,[F:SIH]ACCDAT,WMONTANT,WSTAAMT,STAT) From TRTDEV
    If STAT
      Raz STAT
      Call CONVERT([F:SIH]CUR,WCUR,WCUR,[F:SIH]CURTYP,[F:SIH]ACCDAT,WMONTANT,WSTAAMT,STAT) From TRTDEV
      If STAT
        Call ECR_TRACE(mess(742,197,1)-[F:SIH]NUM-mess(71,199,1),1) From GESECRAN
        WPASVALO = 1 : Return
      Endif
    Endif
  Endif
  WFISAMTDTA += WFISAMT : Raz WFISAMT
  WSTAAMTDTA += WSTAAMT : Raz WSTAAMT
Endif #--CPO DM 105661 Ajout de la sous-traitance

Return
#######################################################################
# Ventes : Factures clients
#          ( factures, avoirs )
#----------------------------------------------------------------------
$EEC_SIH
#--Nombre instructions trop important
Gosub EEC_SIH From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$EEC_UN_SIH
#--Nombre instructions trop important
Gosub EEC_UN_SIH From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$EEC_UN_SIH_FAC
#--- Traitement des Factures

#--Nombre instructions trop important
Gosub EEC_UN_SIH_FAC From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$EEC_UN_SIH_AVR
#--- Traitement des Avoirs

#--Nombre instructions trop important
Gosub EEC_UN_SIH_AVR From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_FAC_DIR
#--- Chargement du masque avec les éléments de la ligne de Facture avec Origine Directe

#--Nombre instructions trop important
Gosub DEBG_SIH_FAC_DIR From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_FAC_CDE
#--- Chargement du masque avec les éléments de la ligne de Facture avec Origine Commande

#--Nombre instructions trop important
Gosub DEBG_SIH_FAC_CDE From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_FAC_LIV
#---Chargement du masque avec les éléments de la ligne de Facture avec Origine Livraison
#--- Chargement du masque avec les éléments de la ligne de Facture

#--Nombre instructions trop important
Gosub DEBG_SIH_FAC_LIV From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_FAC
#--- Chargement du masque avec les éléments de la ligne de Facture

#--Nombre instructions trop important
Gosub DEBG_SIH_FAC From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_AVR_DIR
#--- Avoirs origine directe
# Chargement du masque avec les éléments de la ligne d'Avoir avec Origine Directe

#--Nombre instructions trop important
Gosub DEBG_SIH_AVR_DIR From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_AVR_FAC
#--- Avoirs origine facture
# Attention : les factures peuvent avoir des origines différentes
# Directe, Livraison, Commande, Contrat, Demande de services, Transfert
# Pour chaque origine de la facture il faut faire attention aux lignes supplémentaires
# Toutes ne rentrent pas dans la DEB

#--Nombre instructions trop important
Gosub DEBG_SIH_AVR_FAC From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_AVR_RET
#--- Avoirs origine retour
# Chargement du masque avec les éléments de la ligne d'Avoir avec Origine Directe

#--Nombre instructions trop important
Gosub DEBG_SIH_AVR_RET From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_AVRREG
#--- Flux financier associé à la ligne d'Avoir
#--- Flux : EXPEDITION

#--Nombre instructions trop important
Gosub DEBG_SIH_AVRREG From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$DEBG_SIH_AVRPHY
#--- Flux physique associé à la ligne d'Avoir
#--- Flux : INTRODUCTION

#--Nombre instructions trop important
Gosub DEBG_SIH_AVRPHY From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
########################################################################
$VEN_TOTDTA
#--Nombre instructions trop important
Gosub VEN_TOTDTA From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#----------------------------------------------------------------------
$VEN_TOTDISCRG
#--Nombre instructions trop important
Gosub VEN_TOTDISCRG From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
#######################################################################
$CTL_EEC
WOK=1
#--- Le point d'entrée utilisera
#--- le WUPDTYP (comme dans les versions antérieures)
#--- et WUPDFIL (qui donnera l'abréviationde la pièce traitée)
#--- Si GPE=1 en retour : la pièce n'est pas prise en compte
Local Integer SAUVGPE     : SAUVGPE=GPE : GPE=0
GPOINT="DEBCTL" : Gosub ENTREE From EXEFNC
If GPE : GPE=SAUVGPE : WOK=0 : Return : Endif

Raz W_CRYFROM, W_CRYTO, W_DATE, W_FFWNUM, W_FFWADD
Case WUPDFIL
  When "PTH"    Gosub CTL_EEC_PTH From FUNDEBA :#--CPO Lors de la correction 75397 Ttt trop long !
  When "PNH"    Gosub CTL_EEC_PNH From FUNDEBA :#--CPO Lors de la correction 75397 Ttt trop long !
  When "PIH"    Gosub CTL_EEC_PIH From FUNDEBA :#--CPO Lors de la correction 75397 Ttt trop long !
  When "SDH"    Gosub CTL_EEC_SDH From FUNDEBA :#--CPO Lors de la correction 75397 Ttt trop long !
  When "SRH"    Gosub CTL_EEC_SRH From FUNDEBA :#--CPO Lors de la correction 75397 Ttt trop long !
  When "SIH"    Gosub CTL_EEC_SIH From FUNDEBA :#--CPO Lors de la correction 75397 Ttt trop long !
Endcase

Return
#------------------CPO Lors de la correction 75397 Ttt FUNDEB trop long !-------------------------------
# ... deleted commented lines (CPO 05/07/2019)
#------------------FIN CPO Lors de la correction 75397 Ttt trop long !-------------------------------
#######################################################################
#######################################################################
$EEC_DEBGEN
#--Nombre instructions trop important
Gosub EEC_DEBGEN From FUNDEBA :#--CPO DM 105661 Ajout de la sous-traitance

Return
# ... deleted commented lines (CPO 05/07/2019)
#######################################################################
$REC_EECNUMDEB
#--- Nouveau: en generation un seul type de flux (introduction + expedition)
#                 no. commun delivre lors de introduction
#             l'étiquette sera appelée une seule fois depuis $EXEC
#---
Call DEBTRANS From GLOCK
$DEBUT_DEP
GOK=1
Trbegin [DER]
# Récupération d'un no de traitement
Readlock [DER]DER0 Last
If fstat=1
  GOK=-1 : GLOCK="$DEBPAR"
  Goto ROL_DEP
Elsif fstat>=4
  [F:DER]EECNUMDEB=0
Elsif fstat
  GOK=0 : Call FSTA("DER") From GLOCK
  Goto AB_DEP
Endif
[F:DER]EECNUMDEB+=1 : [M]EECNUMDEB=[F:DER]EECNUMDEB
[F:DER]CPY   =[M]CPY
[F:DER]FLO   =[M]FLO     : # stockage du type de flux saisi ( 1/2/3 )
[F:DER]DEBDAT=[M]DEBDAT
[F:DER]CUR   =WCUR
Write [DER]
If fstat
  GOK=0 : Call RSTA("DER",num$([F:DER]EECNUMDEB)) From GLOCK
  Goto AB_DEP
Endif
Commit

Return
#######################################################################
$ROL_DEP
Rollback
Call ROLL From GLOCK
If GROLL
  Call ECR_TRACE(mess(17,107,1),1) From GESECRAN
  Return
Else
  Goto DEBUT_DEP
Endif

Return
#######################################################################
$AB_DEP
Rollback
Call ECR_TRACE(mess(17,107,1),1) From GESECRAN

Return
#########################################################################
$ALIFILSUP
#-----------------------------------------------------------------------#
# Point d'entree ajout filtres supplémentaires                          #
#-----------------------------------------------------------------------#
Local Char FILSUP (250)

FILSUP="1=1"
GPOINT="DEBFIL" : Gosub ENTREE From EXEFNC

Return
#########################################################################
$AB_DEB
Rollback
If WTRNOK
  Call ECR_TRACE(mess(17,107,1),1) From GESECRAN
Endif
#--- Retrouver les bons numéros en cas de rollback
If WOLDLININT <> WNOLININT
  WNOLININT = WOLDLININT
Endif
If WOLDLINEXP <> WNOLINEXP
  WNOLINEXP = WOLDLINEXP
Endif

Return
#######################################################################
#--- Chargement Table pays
$LEC_TCY
If [F:TCY]CRY<>LCRY & vireblc(LCRY,2)<>""
  Read [TCY]TCY0=LCRY
  If fstat Raz [F:TCY] Endif
Endif

Return
#########################################################################
#    GACTION : Actions de sélection                                     #
#########################################################################
$SEL_TABLE
Case TABLE
  When "SDEP"      : Gosub S_SDEP
Endcase

Return
#-----------------------------------------------------------------------
$VERF_TABLE
Case TABLE
  When "SDEP"      : Gosub V_SDEP
Endcase

Return
#-----------------------------------------------------------------------
#--- Sélection paramètres DEB si regénération
$S_SDEP
If clalev([F:ATZ])=0  : Local File ATABZON : Endif
Local Char CODFIC(15) : CODFIC = "DEBPAR"

Default File [DER]
SENS   = 2
TIT(0) = mess(12,123,1)
NBCOL = 0
NBCOL += 1 : COL(NBCOL) = "EECNUMDEB" : Gosub TEXTE
NBCOL += 1 : COL(NBCOL) = "CPY"       : Gosub TEXTE
NBCOL += 1 : COL(NBCOL) = "DEBDAT"    : Gosub TEXTE

Return
#----------------------------------------------------------------------
$TEXTE
Call TEXTFIC(CODFIC, COL(NBCOL), 1, TIT(NBCOL)) From OBJDIV
Return
#----------------------------------------------------------------------
#--- Vérification sélection paramètres DEB si regénération
$V_SDEP

Return
#######################################################################
$ERRBATCH
Call ECR_TRACE(errmes$(errn)-num$(errl)-errm,1) From GESECRAN
End
#######################################################################
#    Détail des actions liées aux champs de l'écran  DDEB             #
#    (Génération du fichier DEB)                                      #
#######################################################################
Subprog AP_REG(VALEUR)
Variable Integer VALEUR
If VALEUR=2
   [M]RAZDEB=2 :# 1 - modifié car si on regénère, il reprend en compte les lignes déjà déclarées et il essaie de les remettre dans le fichier
   Raz   [M]CPY,[M]DEBDAT
   Actzo [M]EECNUMDEB
   Grizo [M]CPY,DEBDAT,RAZDEB
Else
   [M]RAZDEB=1 :# 2 - modifié car en génération il effacait toutes les lignes de la table DEB. Le choix appartient à l'user.
   Raz   [M]EECNUMDEB
   Grizo [M]EECNUMDEB
   Actzo [M]CPY,DEBDAT,RAZDEB
Endif
Affzo [M]EECNUMDEB,CPY,DEBDAT,RAZDEB

End
########################################
Subprog C_EECNUMDEB(VALEUR)
Variable Decimal VALEUR
Read [DER]DER0=VALEUR
If fstat mkstat=2  : End : Endif
If clalev([F:CPY])=0 : Local File COMPANY  [CPY] : Endif
Call LECTURE("CPY",[F:DER]CPY,"") From CONTOBJ

End
########################################
Subprog AM_EECNUMDEB(VALEUR)
Variable Decimal VALEUR
[M]CPY    = [F:DER]CPY
Call AP_CPY([F:DER]CPY)
[M]DEBDAT = [F:DER]DEBDAT
[M]CUR    = [F:DER]CUR
Affzo [M]CPY,DEBDAT

End
########################################
Subprog C_CPY(VALEUR)
Variable Char    VALEUR()
Local Integer OK
If VALEUR=""      mkstat=2 Endif
If GUSRFCY(1)="\" End      Endif
If clalev([F:FGR])=0 : Local File FACGROUP [FGR] : Endif
If clalev([F:CPY])=0 : Local File COMPANY  [CPY] : Endif
OK = 1
Call LECTURE("CPY",VALEUR,"") From CONTOBJ
If [F:CPY]CPYLEGFLG=2  : # Société juridique
 For I=1 To GNBSITE
  If VALEUR=GSOCSITE(I) & !find(GSITE(I),GUSRFCY(1..GNBAUZ))
   OK = 0 : Break
  Endif
 Next I
Else
 For [FGR]FGR0 Where CPY=VALEUR
  If !find([F:FGR]FCY,GUSRFCY(1..GNBAUZ))
   OK = 0 : Break
  Endif
 Next
Endif
If !OK
 GMESSAGE = mess(32,104,1)-VALEUR : # Tous les sites de la société ne sont pas accessibles
 mkstat=2 : End
Endif

End
########################################
Subprog AM_CPY(VALEUR)
Variable Char VALEUR
[M]CUR = [F:CPY]ACCCUR

End
########################################
Subprog AP_CPY(VALEUR)
Variable Char    VALEUR()
#--CPO 90312 GVARCTLPRG non existant en batch => déplacé en $INIT
#Global Char GVARCTLPRG (15) : GVARCTLPRG="CONTNUM"
#--/
#  recherche du traitement de localisation des arrondis
Read [TCY]TCY0 = [F:CPY]CRY
If fstat : Raz [F:TCY] : End : Endif
If [F:TCY]CTLPRG<>""
  Local Integer OK
  Call EXISTE_ADX("","",[F:TCY]CTLPRG,OK) From ORDSYS
  If OK
    GVARCTLPRG=[F:TCY]CTLPRG
  Endif
Endif

End
########################################
Subprog D_DEBDAT(VALEUR)
Variable Date    VALEUR
#--- Initialisation de la date à date fin de mois précédent
VALEUR=eomonth(addmonth(date$,-1))

End
########################################
Subprog C_DEBDAT(VALEUR)
Variable Date    VALEUR
#------Modification suite demande produit
#--- La date doit être antérieure à la date du jour
#If VALEUR > date$
   #mkstat = 2 : GERR = 1 : GMESSAGE = mess(177,196,1) : End
#Endif
#--- Ce n'est pas une date de fin de mois
If VALEUR <> eomonth(VALEUR)
   GERR = 2 : GMESSAGE = mess(181,196,1) :# End
   #Information : "La date est postérieure à la Date du jour"
   If VALEUR > date$
    GMESSAGE += "\"+mess(949,196,1)
   Endif
Endif
End
######################################################################################
## Etiquette ajoutée par le superviseur (écran DEBGEN) 21/11/2008 15:04:01 (CPO)
######################################################################################
Subprog IB_EECSCH
End
######################################################################################
#--CPO 74679 Amélioration de la trace
$MESS_TRACE
Case WMESS_CODE
  When 1        :   #--  "Pays xxxx, code pays DEB non renseigné dans la fiche pays.
                    #--   Des flux risquent de ne pas être extraits."
                    WMESS_TRACE-=mess(784,197,1)-mess(785,197,1)
  When 2        :   #--  "Prise en compte du paramètre permettant de retarder la déclaration des
                    #--   documents facturables mais non facturés"
                    WMESS_TRACE-=mess(786,197,1)
  When 3        :   #--- "Article non coché "Soumis à la DEB", la ligne de détail n'est pas extraite."
                    #--CPO 94167 Option pour l'affichage de ce message
                    #WMESS_TRACE-="-"-mess(787,197,1)
                    If [M]PRITMNOTDEB=2
                      WMESS_TRACE-="-"-mess(787,197,1)
                    Else
                      Raz WMESS_TRACE
                      Raz WMESS_CODE
                      Return
                    Endif
                    #--/
  When 4        :   #--- "Ligne de type autre que "Nomenclature composé" ou "Standard", elle ne sera pas extraite."
                    WMESS_TRACE-=mess(788,197,1)
  When 5        :   #--  "La table d'affectation des régimes et nature par flux n'est pas alimentée
                    #--   pour le pays d'extraction ou pour tous les pays en général."
                    WMESS_TRACE-=mess(789,197,1)
  When 6        :   #--  "Il existe des codes régimes utilisés dans la table d'affectation par flux de ces derniers
                    #--   qui ne figurent pas dans la table des régimes."
                    WMESS_TRACE-=mess(790,197,1)+"\"+mess(908,197,0) # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added mess(908,197,0)
  When 7        :   #--  "Il existe des codes natures utilisés dans la table d'affectation par flux de ces derniers
                    #--   qui ne figurent pas dans la table des natures."
                    WMESS_TRACE-=mess(791,197,1)+"\"+mess(908,197,0) # Issue X3-131291 - 2019-05-09 by CPO : ENAFLG on TSC/TEC -> added mess(908,197,0)
  When 8        :   #--CPO 94689 Intrastat for Customer returns with nil quantity
                    #--"Quantité retournée = 0, la ligne n'est pas extraite."
                    WMESS_TRACE-=mess(95,191,1)-"=0,"-mess(744,197,1)-mess(745,197,1)+"."
  When 9        :   #--CPO 94689 Intrastat for Customer returns with nil quantity
                    #--"ligne extraite mais Qté retournée < Qté prévue"
                    WMESS_TRACE-=mess(807,197,1)-mess(277,197,1)-"<"-mess(68,2281,1)
  When Default  :
Endcase

Call ECR_TRACE(WMESS_TRACE,-1) From GESECRAN
Raz WMESS_TRACE
Raz WMESS_CODE

Return
